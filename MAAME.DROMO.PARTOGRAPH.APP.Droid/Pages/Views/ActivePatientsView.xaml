<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="MAAME.DROMO.PARTOGRAPH.APP.Droid.Pages.Views.ActivePatientsView"
             xmlns:f="clr-namespace:Fonts"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:models="clr-namespace:MAAME.DROMO.PARTOGRAPH.MODEL;assembly=MAAME.DROMO.PARTOGRAPH.MODEL"
             xmlns:pagemodels="clr-namespace:MAAME.DROMO.PARTOGRAPH.APP.Droid.PageModels"
             xmlns:popup="clr-namespace:Syncfusion.Maui.Popup;assembly=Syncfusion.Maui.Popup"
             xmlns:fonts="clr-namespace:Fonts"
             x:Name="PatientsView">

    <Grid RowDefinitions="Auto,*" Padding="16">

        <!-- Search Bar -->
        <Border Grid.Row="0"
                StrokeThickness="0"
                BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2A2A2A}"
                Margin="0,0,0,16">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="12" />
            </Border.StrokeShape>
            <SearchBar Placeholder="Search by name or hospital number..."
                       Text="{Binding SearchText}"
                       BackgroundColor="Transparent"
                       PlaceholderColor="{AppThemeBinding Light=#999, Dark=#666}" />
        </Border>

        <!-- Patients List -->
        <RefreshView Grid.Row="1"
                     IsRefreshing="{Binding IsRefreshing}"
                     Command="{Binding RefreshCommand}">
            <CollectionView ItemsSource="{Binding Partographs}"
                            ItemsLayout="VerticalList"
                            SelectionMode="None"
                            x:Name="PatientCollectionView">
                <CollectionView.EmptyView>
                    <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="16" Padding="40">
                        <Label Text="&#xE8B6;"
                               FontFamily="{x:Static fonts:FluentUI.FontFamily}"
                               FontSize="72"
                               TextColor="{AppThemeBinding Light=#DDD, Dark=#555}"
                               HorizontalOptions="Center" />
                        <Label Text="No Active Labour Cases"
                               FontSize="20"
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light=#888, Dark=#999}"
                               HorizontalOptions="Center" />
                        <Label Text="Patients in active labour will appear here"
                               FontSize="14"
                               TextColor="{AppThemeBinding Light=#AAA, Dark=#777}"
                               HorizontalOptions="Center" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Partograph">
                        <Border StrokeThickness="0"
                                BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                                Margin="0,0,0,12"
                                Padding="0">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="16" />
                            </Border.StrokeShape>
                            <Border.Shadow>
                                <Shadow Brush="{AppThemeBinding Light=#40000000, Dark=#80000000}"
                                        Offset="0,2"
                                        Radius="8"
                                        Opacity="0.15" />
                            </Border.Shadow>

                            <Grid RowDefinitions="Auto,Auto,Auto,10,Auto" Padding="16">

                                <!-- Header Row: Patient Info & Status -->
                                <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto,Auto,Auto" ColumnSpacing="12">
                                    <!-- Cervical Dilatation Display -->
                                    <Border Grid.Column="0"
                                            WidthRequest="56"
                                            HeightRequest="56"
                                            BackgroundColor="#FF9800"
                                            StrokeThickness="3"
                                            Stroke="#FFF3E0">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="28" />
                                        </Border.StrokeShape>
                                        <Grid ColumnDefinitions="Auto,Auto" VerticalOptions="Center" HorizontalOptions="Center" Margin="-10">
                                            <Label Text="{Binding CurrentDilatation, StringFormat='{0}'}"
                                                   FontSize="22"
                                                   FontAttributes="Bold"
                                                   TextColor="White"
                                                   HorizontalOptions="End"  
                                                   VerticalOptions="End"
                                                   Grid.Column="0"/>
                                            <Label Text="cm"
                                                   FontSize="10"
                                                   TextColor="White"
                                                   Opacity="0.9"
                                                   HorizontalOptions="End" 
                                                   VerticalOptions="End"
                                                   Margin="0,0,0,3"
                                                   Grid.Column="1" />
                                        </Grid>
                                    </Border>

                                    <Border Grid.Row="1" Grid.Column="0" Grid.RowSpan="3"
        WidthRequest="56"
        HeightRequest="56"
        BackgroundColor="#FF9800"
        StrokeThickness="3"
        Stroke="#FFF3E0" IsVisible="{Binding CurrentHeadDescent, Converter={StaticResource IsNotNullConverter}}">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="28" />
                                        </Border.StrokeShape>
                                        <Grid ColumnDefinitions="Auto,Auto" VerticalOptions="Center" HorizontalOptions="Center" Margin="-10">
                                            <Label Text="{Binding CurrentHeadDescent, StringFormat='{0}'}"
               FontSize="22"
               FontAttributes="Bold"
               TextColor="White"
               HorizontalOptions="End"  
               VerticalOptions="End"
               Grid.Column="0"/>
                                        </Grid>
                                    </Border>
                                    <!--<Border Grid.Column="0"
                                            WidthRequest="56"
                                            HeightRequest="56"
                                            BackgroundColor="{Binding StatusColor}">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="28" />
                                        </Border.StrokeShape>
                                        <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="0">
                                            <Label Text="{Binding CervicalDilationOnAdmission, StringFormat='{0}'}"
                                                   FontSize="22"
                                                   FontAttributes="Bold"
                                                   TextColor="White"
                                                   HorizontalOptions="Center" />
                                            <Label Text="cm"
                                                   FontSize="10"
                                                   TextColor="White"
                                                   Opacity="0.9"
                                                   HorizontalOptions="Center"
                                                   Margin="0,-2,0,0" />
                                        </VerticalStackLayout>
                                    </Border>-->

                                    <!-- Patient Name & Details -->
                                    <VerticalStackLayout Grid.Column="1" Spacing="4" VerticalOptions="Center">
                                        <Label Text="{Binding Name}"
                                               FontAttributes="Bold"
                                               FontSize="18"
                                               LineBreakMode="TailTruncation" />
                                        <Label Text="{Binding HospitalNumber}"
                                               FontSize="13"
                                               TextColor="{AppThemeBinding Light=#888, Dark=#AAA}"
                                               FontFamily="monospace" />
                                    </VerticalStackLayout>

                                    <Label Text="{Binding StatusDisplay, Mode=OneWay}" Grid.Column="2"
                                           TextColor="{Binding StatusColorString, Mode=OneWay}"
                                           FontSize="14"
                                           LineBreakMode="TailTruncation" HorizontalOptions="End" />
                                    <!-- Status Badge -->
                                    <!--<Border Grid.Column="2"
                                            BackgroundColor="{Binding StatusColor}"
                                            Padding="10,5"
                                            VerticalOptions="Start">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="8" />
                                        </Border.StrokeShape>
                                        <Label Text="{Binding StatusDisplay}"
                                               FontSize="11"
                                               FontAttributes="Bold" />
                                    </Border>-->
                                    
                                    <Label Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Text="{Binding DisplayInfo}"  FontSize="12" TextColor="{AppThemeBinding Light=#555, Dark=#BBB}" />

                                    <HorizontalStackLayout Grid.Row="2" Grid.Column="1" Grid.ColumnSpan="2" Spacing="12">
                                        <Label Text="{Binding LaborStartTime, StringFormat='{0:dddd, dd MMM, HH:mm}'}" FontSize="12" TextColor="{AppThemeBinding Light=#888, Dark=#999}" />
                                        <!--<Border BackgroundColor="{AppThemeBinding Light=#E8F5E9, Dark=#1B5E20}"
                                                Padding="6,2"
                                                HorizontalOptions="Start"
                                                VerticalOptions="Center"
                                                IsVisible="{Binding CurrentHeadDescent, Converter={StaticResource IsNotNullConverter}}">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="4" />
                                            </Border.StrokeShape>
                                            <Label Text="{Binding CurrentHeadDescent, StringFormat='Station {0}'}"
                                                   FontSize="11"
                                                   FontAttributes="Bold"
                                                   TextColor="{AppThemeBinding Light=#2E7D32, Dark=#81C784}" />
                                        </Border>-->
                                    </HorizontalStackLayout>
                                    <Label Grid.Row="3" Grid.Column="1" Grid.ColumnSpan="2" Text="{Binding LaborStartTimeFormat}" FontSize="12" TextColor="{AppThemeBinding Light=#1976D2, Dark=#64B5F6}" />
                                </Grid>

                                <!-- Patient Demographics -->
                                <!--<HorizontalStackLayout Grid.Row="1" Spacing="16" Margin="0,12,0,0">
                                    <Border BackgroundColor="{AppThemeBinding Light=#F8F9FA, Dark=#252525}"
                                            Padding="10,6"
                                            HorizontalOptions="Start">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="6" />
                                        </Border.StrokeShape>
                                        <Label Text="{Binding DisplayInfo}"
                                               FontSize="12" TextColor="{AppThemeBinding Light=#555, Dark=#BBB}" />
                                    </Border>
                                </HorizontalStackLayout>-->

                                <!-- Labor Progress Indicators -->
                                <!--<Grid Grid.Row="2" ColumnDefinitions="*,*" ColumnSpacing="12" Margin="0,12,0,12">-->
                                    <!-- Labor Duration -->
                                    <!--<Border Grid.Column="0"
                                            BackgroundColor="{AppThemeBinding Light=#E3F2FD, Dark=#1A237E}"
                                            Padding="12,10">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="10" />
                                        </Border.StrokeShape>
                                        <VerticalStackLayout Spacing="4">
                                            <HorizontalStackLayout Spacing="6">
                                                <Label Text="&#xE917;"
                                                       FontFamily="{x:Static fonts:FluentUI.FontFamily}"
                                                       FontSize="14"
                                                       TextColor="#2196F3"
                                                       VerticalOptions="Center" />
                                                <Label Text="Labour Duration"
                                                       FontSize="11"
                                                       TextColor="{AppThemeBinding Light=#666, Dark=#AAA}"
                                                       VerticalOptions="Center" />
                                            </HorizontalStackLayout>
                                            <Label Text="{Binding LaborStartTime, StringFormat='{0:dddd, dd MMM, HH:mm}'}"
                                                   FontSize="12"
                                                   TextColor="{AppThemeBinding Light=#888, Dark=#999}"
                                                   Margin="22,0,0,0" />
                                            <Label Text="{Binding LaborStartTimeFormat}"
                                                   FontSize="12"
                                                   TextColor="{AppThemeBinding Light=#1976D2, Dark=#64B5F6}"
                                                   Margin="22,0,0,0" />
                                        </VerticalStackLayout>
                                    </Border>-->

                                    <!-- Membrane Status -->
                                    <!--<Border Grid.Column="1"
                                            BackgroundColor="{AppThemeBinding Light=#FFF3E0, Dark=#E65100}"
                                            Padding="12,10">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="10" />
                                        </Border.StrokeShape>
                                        <VerticalStackLayout Spacing="4">
                                            <HorizontalStackLayout Spacing="6">
                                                <Label Text="&#xE9EA;"
                                                       FontFamily="{x:Static fonts:FluentUI.FontFamily}"
                                                       FontSize="14"
                                                       TextColor="#FF9800"
                                                       VerticalOptions="Center" />
                                                <Label Text="Membrane"
                                                       FontSize="11"
                                                       TextColor="{AppThemeBinding Light=#666, Dark=#AAA}"
                                                       VerticalOptions="Center" />
                                            </HorizontalStackLayout>
                                            <Label Text="{Binding MembraneStatus}"
                                                   FontSize="12"
                                                   FontAttributes="Bold"
                                                   TextColor="{AppThemeBinding Light=#F57C00, Dark=#FFB74D}"
                                                   Margin="22,0,0,0" />
                                            <Label Text="{Binding RupturedMembraneTimeFormat, StringFormat='Ruptured: {0}'}"
                                                   FontSize="12"
                                                   TextColor="{AppThemeBinding Light=#888, Dark=#999}"
                                                   Margin="22,0,0,0"
                                                   IsVisible="{Binding RupturedMembraneTime, Converter={StaticResource IsNotNullConverter}}" />
                                        </VerticalStackLayout>
                                    </Border>-->
                                <!--</Grid>-->

                                <!-- Divider -->
                                <BoxView Grid.Row="3"
                                         HeightRequest="1"
                                         Color="{AppThemeBinding Light=#EEEEEE, Dark=#333333}" VerticalOptions="Center" />

                                <!-- Action Buttons -->
                                <Grid Grid.Row="4" ColumnDefinitions="*,*" ColumnSpacing="8" Margin="0,12,0,0">
                                    <Button Grid.Column="0"
                                            Text="View Partograph"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type pagemodels:ActivePatientsPageModel}}, Path=NavigateToPartographCommand, x:DataType=pagemodels:ActivePatientsPageModel}"
                                            CommandParameter="{Binding .}"
                                            BackgroundColor="#2196F3"
                                            TextColor="White"
                                            FontSize="14"
                                            FontAttributes="Bold"
                                            HeightRequest="44"
                                            CornerRadius="10">
                                        <Button.Shadow>
                                            <Shadow Brush="#2196F3"
                                                    Offset="0,2"
                                                    Radius="4"
                                                    Opacity="0.3" />
                                        </Button.Shadow>
                                    </Button>

                                    <Button Grid.Column="1"
                                            Text="Quick Entry"
                                            BackgroundColor="#4CAF50"
                                            TextColor="White"
                                            FontSize="14"
                                            FontAttributes="Bold"
                                            HeightRequest="44"
                                            CornerRadius="10"
                                            Clicked="OnShowMenuClicked">
                                        <Button.Shadow>
                                            <Shadow Brush="#4CAF50"
                                                    Offset="0,2"
                                                    Radius="4"
                                                    Opacity="0.3" />
                                        </Button.Shadow>
                                    </Button>
                                </Grid>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <popup:SfPopup Grid.Row="1" x:Name="contextMenuPopup" OverlayMode="Transparent"
                       ShowFooter="False"
                       ShowHeader="False" 
                       WidthRequest="200"
                       HeaderHeight="800"
                       >
            <popup:SfPopup.ContentTemplate>
                <DataTemplate>
                    <StackLayout Padding="5" Spacing="0">

                        <Button Text="Companion" 
                                BackgroundColor="Transparent"
                                TextColor="Black"
                                Clicked="OnShareClicked" HorizontalOptions="StartAndExpand"
                                HeightRequest="35" />

                        <Button Text="Pain Relief" 
                                BackgroundColor="Transparent"
                                TextColor="Black"
                                Clicked="OnShareClicked" HorizontalOptions="StartAndExpand"
                                HeightRequest="35"  />

                        <Button Text="Oral Fluid" 
                                BackgroundColor="Transparent"
                                TextColor="Black"
                                Clicked="OnShareClicked" HorizontalOptions="StartAndExpand"
                                HeightRequest="35"  />

                        <Button Text="Posture" 
                                BackgroundColor="Transparent"
                                TextColor="Black"
                                Clicked="OnShareClicked" HorizontalOptions="StartAndExpand"
                                HeightRequest="35"  />

                        <Button Text="FHR" 
                                BackgroundColor="Transparent"
                                TextColor="Black"
                                Clicked="OnEditClicked" HorizontalOptions="StartAndExpand"
                                HeightRequest="35"  />

                        <Button Text="Amniotic Fluid" 
                                BackgroundColor="Transparent"
                                TextColor="Black"
                                Clicked="OnShareClicked" HorizontalOptions="StartAndExpand"
                                HeightRequest="35"  />

                        <Button Text="Fetail Position" 
                                BackgroundColor="Transparent"
                                TextColor="Black"
                                Clicked="OnShareClicked" HorizontalOptions="StartAndExpand"
                                HeightRequest="35"  />

                        <Button Text="Caput" 
                                BackgroundColor="Transparent"
                                TextColor="Black"
                                Clicked="OnShareClicked" HorizontalOptions="StartAndExpand"
                                HeightRequest="35"  />

                        <Button Text="Moulding" 
                                BackgroundColor="Transparent"
                                TextColor="Black"
                                Clicked="OnShareClicked" HorizontalOptions="StartAndExpand"
                                HeightRequest="35"  />

                        <Button Text="Urine" 
                                BackgroundColor="Transparent"
                                TextColor="Black"
                                Clicked="OnShareClicked" HorizontalOptions="StartAndExpand"
                                HeightRequest="35"  />

                        <Button Text="Blood pressure" 
                                BackgroundColor="Transparent"
                                TextColor="Black"
                                Clicked="OnShareClicked" HorizontalOptions="StartAndExpand"
                                HeightRequest="35"  />

                        <Button Text="Contraction" 
                                BackgroundColor="Transparent"
                                TextColor="Red"
                                Clicked="OnDeleteClicked" HorizontalOptions="StartAndExpand"
                                HeightRequest="35"  />
                        
                        <Button Text="Head Descent" 
                                BackgroundColor="Transparent"
                                TextColor="Black"
                                Clicked="OnShareClicked" 
                                HorizontalOptions="StartAndExpand"
                                HeightRequest="35"  />

                    </StackLayout>
                </DataTemplate>
            </popup:SfPopup.ContentTemplate>
        </popup:SfPopup>
    </Grid>
</ContentView>
