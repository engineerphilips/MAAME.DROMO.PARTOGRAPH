<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="MAAME.DROMO.PARTOGRAPH.APP.Droid.Pages.BirthOutcomePage"
             xmlns:cards="clr-namespace:Syncfusion.Maui.Cards;assembly=Syncfusion.Maui.Cards"
             xmlns:buttons="clr-namespace:Syncfusion.Maui.Buttons;assembly=Syncfusion.Maui.Buttons"
             xmlns:core="clr-namespace:Syncfusion.Maui.Core;assembly=Syncfusion.Maui.Core"
             xmlns:picker="clr-namespace:Syncfusion.Maui.Picker;assembly=Syncfusion.Maui.Picker"
             xmlns:editors="clr-namespace:Syncfusion.Maui.Inputs;assembly=Syncfusion.Maui.Inputs"
             xmlns:chip="clr-namespace:Syncfusion.Maui.Core;assembly=Syncfusion.Maui.Core"
             xmlns:models="clr-namespace:MAAME.DROMO.PARTOGRAPH.MODEL;assembly=MAAME.DROMO.PARTOGRAPH.MODEL"
             xmlns:converters="clr-namespace:MAAME.DROMO.PARTOGRAPH.APP.Droid.Converters"
             Title="Birth Outcome"
             BackgroundColor="{AppThemeBinding Light=#F8F9FA, Dark=#121212}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Converters -->
            <converters:EditModeToButtonTextConverter x:Key="EditModeToButtonTextConverter" />
            <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
            <converters:NullableTimeConverter x:Key="NullableTimeConverter" />

            <!-- Hospital Theme Colors -->
            <Color x:Key="PrimaryBlue">#0078D4</Color>
            <Color x:Key="SurfaceWhite">#FFFFFF</Color>
            <Color x:Key="TextPrimary">#323130</Color>
            <Color x:Key="TextSecondary">#605E5C</Color>
            <Color x:Key="BorderLight">#E1DFDD</Color>

            <!-- Gradients -->
            <LinearGradientBrush x:Key="HeaderGradient" StartPoint="0,0" EndPoint="1,1">
                <GradientStop Color="#0078D4" Offset="0.0" />
                <GradientStop Color="#40E0FF" Offset="1.0" />
            </LinearGradientBrush>

            <!-- Button Styles -->
            <Style x:Key="PrimaryButton" TargetType="buttons:SfButton">
                <Setter Property="Background" Value="{StaticResource PrimaryBlue}" />
                <Setter Property="TextColor" Value="{StaticResource SurfaceWhite}" />
                <Setter Property="CornerRadius" Value="12" />
                <Setter Property="FontSize" Value="16" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="HeightRequest" Value="50" />
            </Style>

            <!-- Input Styles -->
            <Style x:Key="PatientInput" TargetType="core:SfTextInputLayout">
                <Setter Property="ContainerType" Value="Outlined" />
                <Setter Property="OutlineCornerRadius" Value="8" />
            </Style>

            <!-- Typography Styles -->
            <Style x:Key="SectionTitle" TargetType="Label">
                <Setter Property="FontSize" Value="18" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="{StaticResource TextPrimary}" />
                <Setter Property="Margin" Value="0,0,0,8" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <StackLayout Spacing="0" Padding="0,0,0,20">
            <!-- Patient Header Card -->
            <Border StrokeThickness="0"
                    BackgroundColor="{AppThemeBinding Light=#E3F2FD, Dark=#1565C0}"
                    Padding="15">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="10" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="10">
                    <Grid ColumnDefinitions="*,Auto">
                        <VerticalStackLayout>
                            <Label Text="{Binding PatientName}" FontSize="18" FontAttributes="Bold" />
                            <Label Text="{Binding PatientInfo}" FontSize="12" Opacity="0.8" />
                            <Label Text="{Binding LaborDuration, StringFormat='Labour Duration: {0}'}" FontSize="11" />
                            <Label Text="{Binding LaborStage, StringFormat='Stage: {0}'}" FontSize="11" FontAttributes="Bold" />
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="1" VerticalOptions="Center">
                            <Label Text="{Binding CurrentDilation, StringFormat='{0} cm'}"
                                   FontSize="24"
                                   FontAttributes="Bold"
                                   HorizontalOptions="Center" />
                            <Label Text="Dilation"
                                   FontSize="9"
                                   HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </Grid>

                    <!-- Labor Parameters Summary -->
                    <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                        <Border BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2D2D2D}"
                                StrokeThickness="0" Padding="8">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="8" />
                            </Border.StrokeShape>
                            <VerticalStackLayout>
                                <Label Text="{Binding LatestFHRDisplay}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       HorizontalOptions="Center" />
                                <Label Text="FHR"
                                       FontSize="9"
                                       HorizontalOptions="Center"
                                       Opacity="0.7" />
                            </VerticalStackLayout>
                        </Border>

                        <Border Grid.Column="1"
                                BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2D2D2D}"
                                StrokeThickness="0" Padding="8">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="8" />
                            </Border.StrokeShape>
                            <VerticalStackLayout>
                                <Label Text="{Binding LatestContractionsDisplay}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       HorizontalOptions="Center" />
                                <Label Text="Contractions"
                                       FontSize="9"
                                       HorizontalOptions="Center"
                                       Opacity="0.7" />
                            </VerticalStackLayout>
                        </Border>

                        <Border Grid.Column="2"
                                BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2D2D2D}"
                                StrokeThickness="0" Padding="8">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="8" />
                            </Border.StrokeShape>
                            <VerticalStackLayout>
                                <Label Text="{Binding LatestHeadDescentDisplay}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       HorizontalOptions="Center" />
                                <Label Text="Head Descent"
                                       FontSize="9"
                                       HorizontalOptions="Center"
                                       Opacity="0.7" />
                            </VerticalStackLayout>
                        </Border>
                    </Grid>

                    <!-- Second Stage Duration (if applicable) -->
                    <Label Text="{Binding SecondStageDuration, StringFormat='Second Stage Duration: {0}'}"
                           FontSize="11"
                           FontAttributes="Italic"
                           IsVisible="{Binding HasSecondStageDuration}" />
                </VerticalStackLayout>
            </Border>

            <!-- Maternal Outcome Section -->
            <!--<Label Text="ðŸ‘© Maternal Outcome" Style="{StaticResource SectionTitle}" Margin="20,15,0,10" />-->
            <Label Text="Maternal Outcome" Style="{StaticResource SectionTitle}" Margin="15,15,0,10" />
            <StackLayout Padding="20,0" Spacing="10">

                <core:SfTextInputLayout Hint="Maternal Status" Style="{StaticResource PatientInput}">
                    <Picker ItemsSource="{Binding MaternalOutcomeOptions}"
                            SelectedItem="{Binding MaternalStatus, Mode=TwoWay}"
                            SelectedIndexChanged="OnMaternalStatusChanged" />
                </core:SfTextInputLayout>

                <core:SfTextInputLayout Hint="Death Time"
                                        Style="{StaticResource PatientInput}"
                                        IsVisible="{Binding IsDeathFieldsVisible}">
                    <DatePicker Date="{Binding MaternalDeathTime, Mode=TwoWay}" />
                </core:SfTextInputLayout>

                <core:SfTextInputLayout Hint="Cause of Death"
                                        Style="{StaticResource PatientInput}"
                                        IsVisible="{Binding IsDeathFieldsVisible}">
                    <Entry Text="{Binding MaternalDeathCause, Mode=TwoWay}" />
                </core:SfTextInputLayout>

                <core:SfTextInputLayout Hint="Death Circumstances"
                                        Style="{StaticResource PatientInput}"
                                        IsVisible="{Binding IsDeathFieldsVisible}">
                    <Editor Text="{Binding MaternalDeathCircumstances, Mode=TwoWay}"
                            HeightRequest="80" />
                </core:SfTextInputLayout>
            </StackLayout>

            <!-- Delivery Information Section -->
            <!--<Label Text="ðŸ¤± Delivery Information" Style="{StaticResource SectionTitle}" Margin="20,15,0,10" />-->
            <Label Text="Delivery Information" Style="{StaticResource SectionTitle}" Margin="15,15,0,10" />
            <StackLayout Padding="20,0" Spacing="10">

                <core:SfTextInputLayout Hint="Delivery Mode" Style="{StaticResource PatientInput}">
                    <Picker ItemsSource="{Binding DeliveryModeOptions}"
                            SelectedItem="{Binding DeliveryMode, Mode=TwoWay}" />
                </core:SfTextInputLayout>

                <core:SfTextInputLayout Hint="Delivery Mode Details" Style="{StaticResource PatientInput}">
                    <Entry Text="{Binding DeliveryModeDetails, Mode=TwoWay}"
                           Placeholder="E.g., forceps, vacuum, indication for C-section" />
                </core:SfTextInputLayout>

                <!--<core:SfTextInputLayout Hint="Delivery Time" Style="{StaticResource PatientInput}">
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                        <DatePicker Grid.Column="0" Date="{Binding DeliveryTime, Mode=TwoWay, Converter={StaticResource DateTimeToDateConverter}}" />
                        <TimePicker Grid.Column="1" Time="{Binding DeliveryTime, Mode=TwoWay, Converter={StaticResource DateTimeToTimeConverter}}" />
                    </Grid>
                </core:SfTextInputLayout>-->

                <Grid ColumnDefinitions="*,*" RowDefinitions="Auto, Auto" ColumnSpacing="12">
                    <core:SfTextInputLayout Grid.Column="0"
                                                Hint="Delivery Date"
                                                Style="{StaticResource PatientInput}">
                        <DatePicker Date="{Binding DeliveryDate, Mode=TwoWay}"
                                       Format="dd-MM-yyyy" MinimumDate="01/01/1950" />
                    </core:SfTextInputLayout>

                    <core:SfTextInputLayout Grid.Column="1"
                                            Hint="Delivery Time"
                                            Style="{StaticResource PatientInput}">
                        <TimePicker Time="{Binding DeliveryTime, Mode=TwoWay}"
                                       Format="HH:mm" />
                    </core:SfTextInputLayout>

                    <core:SfTextInputLayout Hint="Number of Babies" Style="{StaticResource PatientInput}" Grid.Row="1" Grid.Column="0"
                                            HelperText="Enter 0 if no delivery occurred">
                        <editors:SfNumericEntry Value="{Binding NumberOfBabies, Mode=TwoWay}"
                                           Minimum="0"
                                           Maximum="5"
                                           CustomFormat="0"
                                           ValueChangeMode="OnKeyFocus" />
                    </core:SfTextInputLayout>
                </Grid>
            </StackLayout>

            <!-- Perineal Status Section -->
            <!--<Label Text="ðŸ¥ Perineal Status" Style="{StaticResource SectionTitle}" Margin="20,15,0,10" />-->
            <Label Text="Perineal Status" Style="{StaticResource SectionTitle}" Margin="15,15,0,10" />
            <StackLayout Padding="20,0" Spacing="10">

                <core:SfTextInputLayout Hint="Perineal Status" Style="{StaticResource PatientInput}">
                    <Picker ItemsSource="{Binding PerinealStatusOptions}"
                            SelectedItem="{Binding PerinealStatus, Mode=TwoWay}" />
                </core:SfTextInputLayout>

                <core:SfTextInputLayout Hint="Perineal Details" Style="{StaticResource PatientInput}">
                    <Entry Text="{Binding PerinealDetails, Mode=TwoWay}"
                           Placeholder="Repair details, suture material, etc." />
                </core:SfTextInputLayout>
            </StackLayout>

            <!-- Placental Information Section -->
            <!--<Label Text="ðŸ©¸ Placental Information" Style="{StaticResource SectionTitle}" Margin="20,15,0,10" />-->
            <Label Text="Placental Information" Style="{StaticResource SectionTitle}" Margin="15,15,0,10" />
            <StackLayout Padding="20,0" Spacing="10">
                <Grid ColumnDefinitions="*,*" RowDefinitions="Auto, Auto" ColumnSpacing="12">
                    <core:SfTextInputLayout Grid.Column="0"
                                Hint="Placenta Delivery Date"
                                Style="{StaticResource PatientInput}">
                        <DatePicker Date="{Binding PlacentaDeliveryDate, Mode=TwoWay}"
                       Format="dd-MM-yyyy" MinimumDate="{Binding DeliveryDate, Mode=OneWay}" />
                    </core:SfTextInputLayout>

                    <core:SfTextInputLayout Grid.Column="1"
                            Hint="Placenta Delivery Time"
                            Style="{StaticResource PatientInput}">
                        <TimePicker Time="{Binding PlacentaDeliveryTime, Mode=TwoWay}"
                       Format="HH:mm" />
                    </core:SfTextInputLayout>
                </Grid>
                
                <!--<Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                    <core:SfTextInputLayout Grid.Column="0" Hint="Placenta Delivery Time" Style="{StaticResource PatientInput}">
                        <TimePicker Time="{Binding PlacentaDeliveryTime, Mode=TwoWay, Converter={StaticResource NullableTimeConverter}}" />
                    </core:SfTextInputLayout>
                </Grid>-->

                <StackLayout Orientation="Horizontal" Spacing="10">
                    <CheckBox IsChecked="{Binding PlacentaComplete, Mode=TwoWay}" />
                    <Label Text="Placenta Complete" VerticalOptions="Center" />
                </StackLayout>

                <core:SfTextInputLayout Hint="Estimated Blood Loss (ml)" Style="{StaticResource PatientInput}">
                    <editors:SfNumericEntry Value="{Binding EstimatedBloodLoss, Mode=TwoWay}"
                                           Minimum="0"
                                           Maximum="5000"
                                           CustomFormat="0" />
                </core:SfTextInputLayout>
            </StackLayout>

            <!-- Maternal Complications Section -->
            <Label Text="Maternal Complications" Style="{StaticResource SectionTitle}" Margin="15,15,0,10" />
            <!--<Label Text="âš ï¸ Maternal Complications" Style="{StaticResource SectionTitle}" Margin="20,15,0,10" />-->
            <StackLayout Padding="20,0" Spacing="8">

                <chip:SfChipGroup ItemsSource="{Binding Complications}"
                                  DisplayMemberPath="Name" 
                                  Margin="0,8,16,8" ChipType="Choice" ChoiceMode="SingleOrNone">
                    <chip:SfChipGroup.ItemTemplate>
                        <DataTemplate>
                            <chip:SfChip Text="{Binding Name}" />

                            <!--IsChecked="{Binding IsSelected, Mode=TwoWay}"-->
                        </DataTemplate>
                    </chip:SfChipGroup.ItemTemplate>
                </chip:SfChipGroup>

                <core:SfTextInputLayout Hint="Other Complications" Style="{StaticResource PatientInput}">
                    <Editor Text="{Binding MaternalComplications, Mode=TwoWay}"
                            HeightRequest="80"
                            Placeholder="Describe any other complications..." />
                </core:SfTextInputLayout>
            </StackLayout>

            <!-- Post-delivery Care Section -->
            <!--<Label Text="ðŸ’Š Post-delivery Care" Style="{StaticResource SectionTitle}" Margin="20,15,0,10" />-->
            <Label Text="Post-delivery Care" Style="{StaticResource SectionTitle}" Margin="15,15,0,10" />
            <StackLayout Padding="20,0" Spacing="8">

                <StackLayout Orientation="Horizontal" Spacing="10">
                    <CheckBox IsChecked="{Binding OxytocinGiven, Mode=TwoWay}" />
                    <Label Text="Oxytocin Given (AMTSL)" VerticalOptions="Center" />
                </StackLayout>

                <StackLayout Orientation="Horizontal" Spacing="10">
                    <CheckBox IsChecked="{Binding AntibioticsGiven, Mode=TwoWay}" />
                    <Label Text="Antibiotics Given" VerticalOptions="Center" />
                </StackLayout>

                <StackLayout Orientation="Horizontal" Spacing="10">
                    <CheckBox IsChecked="{Binding BloodTransfusionGiven, Mode=TwoWay}" />
                    <Label Text="Blood Transfusion Given" VerticalOptions="Center" />
                </StackLayout>
            </StackLayout>

            <!-- Notes Section -->
            <!--<Label Text="ðŸ“ Notes" Style="{StaticResource SectionTitle}" Margin="20,15,0,10" />-->
            <Label Text="Notes" Style="{StaticResource SectionTitle}" Margin="15,15,0,10" />
            <StackLayout Padding="20,0" Spacing="10">
                <core:SfTextInputLayout Hint="Additional Notes" Style="{StaticResource PatientInput}">
                    <Editor Text="{Binding Notes, Mode=TwoWay}"
                            HeightRequest="100"
                            Placeholder="Any additional observations or notes..." />
                </core:SfTextInputLayout>
            </StackLayout>

            <!-- Action Buttons -->
            <StackLayout Padding="15" Spacing="10">
                <buttons:SfButton Text="{Binding IsEditMode, Converter={StaticResource EditModeToButtonTextConverter}, FallbackValue='Save Birth Outcome'}"
                                 Command="{Binding SaveCommand}"
                                 Style="{StaticResource PrimaryButton}"
                                 IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}" />

                <buttons:SfButton Text="Continue to Baby Details"
                                 Command="{Binding NavigateToBabyDetailsCommand}"
                                 IsVisible="{Binding IsEditMode}"
                                 IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}"
                                 BackgroundColor="Transparent"
                                 TextColor="{StaticResource PrimaryBlue}"
                                 Stroke="{StaticResource PrimaryBlue}"
                                 StrokeThickness="2"
                                 CornerRadius="12"
                                 HeightRequest="48" />
            </StackLayout>

        </StackLayout>
    </ScrollView>

</ContentPage>
