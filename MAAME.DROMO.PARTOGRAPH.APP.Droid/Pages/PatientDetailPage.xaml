<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="MAAME.DROMO.PARTOGRAPH.APP.Droid.Pages.PatientDetailPage"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:models="clr-namespace:MAAME.DROMO.PARTOGRAPH.APP.Droid.Models"
             xmlns:fonts="clr-namespace:Fonts"
             Title="{Binding Name, StringFormat='Patient: {0}'}">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Edit" 
                     Command="{Binding ToggleEditModeCommand}"
                     IconImageSource="{x:Static fonts:FluentUI.edit_16_regular}" />
        <!--IconImageSource="{FontImagefonts:FluentUI.FontFamily, Glyph=&#xE70F;, Color=White}"-->
        <ToolbarItem Text="Delete" 
                     Command="{Binding DeleteCommand}"
                     IconImageSource="{x:Static fonts:FluentUI.delete_16_regular}" />
        <!--IconImageSource="{FontImagefonts:FluentUI.FontFamily, Glyph=&#xE74D;, Color=White}"-->
    </ContentPage.ToolbarItems>

    <ScrollView>
        <Grid RowDefinitions="Auto,*" Padding="20">

            <!-- Patient Header Card -->
            <Border Grid.Row="0" 
                    StrokeThickness="0"
                    BackgroundColor="{Binding Status, Converter={StaticResource StatusColorConverter}}"
                    Margin="0,0,0,20"
                    Padding="20">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="15" />
                </Border.StrokeShape>

                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="20">
                    <!-- Patient Avatar -->
                    <Border Grid.Column="0"
                            WidthRequest="80"
                            HeightRequest="80"
                            BackgroundColor="White">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="40" />
                        </Border.StrokeShape>
                        <Label Text="{Binding Name, Converter={StaticResource InitialsConverter}}"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"
                               FontSize="28"
                               FontAttributes="Bold"
                               TextColor="{Binding Status, Converter={StaticResource StatusColorConverter}}" />
                    </Border>

                    <!-- Basic Info -->
                    <VerticalStackLayout Grid.Column="1" VerticalOptions="Center">
                        <Label Text="{Binding Name}" 
                               FontSize="24" 
                               FontAttributes="Bold"
                               TextColor="White" />
                        <Label Text="{Binding HospitalNumber}" 
                               FontSize="16"
                               TextColor="White"
                               Opacity="0.9" />
                        <Label Text="{Binding DisplayInfo}" 
                               FontSize="14"
                               TextColor="White"
                               Opacity="0.8" />
                    </VerticalStackLayout>

                    <!-- Status Badge -->
                    <Border Grid.Column="2"
                            BackgroundColor="White"
                            Padding="15,8"
                            VerticalOptions="Center">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="20" />
                        </Border.StrokeShape>
                        <Label Text="{Binding StatusDisplay}"
                               FontAttributes="Bold"
                               TextColor="{Binding Status, Converter={StaticResource StatusColorConverter}}" />
                    </Border>
                </Grid>
            </Border>

            <!-- Patient Details Form -->
            <VerticalStackLayout Grid.Row="1" Spacing="20">

                <!-- Quick Actions -->
                <Grid ColumnDefinitions="*,*,*,*" ColumnSpacing="10">
                    <Button Grid.Column="0"
                            Text="&#xE8A5;"
                            FontFamily="{x:Static fonts:FluentUI.FontFamily}"
                            Command="{Binding NavigateToPartographCommand}"
                            BackgroundColor="#2196F3"
                            TextColor="White"
                            HeightRequest="50"
                            CornerRadius="10">
                        <Button.Triggers>
                            <DataTrigger TargetType="Button" 
                                        Binding="{Binding Status}" 
                                        Value="Pending">
                                <Setter Property="IsEnabled" Value="False" />
                                <Setter Property="Opacity" Value="0.5" />
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>

                    <Button Grid.Column="1"
                            Text="&#xE710;"
                            FontFamily="{x:Static fonts:FluentUI.FontFamily}"
                            Command="{Binding AddPartographEntryCommand}"
                            BackgroundColor="#4CAF50"
                            TextColor="White"
                            HeightRequest="50"
                            CornerRadius="10">
                        <Button.Triggers>
                            <DataTrigger TargetType="Button" 
                                         Binding="{Binding Status}" 
                                         Value="Pending">
                                <Setter Property="IsEnabled" Value="False" />
                                <Setter Property="Opacity" Value="0.5" />
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>

                    <Button Grid.Column="2"
                            Text="&#xE95E;"
                            FontFamily="{x:Static fonts:FluentUI.FontFamily}"
                            Command="{Binding AddVitalSignsCommand}"
                            BackgroundColor="#FF9800"
                            TextColor="White"
                            HeightRequest="50"
                            CornerRadius="10" />

                    <Button Grid.Column="3"
                            Text="&#xE8F2;"
                            FontFamily="{x:Static fonts:FluentUI.FontFamily}"
                            Command="{Binding StartActiveLaborCommand}"
                            BackgroundColor="#9C27B0"
                            TextColor="White"
                            HeightRequest="50"
                            CornerRadius="10"
                            IsVisible="{Binding Status, Converter={StaticResource StatusToBoolConverter}, ConverterParameter=Pending}" />

                    <Button Grid.Column="3"
                            Text="&#xE73E;"
                            FontFamily="{x:Static fonts:FluentUI.FontFamily}"
                            Command="{Binding CompleteDeliveryCommand}"
                            BackgroundColor="#4CAF50"
                            TextColor="White"
                            HeightRequest="50"
                            CornerRadius="10"
                            IsVisible="{Binding Status, Converter={StaticResource StatusToBoolConverter}, ConverterParameter=Active}" />
                </Grid>

                <!-- Obstetric Information -->
                <Border StrokeThickness="1" 
                        Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#424242}"
                        BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                        Padding="15">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="10" />
                    </Border.StrokeShape>
                    <VerticalStackLayout Spacing="15">
                        <Label Text="Obstetric Information" FontSize="18" FontAttributes="Bold" />

                        <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="15" ColumnSpacing="15">
                            <VerticalStackLayout Grid.Row="0" Grid.Column="0">
                                <Label Text="Age" FontSize="12" TextColor="{AppThemeBinding Light=#666, Dark=#AAA}" />
                                <Entry Text="{Binding Age}" 
                                       IsReadOnly="{Binding IsEditMode, Converter={toolkit:InvertedBoolConverter}}"
                                       Keyboard="Numeric" />
                            </VerticalStackLayout>

                            <VerticalStackLayout Grid.Row="0" Grid.Column="1">
                                <Label Text="Blood Group" FontSize="12" TextColor="{AppThemeBinding Light=#666, Dark=#AAA}" />
                                <Entry Text="{Binding BloodGroup}" 
                                       IsReadOnly="{Binding IsEditMode, Converter={toolkit:InvertedBoolConverter}}" />
                            </VerticalStackLayout>

                            <VerticalStackLayout Grid.Row="1" Grid.Column="0">
                                <Label Text="Gravidity" FontSize="12" TextColor="{AppThemeBinding Light=#666, Dark=#AAA}" />
                                <Entry Text="{Binding Gravidity}" 
                                       IsReadOnly="{Binding IsEditMode, Converter={toolkit:InvertedBoolConverter}}"
                                       Keyboard="Numeric" />
                            </VerticalStackLayout>

                            <VerticalStackLayout Grid.Row="1" Grid.Column="1">
                                <Label Text="Parity" FontSize="12" TextColor="{AppThemeBinding Light=#666, Dark=#AAA}" />
                                <Entry Text="{Binding Parity}" 
                                       IsReadOnly="{Binding IsEditMode, Converter={toolkit:InvertedBoolConverter}}"
                                       Keyboard="Numeric" />
                            </VerticalStackLayout>

                            <VerticalStackLayout Grid.Row="2" Grid.Column="0">
                                <Label Text="Admission Date" FontSize="12" TextColor="{AppThemeBinding Light=#666, Dark=#AAA}" />
                                <DatePicker Date="{Binding AdmissionDate}" 
                                           IsEnabled="{Binding IsEditMode}" />
                            </VerticalStackLayout>

                            <VerticalStackLayout Grid.Row="2" Grid.Column="1">
                                <Label Text="Expected Delivery Date" FontSize="12" TextColor="{AppThemeBinding Light=#666, Dark=#AAA}" />
                                <DatePicker Date="{Binding ExpectedDeliveryDate}" 
                                           IsEnabled="{Binding IsEditMode}" />
                            </VerticalStackLayout>

                            <VerticalStackLayout Grid.Row="3" Grid.Column="0">
                                <Label Text="Cervical Dilation on Admission (cm)" FontSize="12" TextColor="{AppThemeBinding Light=#666, Dark=#AAA}" />
                                <Entry Text="{Binding CervicalDilationOnAdmission}" 
                                       IsReadOnly="{Binding IsEditMode, Converter={toolkit:InvertedBoolConverter}}"
                                       Keyboard="Numeric" />
                            </VerticalStackLayout>

                            <VerticalStackLayout Grid.Row="3" Grid.Column="1">
                                <Label Text="Membrane Status" FontSize="12" TextColor="{AppThemeBinding Light=#666, Dark=#AAA}" />
                                <Picker SelectedItem="{Binding MembraneStatus}"
                                        IsEnabled="{Binding IsEditMode}">
                                    <Picker.ItemsSource>
                                        <x:Array Type="{x:Type x:String}">
                                            <x:String>Intact</x:String>
                                            <x:String>Ruptured</x:String>
                                            <x:String>Artificial Rupture</x:String>
                                        </x:Array>
                                    </Picker.ItemsSource>
                                </Picker>
                            </VerticalStackLayout>
                        </Grid>
                    </VerticalStackLayout>
                </Border>

                <!-- Contact Information -->
                <Border StrokeThickness="1" 
                        Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#424242}"
                        BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                        Padding="15">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="10" />
                    </Border.StrokeShape>
                    <VerticalStackLayout Spacing="15">
                        <Label Text="Contact Information" FontSize="18" FontAttributes="Bold" />

                        <VerticalStackLayout>
                            <Label Text="Phone Number" FontSize="12" TextColor="{AppThemeBinding Light=#666, Dark=#AAA}" />
                            <Entry Text="{Binding PhoneNumber}" 
                                   IsReadOnly="{Binding IsEditMode, Converter={toolkit:InvertedBoolConverter}}"
                                   Keyboard="Telephone" />
                        </VerticalStackLayout>

                        <VerticalStackLayout>
                            <Label Text="Emergency Contact" FontSize="12" TextColor="{AppThemeBinding Light=#666, Dark=#AAA}" />
                            <Entry Text="{Binding EmergencyContact}" 
                                   IsReadOnly="{Binding IsEditMode, Converter={toolkit:InvertedBoolConverter}}"
                                   Keyboard="Telephone" />
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </Border>

                <!-- Risk Factors -->
                <Border StrokeThickness="1" 
                        Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#424242}"
                        BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                        Padding="15">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="10" />
                    </Border.StrokeShape>
                    <VerticalStackLayout Spacing="15">
                        <Label Text="Clinical Notes" FontSize="18" FontAttributes="Bold" />

                        <VerticalStackLayout>
                            <Label Text="Risk Factors" FontSize="12" TextColor="{AppThemeBinding Light=#666, Dark=#AAA}" />
                            <Editor Text="{Binding RiskFactors}" 
                                    IsReadOnly="{Binding IsEditMode, Converter={toolkit:InvertedBoolConverter}}"
                                    MinimumHeightRequest="80"
                                    AutoSize="TextChanges" />
                        </VerticalStackLayout>

                        <VerticalStackLayout>
                            <Label Text="Complications" FontSize="12" TextColor="{AppThemeBinding Light=#666, Dark=#AAA}" />
                            <Editor Text="{Binding Complications}" 
                                    IsReadOnly="{Binding IsEditMode, Converter={toolkit:InvertedBoolConverter}}"
                                    MinimumHeightRequest="80"
                                    AutoSize="TextChanges" />
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </Border>

                <!-- Recent Partograph Entries -->
                <Border StrokeThickness="1" 
                        Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#424242}"
                        BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                        Padding="15"
                        IsVisible="{Binding PartographEntries.Count, Converter={toolkit:IntToBoolConverter}}">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="10" />
                    </Border.StrokeShape>
                    <VerticalStackLayout Spacing="10">
                        <HorizontalStackLayout>
                            <Label Text="Recent Partograph Entries" FontSize="18" FontAttributes="Bold" HorizontalOptions="StartAndExpand" />
                            <Button Text="View All"
                                    Command="{Binding NavigateToPartographCommand}"
                                    BackgroundColor="Transparent"
                                    TextColor="#2196F3" />
                        </HorizontalStackLayout>

                        <CollectionView ItemsSource="{Binding PartographEntries}"
                                        HeightRequest="200">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:PartographEntry">
                                    <Border StrokeThickness="1"
                                            Stroke="{AppThemeBinding Light=#F0F0F0, Dark=#333}"
                                            BackgroundColor="{AppThemeBinding Light=#FAFAFA, Dark=#2A2A2A}"
                                            Margin="0,5"
                                            Padding="10">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="5" />
                                        </Border.StrokeShape>
                                        <Grid ColumnDefinitions="Auto,*,Auto">
                                            <Label Grid.Column="0"
                                                   Text="{Binding RecordedTime, StringFormat='{0:HH:mm}'}"
                                                   FontAttributes="Bold"
                                                   VerticalOptions="Center" />
                                            <HorizontalStackLayout Grid.Column="1" Spacing="15" Margin="15,0">
                                                <Label Text="{Binding CervicalDilation, StringFormat='Cx: {0}cm'}" />
                                                <Label Text="{Binding FetalHeartRate, StringFormat='FHR: {0}'}" />
                                                <Label Text="{Binding ContractionsPerTenMinutes, StringFormat='Ctx: {0}/10min'}" />
                                            </HorizontalStackLayout>
                                            <Label Grid.Column="2"
                                                   Text="{Binding RecordedBy}"
                                                   FontSize="12"
                                                   TextColor="{AppThemeBinding Light=#666, Dark=#AAA}"
                                                   VerticalOptions="Center" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Border>

                <!-- Recent Vital Signs -->
                <Border StrokeThickness="1" 
                        Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#424242}"
                        BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                        Padding="15"
                        IsVisible="{Binding VitalSigns.Count, Converter={toolkit:IntToBoolConverter}}">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="10" />
                    </Border.StrokeShape>
                    <VerticalStackLayout Spacing="10">
                        <Label Text="Recent Vital Signs" FontSize="18" FontAttributes="Bold" />

                        <CollectionView ItemsSource="{Binding VitalSigns}"
                                        HeightRequest="150">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:VitalSign">
                                    <Border StrokeThickness="1"
                                            Stroke="{Binding IsAbnormal, Converter={StaticResource AbnormalColorConverter}}"
                                            BackgroundColor="{AppThemeBinding Light=#FAFAFA, Dark=#2A2A2A}"
                                            Margin="0,5"
                                            Padding="10">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="5" />
                                        </Border.StrokeShape>
                                        <Grid ColumnDefinitions="Auto,*">
                                            <Label Grid.Column="0"
                                                   Text="{Binding RecordedTime, StringFormat='{0:HH:mm}'}"
                                                   FontAttributes="Bold"
                                                   VerticalOptions="Center"
                                                   Margin="0,0,15,0" />
                                            <HorizontalStackLayout Grid.Column="1" Spacing="15">
                                                <Label Text="{Binding BPDisplay, StringFormat='BP: {0}'}" />
                                                <Label Text="{Binding Temperature, StringFormat='Temp: {0}Â°C'}" />
                                                <Label Text="{Binding PulseRate, StringFormat='Pulse: {0}'}" />
                                            </HorizontalStackLayout>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Border>

                <!-- Save Button (visible in edit mode) -->
                <Button Text="Save Changes"
                        Command="{Binding SaveCommand}"
                        BackgroundColor="#4CAF50"
                        TextColor="White"
                        HeightRequest="50"
                        CornerRadius="10"
                        IsVisible="{Binding IsEditMode}"
                        Margin="0,20,0,0" />

            </VerticalStackLayout>
        </Grid>
    </ScrollView>
</ContentPage>