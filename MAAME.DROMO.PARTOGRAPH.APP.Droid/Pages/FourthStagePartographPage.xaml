<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="MAAME.DROMO.PARTOGRAPH.APP.Droid.Pages.FourthStagePartographPage"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:fonts="clr-namespace:Fonts"
             xmlns:converters="clr-namespace:MAAME.DROMO.PARTOGRAPH.APP.Droid.Converters"
             xmlns:modals="clr-namespace:MAAME.DROMO.PARTOGRAPH.APP.Droid.Pages.Modals"
             Title="Fourth Stage Partograph">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Converters -->
            <converters:IsNotNullConverter x:Key="IsNotNullConverter" />
            <converters:GramsToKilogramsConverter x:Key="GramsToKilogramsConverter" />

            <!-- Colors -->
            <Color x:Key="PrimaryBlue">#2196F3</Color>
            <Color x:Key="SuccessGreen">#4CAF50</Color>
            <Color x:Key="WarningOrange">#FF9800</Color>
            <Color x:Key="DangerRed">#F44336</Color>
            <Color x:Key="Purple">#9C27B0</Color>

            <!-- Modern Card Style -->
            <Style x:Key="ModernCardStyle" TargetType="Border">
                <Setter Property="StrokeThickness" Value="0" />
                <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=White, Dark=#1E293B}" />
                <Setter Property="Padding" Value="16" />
                <Setter Property="StrokeShape">
                    <RoundRectangle CornerRadius="16" />
                </Setter>
                <Setter Property="Shadow">
                    <Shadow Brush="{AppThemeBinding Light=#10000000, Dark=#30000000}"
                            Offset="0,4"
                            Radius="16"
                            Opacity="0.12" />
                </Setter>
            </Style>

            <!-- Section Title Style -->
            <Style x:Key="SectionTitleStyle" TargetType="Label">
                <Setter Property="FontSize" Value="16" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light=#1E293B, Dark=#F8FAFC}" />
                <Setter Property="Margin" Value="0,0,0,8" />
            </Style>

            <!-- Vital Button Style -->
            <Style x:Key="VitalButtonStyle" TargetType="Button">
                <Setter Property="HeightRequest" Value="44" />
                <Setter Property="CornerRadius" Value="10" />
                <Setter Property="FontSize" Value="13" />
                <Setter Property="Padding" Value="12,8" />
            </Style>

            <!-- Assessment Button Style -->
            <Style x:Key="AssessmentButtonStyle" TargetType="Button">
                <Setter Property="HeightRequest" Value="36" />
                <Setter Property="CornerRadius" Value="8" />
                <Setter Property="FontSize" Value="12" />
                <Setter Property="Padding" Value="10,4" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Refresh"
                     Command="{Binding RefreshCommand}"
                     IconImageSource="{x:Static fonts:FluentUI.arrow_sync_16_regular}" />
        <ToolbarItem Text="Print"
                     Command="{Binding PrintCommand}"
                     IconImageSource="{x:Static fonts:FluentUI.print_16_regular}" />
    </ContentPage.ToolbarItems>

    <Grid>
        <ScrollView>
            <VerticalStackLayout Padding="12" Spacing="12">

                <!-- Patient Header -->
                <Border StrokeThickness="0"
                        BackgroundColor="{AppThemeBinding Light=#F3E5F5, Dark=#4A148C}"
                        Padding="16">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="12" />
                    </Border.StrokeShape>
                    <Grid ColumnDefinitions="*,Auto">
                        <VerticalStackLayout Spacing="4">
                            <Label Text="{Binding PatientName}"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light=#1E293B, Dark=White}" />
                            <Label Text="{Binding PatientInfo}"
                                   FontSize="13"
                                   TextColor="{AppThemeBinding Light=#475569, Dark=#E0E0E0}" />
                            <HorizontalStackLayout Spacing="16" Margin="0,8,0,0">
                                <HorizontalStackLayout Spacing="4">
                                    <Label Text="{x:Static fonts:FluentUI.timer_16_regular}"
                                           FontFamily="FluentUI"
                                           FontSize="14"
                                           TextColor="{StaticResource Purple}"
                                           VerticalOptions="Center" />
                                    <Label Text="{Binding FourthStageDuration}"
                                           FontSize="13"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light=#1E293B, Dark=White}" />
                                </HorizontalStackLayout>
                                <Label Text="{Binding RemainingTime}"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light=#64748B, Dark=#B0BEC5}" />
                                <Label Text="{Binding VitalSignsProgress, StringFormat='Vitals: {0}'}"
                                       FontSize="12"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource PrimaryBlue}" />
                            </HorizontalStackLayout>
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" HorizontalOptions="End">
                            <Border BackgroundColor="{StaticResource Purple}"
                                    StrokeThickness="0"
                                    Padding="12,6">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="8" />
                                </Border.StrokeShape>
                                <Label Text="STAGE 4"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="White"
                                       HorizontalOptions="Center" />
                            </Border>
                            <Label Text="Postpartum (2hrs)"
                                   FontSize="11"
                                   HorizontalOptions="Center"
                                   TextColor="{AppThemeBinding Light=#64748B, Dark=#B0BEC5}"
                                   Margin="0,4,0,0" />
                        </VerticalStackLayout>
                    </Grid>
                </Border>

                <!-- Alert Banner -->
                <Border IsVisible="{Binding HasAlert}"
                        BackgroundColor="{Binding AlertColor}"
                        StrokeThickness="0"
                        Padding="12">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="10" />
                    </Border.StrokeShape>
                    <HorizontalStackLayout Spacing="8">
                        <Label Text="{x:Static fonts:FluentUI.warning_16_filled}"
                               FontFamily="FluentUI"
                               FontSize="18"
                               TextColor="White"
                               VerticalOptions="Center" />
                        <Label Text="{Binding AlertMessage}"
                               FontSize="13"
                               FontAttributes="Bold"
                               TextColor="White"
                               VerticalOptions="Center" />
                    </HorizontalStackLayout>
                </Border>

                <!-- WHO 2020 Fourth Stage Monitoring Info -->
                <Border StrokeThickness="1"
                        Stroke="{AppThemeBinding Light=#9C27B0, Dark=#BA68C8}"
                        BackgroundColor="{AppThemeBinding Light=#F3E5F5, Dark=#4A148C}"
                        Padding="12">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="10" />
                    </Border.StrokeShape>
                    <VerticalStackLayout Spacing="6">
                        <Label Text="Fourth Stage Monitoring (WHO 2020)"
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light=#6A1B9A, Dark=#E1BEE7}" />
                        <Label FontSize="12" TextColor="{AppThemeBinding Light=#6A1B9A, Dark=#CE93D8}">
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="Monitor every 15 min: " FontAttributes="Bold" />
                                    <Span Text="BP, Pulse, Temp, Fundal height, Bleeding, Bladder, Uterine tone" />
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                        <Label FontSize="12" TextColor="{StaticResource DangerRed}">
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="Alert: " FontAttributes="Bold" />
                                    <Span Text="Watch for PPH - Rising pulse + Falling BP = Hemorrhage" />
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                    </VerticalStackLayout>
                </Border>

                <!-- Maternal Vitals Monitoring Card -->
                <Border Style="{StaticResource ModernCardStyle}">
                    <VerticalStackLayout Spacing="12">
                        <HorizontalStackLayout Spacing="8">
                            <Label Text="{x:Static fonts:FluentUI.heart_pulse_16_regular}"
                                   FontFamily="FluentUI"
                                   FontSize="18"
                                   TextColor="{StaticResource DangerRed}"
                                   VerticalOptions="Center" />
                            <Label Text="Maternal Vitals (Every 15 min)"
                                   Style="{StaticResource SectionTitleStyle}"
                                   Margin="0" />
                            <Border BackgroundColor="{Binding IsVitalSignsDue, Converter={StaticResource IsNotNullConverter}, ConverterParameter='#F44336|#4CAF50'}"
                                    StrokeThickness="0"
                                    Padding="8,2"
                                    IsVisible="{Binding IsVitalSignsDue}">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="10" />
                                </Border.StrokeShape>
                                <Label Text="DUE NOW"
                                       FontSize="10"
                                       FontAttributes="Bold"
                                       TextColor="White" />
                            </Border>
                        </HorizontalStackLayout>

                        <!-- BP/Pulse Row -->
                        <Grid ColumnDefinitions="*,Auto,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="10" RowSpacing="8">
                            <!-- BP Display -->
                            <VerticalStackLayout Grid.Row="0" Grid.Column="0">
                                <Label Text="Blood Pressure" FontSize="12" TextColor="{AppThemeBinding Light=#64748B, Dark=#94A3B8}" />
                                <HorizontalStackLayout Spacing="8">
                                    <Label Text="{Binding BpLatestValue}"
                                           FontSize="18"
                                           FontAttributes="Bold"
                                           TextColor="{Binding BpButtonColor}" />
                                    <Label Text="{Binding BpStatusText}"
                                           FontSize="11"
                                           TextColor="{Binding BpButtonColor}"
                                           VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </VerticalStackLayout>
                            <Button Grid.Row="0" Grid.Column="1"
                                    Text="Record"
                                    Command="{Binding RecordBpPulseCommand}"
                                    BackgroundColor="{StaticResource DangerRed}"
                                    TextColor="White"
                                    Style="{StaticResource VitalButtonStyle}" />
                            <Button Grid.Row="0" Grid.Column="2"
                                    Text="Trend"
                                    Command="{Binding ShowBpTrendCommand}"
                                    BackgroundColor="{AppThemeBinding Light=#E2E8F0, Dark=#334155}"
                                    TextColor="{AppThemeBinding Light=#475569, Dark=#E2E8F0}"
                                    Style="{StaticResource VitalButtonStyle}" />

                            <!-- Pulse Display -->
                            <VerticalStackLayout Grid.Row="1" Grid.Column="0">
                                <Label Text="Pulse" FontSize="12" TextColor="{AppThemeBinding Light=#64748B, Dark=#94A3B8}" />
                                <HorizontalStackLayout Spacing="8">
                                    <Label Text="{Binding PulseLatestValue}"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="{Binding PulseButtonColor}" />
                                    <Label Text="{Binding PulseStatusText}"
                                           FontSize="11"
                                           TextColor="{Binding PulseButtonColor}"
                                           VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </VerticalStackLayout>
                        </Grid>

                        <BoxView HeightRequest="1" Color="{AppThemeBinding Light=#E2E8F0, Dark=#334155}" Margin="0,4" />

                        <!-- Temperature Row -->
                        <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="10">
                            <VerticalStackLayout>
                                <Label Text="Temperature" FontSize="12" TextColor="{AppThemeBinding Light=#64748B, Dark=#94A3B8}" />
                                <HorizontalStackLayout Spacing="8">
                                    <Label Text="{Binding TemperatureLatestValue}"
                                           FontSize="18"
                                           FontAttributes="Bold"
                                           TextColor="{Binding TemperatureButtonColor}" />
                                    <Label Text="{Binding TemperatureStatusText}"
                                           FontSize="11"
                                           TextColor="{Binding TemperatureButtonColor}"
                                           VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </VerticalStackLayout>
                            <Button Grid.Column="1"
                                    Text="Record"
                                    Command="{Binding RecordTemperatureCommand}"
                                    BackgroundColor="{StaticResource WarningOrange}"
                                    TextColor="White"
                                    Style="{StaticResource VitalButtonStyle}" />
                            <Button Grid.Column="2"
                                    Text="Trend"
                                    Command="{Binding ShowTemperatureTrendCommand}"
                                    BackgroundColor="{AppThemeBinding Light=#E2E8F0, Dark=#334155}"
                                    TextColor="{AppThemeBinding Light=#475569, Dark=#E2E8F0}"
                                    Style="{StaticResource VitalButtonStyle}" />
                        </Grid>

                        <!-- Next Vitals Due -->
                        <Border BackgroundColor="{AppThemeBinding Light=#F8FAFC, Dark=#0F172A}"
                                StrokeThickness="1"
                                Stroke="{AppThemeBinding Light=#E2E8F0, Dark=#334155}"
                                Padding="10">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="8" />
                            </Border.StrokeShape>
                            <HorizontalStackLayout Spacing="16">
                                <Label FontSize="12" TextColor="{AppThemeBinding Light=#64748B, Dark=#94A3B8}">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="Last: " />
                                            <Span Text="{Binding LastVitalSignsTime}" FontAttributes="Bold" />
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                                <Label FontSize="12" TextColor="{AppThemeBinding Light=#64748B, Dark=#94A3B8}">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="Next: " />
                                            <Span Text="{Binding NextVitalSignsDue}" FontAttributes="Bold" TextColor="{StaticResource DangerRed}" />
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                                <Label Text="{Binding VitalSignsProgress}"
                                       FontSize="12"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource PrimaryBlue}" />
                            </HorizontalStackLayout>
                        </Border>
                    </VerticalStackLayout>
                </Border>

                <!-- Fourth Stage Assessment Cards Grid -->
                <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" ColumnSpacing="10" RowSpacing="10">

                    <!-- Fundal Height Card -->
                    <Border Grid.Row="0" Grid.Column="0" Style="{StaticResource ModernCardStyle}">
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Fundal Height" Style="{StaticResource SectionTitleStyle}" />
                            <Label Text="{Binding FundalHeight}"
                                   FontSize="15"
                                   FontAttributes="Bold"
                                   TextColor="{Binding FundalHeightColor}" />
                            <Label Text="{Binding FundalHeightStatus}"
                                   FontSize="11"
                                   TextColor="{AppThemeBinding Light=#64748B, Dark=#94A3B8}" />
                            <Button Text="Update"
                                    Command="{Binding UpdateFundalHeightCommand}"
                                    BackgroundColor="{StaticResource PrimaryBlue}"
                                    TextColor="White"
                                    Style="{StaticResource AssessmentButtonStyle}" />
                        </VerticalStackLayout>
                    </Border>

                    <!-- Bleeding Status Card -->
                    <Border Grid.Row="0" Grid.Column="1" Style="{StaticResource ModernCardStyle}">
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Bleeding Assessment" Style="{StaticResource SectionTitleStyle}" />
                            <Label Text="{Binding BleedingStatus}"
                                   FontSize="15"
                                   FontAttributes="Bold"
                                   TextColor="{Binding BleedingStatusColor}" />
                            <Label Text="{Binding EstimatedBloodLoss}"
                                   FontSize="11"
                                   TextColor="{AppThemeBinding Light=#64748B, Dark=#94A3B8}" />
                            <Button Text="Update"
                                    Command="{Binding UpdateBleedingStatusCommand}"
                                    BackgroundColor="{StaticResource DangerRed}"
                                    TextColor="White"
                                    Style="{StaticResource AssessmentButtonStyle}" />
                        </VerticalStackLayout>
                    </Border>

                    <!-- Bladder Status Card -->
                    <Border Grid.Row="1" Grid.Column="0" Style="{StaticResource ModernCardStyle}">
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Bladder Status" Style="{StaticResource SectionTitleStyle}" />
                            <Label Text="{Binding BladderStatus}"
                                   FontSize="15"
                                   FontAttributes="Bold"
                                   TextColor="{Binding BladderStatusColor}" />
                            <Label Text="Should be empty"
                                   FontSize="11"
                                   TextColor="{AppThemeBinding Light=#64748B, Dark=#94A3B8}" />
                            <Button Text="Update"
                                    Command="{Binding UpdateBladderStatusCommand}"
                                    BackgroundColor="{StaticResource WarningOrange}"
                                    TextColor="White"
                                    Style="{StaticResource AssessmentButtonStyle}" />
                        </VerticalStackLayout>
                    </Border>

                    <!-- Uterine Status Card -->
                    <Border Grid.Row="1" Grid.Column="1" Style="{StaticResource ModernCardStyle}">
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Uterine Tone" Style="{StaticResource SectionTitleStyle}" />
                            <Label Text="{Binding UterineStatus}"
                                   FontSize="15"
                                   FontAttributes="Bold"
                                   TextColor="{Binding UterineStatusColor}" />
                            <Label Text="Should be firm"
                                   FontSize="11"
                                   TextColor="{AppThemeBinding Light=#64748B, Dark=#94A3B8}" />
                            <Button Text="Update"
                                    Command="{Binding UpdateUterineStatusCommand}"
                                    BackgroundColor="{StaticResource SuccessGreen}"
                                    TextColor="White"
                                    Style="{StaticResource AssessmentButtonStyle}" />
                        </VerticalStackLayout>
                    </Border>
                </Grid>

                <!-- Mother-Baby Bonding Card -->
                <Border Style="{StaticResource ModernCardStyle}">
                    <VerticalStackLayout Spacing="12">
                        <HorizontalStackLayout Spacing="8">
                            <Label Text="{x:Static fonts:FluentUI.people_16_regular}"
                                   FontFamily="FluentUI"
                                   FontSize="18"
                                   TextColor="{StaticResource SuccessGreen}"
                                   VerticalOptions="Center" />
                            <Label Text="Mother-Baby Bonding"
                                   Style="{StaticResource SectionTitleStyle}"
                                   Margin="0" />
                        </HorizontalStackLayout>

                        <Grid ColumnDefinitions="*,*,*" ColumnSpacing="10">
                            <VerticalStackLayout HorizontalOptions="Center" Spacing="4">
                                <Label Text="{x:Static fonts:FluentUI.checkmark_circle_16_filled}"
                                       FontFamily="FluentUI"
                                       FontSize="24"
                                       TextColor="{Binding SkinToSkinInitiated, Converter={StaticResource IsNotNullConverter}, ConverterParameter='#4CAF50|#9E9E9E'}"
                                       HorizontalOptions="Center" />
                                <Label Text="Skin-to-skin"
                                       FontSize="11"
                                       HorizontalOptions="Center"
                                       TextColor="{AppThemeBinding Light=#64748B, Dark=#94A3B8}" />
                            </VerticalStackLayout>
                            <VerticalStackLayout HorizontalOptions="Center" Spacing="4">
                                <Label Text="{x:Static fonts:FluentUI.checkmark_circle_16_filled}"
                                       FontFamily="FluentUI"
                                       FontSize="24"
                                       TextColor="{Binding BreastfeedingInitiated, Converter={StaticResource IsNotNullConverter}, ConverterParameter='#4CAF50|#9E9E9E'}"
                                       HorizontalOptions="Center" />
                                <Label Text="Breastfeeding"
                                       FontSize="11"
                                       HorizontalOptions="Center"
                                       TextColor="{AppThemeBinding Light=#64748B, Dark=#94A3B8}" />
                            </VerticalStackLayout>
                            <VerticalStackLayout HorizontalOptions="Center" Spacing="4">
                                <Label Text="{x:Static fonts:FluentUI.checkmark_circle_16_filled}"
                                       FontFamily="FluentUI"
                                       FontSize="24"
                                       TextColor="{Binding BabyVitalsStable, Converter={StaticResource IsNotNullConverter}, ConverterParameter='#4CAF50|#9E9E9E'}"
                                       HorizontalOptions="Center" />
                                <Label Text="Baby stable"
                                       FontSize="11"
                                       HorizontalOptions="Center"
                                       TextColor="{AppThemeBinding Light=#64748B, Dark=#94A3B8}" />
                            </VerticalStackLayout>
                        </Grid>

                        <!-- Baby List -->
                        <CollectionView ItemsSource="{Binding Babies}"
                                        IsVisible="{Binding HasBabies}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Border Stroke="{AppThemeBinding Light=#E2E8F0, Dark=#334155}"
                                            StrokeThickness="1"
                                            BackgroundColor="{AppThemeBinding Light=#F8FAFC, Dark=#0F172A}"
                                            Padding="10"
                                            Margin="0,4">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="8" />
                                        </Border.StrokeShape>
                                        <Grid ColumnDefinitions="*,Auto">
                                            <HorizontalStackLayout Spacing="12">
                                                <Label Text="{Binding BabyTag}"
                                                       FontSize="14"
                                                       FontAttributes="Bold"
                                                       TextColor="{AppThemeBinding Light=#1E293B, Dark=#F8FAFC}"
                                                       VerticalOptions="Center" />
                                                <Label Text="{Binding Sex}"
                                                       FontSize="12"
                                                       TextColor="{AppThemeBinding Light=#64748B, Dark=#94A3B8}"
                                                       VerticalOptions="Center" />
                                                <Label FontSize="12"
                                                       TextColor="{AppThemeBinding Light=#64748B, Dark=#94A3B8}"
                                                       VerticalOptions="Center">
                                                    <Label.FormattedText>
                                                        <FormattedString>
                                                            <Span Text="{Binding BirthWeight, Converter={StaticResource GramsToKilogramsConverter}}" />
                                                            <Span Text=" kg" />
                                                        </FormattedString>
                                                    </Label.FormattedText>
                                                </Label>
                                            </HorizontalStackLayout>
                                            <Button Grid.Column="1"
                                                    Text="View"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ViewBabyDetailsCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="{StaticResource PrimaryBlue}"
                                                    TextColor="White"
                                                    HeightRequest="30"
                                                    CornerRadius="6"
                                                    FontSize="11"
                                                    Padding="10,4" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Border>

                <!-- Progress Bar -->
                <Border Style="{StaticResource ModernCardStyle}" Padding="12">
                    <VerticalStackLayout Spacing="8">
                        <HorizontalStackLayout Spacing="8">
                            <Label Text="Monitoring Progress"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light=#1E293B, Dark=#F8FAFC}" />
                            <Label Text="{Binding TimerDisplay}"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Purple}" />
                        </HorizontalStackLayout>
                        <ProgressBar Progress="{Binding ProgressValue}"
                                     ProgressColor="{StaticResource Purple}"
                                     HeightRequest="8" />
                        <HorizontalStackLayout HorizontalOptions="End" Spacing="8">
                            <Label Text="0 min"
                                   FontSize="10"
                                   TextColor="{AppThemeBinding Light=#94A3B8, Dark=#64748B}" />
                            <Label Text="120 min"
                                   FontSize="10"
                                   TextColor="{AppThemeBinding Light=#94A3B8, Dark=#64748B}" />
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                </Border>

                <!-- Action Button -->
                <Button Text="Complete Delivery &amp; Transfer to Postpartum Ward"
                        Command="{Binding CompleteDeliveryCommand}"
                        BackgroundColor="{StaticResource SuccessGreen}"
                        TextColor="White"
                        FontSize="15"
                        FontAttributes="Bold"
                        HeightRequest="54"
                        CornerRadius="12"
                        Margin="0,8,0,20"
                        IsEnabled="{Binding CanComplete}" />

            </VerticalStackLayout>
        </ScrollView>

        <!-- Popups -->
        <modals:BpPulsePopup x:Name="BpPulsePopup"
                             BindingContext="{Binding BPPulseModalPageModel}"
                             StaysOpen="True"
                             ShowCloseButton="True"
                             WidthRequest="320"
                             HeightRequest="600"
                             HeaderHeight="50" />

        <modals:TemperaturePopup x:Name="TemperaturePopup"
                                  BindingContext="{Binding TemperatureModalPageModel}"
                                  StaysOpen="True"
                                  ShowCloseButton="True"
                                  WidthRequest="320"
                                  HeightRequest="450"
                                  HeaderHeight="50" />

        <modals:VitalsTrendPopup x:Name="VitalsTrendPopup"
                                  BindingContext="{Binding .}"
                                  StaysOpen="True"
                                  ShowCloseButton="True"
                                  WidthRequest="360"
                                  HeightRequest="550"
                                  HeaderHeight="50" />

        <modals:CompletionChecklistPopup x:Name="CompletionChecklistPopup"
                                          BindingContext="{Binding CompletionChecklistPopupPageModel}"
                                          StaysOpen="True"
                                          ShowCloseButton="True"
                                          WidthRequest="450"
                                          HeightRequest="650"
                                          HeaderHeight="60" />

    </Grid>
</ContentPage>
