<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="MAAME.DROMO.PARTOGRAPH.APP.Droid.Pages.HomePage"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:sf="clr-namespace:Syncfusion.Maui.Toolkit.Charts;assembly=Syncfusion.Maui.Toolkit"
             xmlns:controls="clr-namespace:MAAME.DROMO.PARTOGRAPH.APP.Droid.Pages.Controls"
             xmlns:sfGauge="clr-namespace:Syncfusion.Maui.Gauges;assembly=Syncfusion.Maui.Gauges"
             xmlns:sfCards="clr-namespace:Syncfusion.Maui.Toolkit.Cards;assembly=Syncfusion.Maui.Toolkit"
             xmlns:models="clr-namespace:MAAME.DROMO.PARTOGRAPH.MODEL;assembly=MAAME.DROMO.PARTOGRAPH.MODEL"
             xmlns:pagemodels="clr-namespace:MAAME.DROMO.PARTOGRAPH.APP.Droid.PageModels"
             xmlns:views="clr-namespace:MAAME.DROMO.PARTOGRAPH.APP.Droid.Pages.Views"
             xmlns:converters="clr-namespace:MAAME.DROMO.PARTOGRAPH.APP.Droid.Converters"
             xmlns:tabView="http://schemas.syncfusion.com/maui"
             xmlns:fonts="clr-namespace:Fonts"
             Title="Partograph Dashboard"
             BackgroundColor="{AppThemeBinding Light=#F8FAFC, Dark=#0F172A}">

    <ContentPage.Behaviors>
        <toolkit:EventToCommandBehavior EventName="NavigatedTo" Command="{Binding NavigatedToCommand}" />
        <toolkit:EventToCommandBehavior EventName="Appearing" Command="{Binding AppearingCommand}" />
    </ContentPage.Behaviors>

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Converters -->
            <converters:SeverityToColorConverter x:Key="SeverityToColorConverter" />
            <converters:IsNotNullConverter x:Key="IsNotNullConverter" />

            <!-- Modern Card Style -->
            <Style x:Key="ModernCardStyle" TargetType="Border">
                <Setter Property="StrokeThickness" Value="0" />
                <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=White, Dark=#1E293B}" />
                <Setter Property="Padding" Value="24" />
                <Setter Property="StrokeShape">
                    <RoundRectangle CornerRadius="20" />
                </Setter>
                <Setter Property="Shadow">
                    <Shadow Brush="{AppThemeBinding Light=#10000000, Dark=#30000000}"
                            Offset="0,8"
                            Radius="24"
                            Opacity="0.15" />
                </Setter>
            </Style>

            <!-- Stat Card Style -->
            <Style x:Key="StatCardStyle" TargetType="sfCards:SfCardView">
                <Setter Property="CornerRadius" Value="8" />
                <Setter Property="BorderWidth" Value="0" />
                <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=White, Dark=#1E293B}" />
            </Style>

            <!-- Header Text Style -->
            <Style x:Key="HeaderStyle" TargetType="Label">
                <Setter Property="FontSize" Value="32" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light=#1E293B, Dark=#F8FAFC}" />
            </Style>

            <!-- Subheader Style -->
            <Style x:Key="SubheaderStyle" TargetType="Label">
                <Setter Property="FontSize" Value="16" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light=#64748B, Dark=#94A3B8}" />
                <Setter Property="Margin" Value="0,0,0,24" />
            </Style>

            <!-- Metric Number Style -->
            <Style x:Key="MetricNumberStyle" TargetType="Label">
                <Setter Property="FontSize" Value="28" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="Margin" Value="0,8,0,4" />
            </Style>

            <!-- Metric Label Style -->
            <Style x:Key="MetricLabelStyle" TargetType="Label">
                <Setter Property="FontSize" Value="12" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="Opacity" Value="0.8" />
                <Setter Property="Margin" Value="0,0,0,8" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <tabView:SfTabView x:Name="TabView" TabBarHeight="72" EnableSwiping="False" TabBarPlacement="Bottom">
        <tabView:SfTabItem Header="Home" ImagePosition="Top" ImageSource="home_svgrepo.png">
            <ScrollView>
                <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,*" Padding="20" RowSpacing="24">

                    <!-- Enhanced Header Section -->
                    <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                        <VerticalStackLayout VerticalOptions="Center">
                            <Label Text="Partograph Dashboard" Style="{StaticResource HeaderStyle}" />
                            <HorizontalStackLayout Spacing="12">
                                <Label Text="{Binding Today, StringFormat='{0:dddd, MMMM dd}'}"
                               Style="{StaticResource SubheaderStyle}" Margin="0,8" />
                                <Border BackgroundColor="#10B981" Padding="8,4" VerticalOptions="Center">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="12" />
                                    </Border.StrokeShape>
                                    <HorizontalStackLayout Spacing="4">
                                        <Ellipse Fill="#FFFFFF" WidthRequest="6" HeightRequest="6" />
                                        <Label Text="Live Monitoring"
                                       FontSize="12"
                                       FontAttributes="Bold"
                                       TextColor="White" />
                                    </HorizontalStackLayout>
                                </Border>
                            </HorizontalStackLayout>
                        </VerticalStackLayout>

                        <!-- Quick Action FAB -->
                        <controls:AddButton Grid.Column="1"
                                    BackgroundColor="#3B82F6"
                                    WidthRequest="64"
                                    HeightRequest="64"
                                    FontSize="24"
                                    ToolTipProperties.Text="Admit New Patient"
                                    Command="{Binding AddNewPatientCommand}" />
                    </Grid>

                    <!-- Quick Patient Search -->
                    <!--<Border Grid.Row="1" Style="{StaticResource ModernCardStyle}" Padding="16">
                        <Grid ColumnDefinitions="*,Auto">
                            <Entry Grid.Column="0"
                                   Placeholder="Quick search by name or hospital number..."
                                   Text="{Binding SearchQuery}"
                                   ReturnCommand="{Binding PerformQuickSearchCommand}"
                                   ClearButtonVisibility="WhileEditing"
                                   FontSize="14"
                                   VerticalOptions="Center" />
                            <Button Grid.Column="1"
                                    Text="Search"
                                    Command="{Binding PerformQuickSearchCommand}"
                                    BackgroundColor="#3B82F6"
                                    TextColor="White"
                                    Padding="16,8"
                                    Margin="8,0,0,0"
                                    CornerRadius="8" />
                        </Grid>
                    </Border>-->

                    <!-- Advanced Metrics Grid -->
                    <Grid Grid.Row="2" ColumnDefinitions="*,*" RowDefinitions="*,*" ColumnSpacing="4" RowSpacing="4">
                        <!-- Active Labor -->
                        <sfCards:SfCardView Grid.Column="0" Style="{StaticResource StatCardStyle}" Padding="8">
                            <Grid RowDefinitions="Auto,*,Auto" RowSpacing="8">
                                <Label Grid.Row="0" Text="ACTIVE LABOUR" Style="{StaticResource MetricLabelStyle}" TextColor="#10B981" />

                                <VerticalStackLayout Grid.Row="1" VerticalOptions="Center">
                                    <Label Text="{Binding DashboardStats.ActiveLabor}" 
                                   Style="{StaticResource MetricNumberStyle}"
                                   TextColor="#10B981" />
                                    <HorizontalStackLayout Spacing="4">
                                        <Label Text="â—" FontSize="8" TextColor="#10B981" VerticalOptions="Center" />
                                        <Label Text="Real-time monitoring"
                                       FontSize="11"
                                       TextColor="{AppThemeBinding Light=#64748B, Dark=#94A3B8}" />
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                            </Grid>
                            <sfCards:SfCardView.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding NavigateToActivePatientsCommand}" />
                            </sfCards:SfCardView.GestureRecognizers>
                        </sfCards:SfCardView>

                        <!-- Pre-Labor -->
                        <sfCards:SfCardView Grid.Column="1" Style="{StaticResource StatCardStyle}" Padding="8">
                            <Grid RowDefinitions="Auto,*,Auto" RowSpacing="8">
                                <Label Grid.Row="0" Text="PRE-LABOUR" Style="{StaticResource MetricLabelStyle}" TextColor="#F59E0B" />

                                <VerticalStackLayout Grid.Row="1" VerticalOptions="Center">
                                    <Label Text="{Binding DashboardStats.PendingLabor}" 
                                   Style="{StaticResource MetricNumberStyle}"
                                   TextColor="#F59E0B" />
                                    <HorizontalStackLayout Spacing="4">
                                        <Label Text="â–²" FontSize="12" TextColor="#10B981" VerticalOptions="Center" />
                                        <Label Text="+2 admissions today"
                                       FontSize="11"
                                       TextColor="{AppThemeBinding Light=#64748B, Dark=#94A3B8}" />
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                            </Grid>
                            <sfCards:SfCardView.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding NavigateToPendingPatientsCommand}" />
                            </sfCards:SfCardView.GestureRecognizers>
                        </sfCards:SfCardView>

                        <!-- Delivered Today -->
                        <sfCards:SfCardView Grid.Column="0" Grid.Row="1" Style="{StaticResource StatCardStyle}" Padding="8">
                            <Grid RowDefinitions="Auto,*,Auto" RowSpacing="8">
                                <Label Grid.Row="0" Text="DELIVERED" Style="{StaticResource MetricLabelStyle}" TextColor="#3B82F6" />

                                <VerticalStackLayout Grid.Row="1" VerticalOptions="Center">
                                    <Label Text="{Binding DashboardStats.CompletedToday}" 
                                   Style="{StaticResource MetricNumberStyle}"
                                   TextColor="#3B82F6" />
                                    <HorizontalStackLayout Spacing="4">
                                        <Label Text="â±" FontSize="10" VerticalOptions="Center" />
                                        <Label Text="{Binding DashboardStats.AvgDeliveryTime, StringFormat='Avg: {0}h'}"
                                       FontSize="11"
                                       TextColor="{AppThemeBinding Light=#64748B, Dark=#94A3B8}" />
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                            </Grid>
                            <sfCards:SfCardView.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding NavigateToCompletedPatientsCommand}" />
                            </sfCards:SfCardView.GestureRecognizers>
                        </sfCards:SfCardView>

                        <!-- Emergency Cases -->
                        <sfCards:SfCardView Grid.Column="1" Grid.Row="1" Style="{StaticResource StatCardStyle}" Padding="8">
                            <Grid RowDefinitions="Auto,*,Auto" RowSpacing="8">
                                <Label Grid.Row="0" Text="EMERGENCY" Style="{StaticResource MetricLabelStyle}" TextColor="#EF4444" />

                                <VerticalStackLayout Grid.Row="1" VerticalOptions="Center">
                                    <Label Text="{Binding DashboardStats.EmergencyCases}" 
                                   Style="{StaticResource MetricNumberStyle}"
                                   TextColor="#EF4444" />
                                    <HorizontalStackLayout Spacing="4">
                                        <Label Text="ðŸš¨" FontSize="10" VerticalOptions="Center" />
                                        <Label Text="Immediate attention"
                                       FontSize="11"
                                       TextColor="{AppThemeBinding Light=#64748B, Dark=#94A3B8}" />
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                            </Grid>
                            <sfCards:SfCardView.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding NavigateToEmergencyPatientsCommand}" />
                            </sfCards:SfCardView.GestureRecognizers>
                        </sfCards:SfCardView>
                    </Grid>

                    <!-- Critical Patients Preview Section -->
                    <Border Grid.Row="3" Style="{StaticResource ModernCardStyle}" Padding="20"
                            IsVisible="{Binding HasCriticalPatients}">
                        <VerticalStackLayout Spacing="16">
                            <Grid ColumnDefinitions="*,Auto">
                                <Label Grid.Column="0"
                                       Text="Critical Patients Requiring Attention"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light=#1E293B, Dark=#F8FAFC}" />
                                <Border Grid.Column="1"
                                        BackgroundColor="#EF4444"
                                        Padding="8,4"
                                        VerticalOptions="Center">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="12" />
                                    </Border.StrokeShape>
                                    <Label Text="{Binding DashboardStats.CriticalPatients.Count}"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="White" />
                                </Border>
                            </Grid>

                            <CollectionView ItemsSource="{Binding DashboardStats.CriticalPatients}"
                                            SelectionMode="None">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="models:CriticalPatientInfo">
                                        <Border StrokeThickness="1"
                                                Margin="0,4"
                                                Padding="12">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="8" />
                                            </Border.StrokeShape>
                                            <Border.Stroke>
                                                <SolidColorBrush Color="{Binding Severity, Converter={StaticResource SeverityToColorConverter}}" />
                                            </Border.Stroke>

                                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                                                <!-- Severity Indicator -->
                                                <Border Grid.Column="0"
                                                        WidthRequest="4"
                                                        HeightRequest="60"
                                                        VerticalOptions="Fill">
                                                    <Border.Background>
                                                        <SolidColorBrush Color="{Binding Severity, Converter={StaticResource SeverityToColorConverter}}" />
                                                    </Border.Background>
                                                </Border>

                                                <!-- Patient Info -->
                                                <VerticalStackLayout Grid.Column="1" Spacing="4" VerticalOptions="Center">
                                                    <Label Text="{Binding PatientName}"
                                                           FontSize="16"
                                                           FontAttributes="Bold" />
                                                    <Label Text="{Binding HospitalNumber, StringFormat='ID: {0}'}"
                                                           FontSize="12"
                                                           Opacity="0.7" />
                                                    <Label Text="{Binding ReasonForConcern}"
                                                           FontSize="13"
                                                           TextColor="#EF4444"
                                                           FontAttributes="Bold" />
                                                    <HorizontalStackLayout Spacing="12">
                                                        <Label Text="{Binding TimeInLabor, StringFormat='In labor: {0}'}"
                                                               FontSize="12"
                                                               Opacity="0.7" />
                                                        <Label Text="{Binding CurrentDilation, StringFormat='Dilation: {0}cm'}"
                                                               FontSize="12"
                                                               Opacity="0.7"
                                                               IsVisible="{Binding CurrentDilation, Converter={StaticResource IsNotNullConverter}}" />
                                                        <Label Text="{Binding LastFetalHeartRate, StringFormat='FHR: {0} bpm'}"
                                                               FontSize="12"
                                                               Opacity="0.7"
                                                               IsVisible="{Binding LastFetalHeartRate, Converter={StaticResource IsNotNullConverter}}" />
                                                    </HorizontalStackLayout>
                                                </VerticalStackLayout>

                                                <!-- Action Button -->
                                                <Button Grid.Column="2"
                                                        Text="View"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type pagemodels:HomePageModel}}, Path=NavigateToCriticalPatientCommand}"
                                                        CommandParameter="{Binding .}"
                                                        BackgroundColor="#3B82F6"
                                                        TextColor="White"
                                                        Padding="16,8"
                                                        CornerRadius="8"
                                                        VerticalOptions="Center" />
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Border>

                    <!-- Real-time Alerts Panel -->
                    <Border Grid.Row="4" Style="{StaticResource ModernCardStyle}" Padding="20"
                            IsVisible="{Binding HasAlerts}">
                        <VerticalStackLayout Spacing="16">
                            <Grid ColumnDefinitions="*,Auto">
                                <Label Grid.Column="0"
                                       Text="Active Alerts"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light=#1E293B, Dark=#F8FAFC}" />
                                <Border Grid.Column="1"
                                        BackgroundColor="#F59E0B"
                                        Padding="8,4"
                                        VerticalOptions="Center">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="12" />
                                    </Border.StrokeShape>
                                    <Label Text="{Binding DashboardStats.ActiveAlerts.Count}"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="White" />
                                </Border>
                            </Grid>

                            <CollectionView ItemsSource="{Binding DashboardStats.ActiveAlerts}"
                                            SelectionMode="None">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="models:PatientAlert">
                                        <Border BackgroundColor="{AppThemeBinding Light=#FEF3C7, Dark=#78350F}"
                                                Margin="0,4"
                                                Padding="12">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="8" />
                                            </Border.StrokeShape>

                                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                                                <!-- Alert Icon -->
                                                <Label Grid.Column="0"
                                                       Text="âš ï¸"
                                                       FontSize="24"
                                                       VerticalOptions="Center" />

                                                <!-- Alert Info -->
                                                <VerticalStackLayout Grid.Column="1" Spacing="4" VerticalOptions="Center">
                                                    <Label Text="{Binding PatientName}"
                                                           FontSize="14"
                                                           FontAttributes="Bold" />
                                                    <Label Text="{Binding AlertMessage}"
                                                           FontSize="13"
                                                           TextColor="#D97706" />
                                                    <Label Text="{Binding TimeAgo, StringFormat='{0} ago'}"
                                                           FontSize="11"
                                                           Opacity="0.7" />
                                                </VerticalStackLayout>

                                                <!-- Action Button -->
                                                <Button Grid.Column="2"
                                                        Text="View"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type pagemodels:HomePageModel}}, Path=NavigateToAlertPatientCommand}"
                                                        CommandParameter="{Binding .}"
                                                        BackgroundColor="#F59E0B"
                                                        TextColor="White"
                                                        Padding="12,6"
                                                        CornerRadius="8"
                                                        FontSize="12"
                                                        VerticalOptions="Center" />
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Border>

                    <!-- Enhanced Insights Section -->
                    <Border Grid.Row="5" Style="{StaticResource ModernCardStyle}" Padding="20">
                        <VerticalStackLayout Spacing="12">
                            <Label Text="Today's Insights"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light=#1E293B, Dark=#F8FAFC}" />

                            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                                <!-- Prolonged Labor -->
                                <VerticalStackLayout Grid.Column="0" Spacing="4">
                                    <Label Text="{Binding DashboardStats.ProlongedLaborCount}"
                                           FontSize="24"
                                           FontAttributes="Bold"
                                           TextColor="#F59E0B"
                                           HorizontalOptions="Center" />
                                    <Label Text="Prolonged Labour"
                                           FontSize="11"
                                           HorizontalOptions="Center"
                                           HorizontalTextAlignment="Center"
                                           Opacity="0.7" />
                                </VerticalStackLayout>

                                <!-- High Risk -->
                                <VerticalStackLayout Grid.Column="1" Spacing="4">
                                    <Label Text="{Binding DashboardStats.HighRiskCount}"
                                           FontSize="24"
                                           FontAttributes="Bold"
                                           TextColor="#EF4444"
                                           HorizontalOptions="Center" />
                                    <Label Text="High Risk"
                                           FontSize="11"
                                           HorizontalOptions="Center"
                                           HorizontalTextAlignment="Center"
                                           Opacity="0.7" />
                                </VerticalStackLayout>

                                <!-- Overdue Checks -->
                                <VerticalStackLayout Grid.Column="2" Spacing="4">
                                    <Label Text="{Binding DashboardStats.OverdueChecksCount}"
                                           FontSize="24"
                                           FontAttributes="Bold"
                                           TextColor="#8B5CF6"
                                           HorizontalOptions="Center" />
                                    <Label Text="Overdue Checks"
                                           FontSize="11"
                                           HorizontalOptions="Center"
                                           HorizontalTextAlignment="Center"
                                           Opacity="0.7" />
                                </VerticalStackLayout>
                            </Grid>

                            <BoxView HeightRequest="1" Color="{AppThemeBinding Light=#E5E7EB, Dark=#374151}" Margin="0,8" />

                            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                                <VerticalStackLayout Grid.Column="0" Spacing="4">
                                    <Label Text="Admissions Today"
                                           FontSize="12"
                                           HorizontalOptions="Center"
                                           Opacity="0.7" />
                                    <Label Text="{Binding DashboardStats.AdmissionsToday}"
                                           FontSize="20"
                                           FontAttributes="Bold"
                                           HorizontalOptions="Center"
                                           TextColor="#10B981" />
                                </VerticalStackLayout>

                                <VerticalStackLayout Grid.Column="1" Spacing="4">
                                    <Label Text="This Shift"
                                           FontSize="12"
                                           HorizontalOptions="Center"
                                           Opacity="0.7" />
                                    <Label Text="{Binding DashboardStats.AdmissionsThisShift}"
                                           FontSize="20"
                                           FontAttributes="Bold"
                                           HorizontalOptions="Center"
                                           TextColor="#3B82F6" />
                                </VerticalStackLayout>
                            </Grid>
                        </VerticalStackLayout>
                    </Border>

                </Grid>
            </ScrollView>
        </tabView:SfTabItem>
        
        <tabView:SfTabItem Header="Pending" ImageSource="pending_silent_mute_sound_audio_off_svgrepo.png">
            <views:PendingPatientsView x:Name="PendingPatients" Loaded="PendingPatients_Loaded" />
        </tabView:SfTabItem>

        <tabView:SfTabItem Header="Active" ImageSource="bell_active_svgrepo.png">
            <views:ActivePatientsView x:Name="ActivePatients" Loaded="ActivePatients_Loaded" />
        </tabView:SfTabItem>

        <tabView:SfTabItem Header="Completed" ImageSource="todo_done_svgrepo.png">
            <views:CompletedPatientsView x:Name="CompletedPatients" Loaded="CompletedPatients_Loaded" />
        </tabView:SfTabItem>
    </tabView:SfTabView>
    
</ContentPage>