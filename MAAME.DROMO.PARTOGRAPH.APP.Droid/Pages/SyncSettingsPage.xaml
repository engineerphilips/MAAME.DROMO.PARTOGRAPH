<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="MAAME.DROMO.PARTOGRAPH.APP.Droid.Pages.SyncSettingsPage"
             xmlns:pagemodels="clr-namespace:MAAME.DROMO.PARTOGRAPH.APP.Droid.PageModels"
             xmlns:converters="clr-namespace:MAAME.DROMO.PARTOGRAPH.APP.Droid.Converters"
             x:DataType="pagemodels:SyncSettingsPageModel"
             Title="Sync Settings">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
            <converters:BoolToTextConverter x:Key="BoolToTextConverter" />
            <converters:IntToBoolConverter x:Key="IntToBoolConverter" />
            <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
            <converters:PercentageToDecimalConverter x:Key="PercentageToDecimalConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <!--<ContentPage.Behaviors>
        <toolkit:EventToCommandBehavior EventName="Appearing" Command="{Binding AppearingCommand}" />
    </ContentPage.Behaviors>-->

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">

            <!-- Connection Status -->
            <Border StrokeThickness="1"
                    Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                    Background="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray900}}"
                    Padding="15"
                    StrokeShape="RoundRectangle 10">
                <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,Auto" RowSpacing="10">
                    <Label Text="Connection Status"
                           FontSize="18"
                           FontAttributes="Bold"
                           Grid.Row="0"
                           Grid.Column="0"/>

                    <HorizontalStackLayout Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" Spacing="5">
                        <Ellipse Fill="{Binding IsConnected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='Green|Red'}"
                                 WidthRequest="12"
                                 HeightRequest="12"/>
                        <Label Text="{Binding IsConnected, Converter={StaticResource BoolToTextConverter}, ConverterParameter='Online|Offline'}"
                               FontSize="14"/>
                    </HorizontalStackLayout>

                    <Label Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2">
                        <Label.FormattedText>
                            <FormattedString>
                                <Span Text="Last Sync: " />
                                <Span Text="{Binding LastSyncTime, StringFormat='{0:g}', TargetNullValue='Never'}" FontAttributes="Bold"/>
                            </FormattedString>
                        </Label.FormattedText>
                    </Label>
                </Grid>
            </Border>

            <!-- Sync Status -->
            <Border StrokeThickness="1"
                    Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                    Background="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray900}}"
                    Padding="15"
                    StrokeShape="RoundRectangle 10">
                <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto" RowSpacing="10">
                    <Label Text="Sync Status"
                           FontSize="18"
                           FontAttributes="Bold"
                           Grid.Row="0"/>

                    <HorizontalStackLayout Grid.Row="1" Spacing="10">
                        <Label Text="Status:" />
                        <Label Text="{Binding SyncStatus}" FontAttributes="Bold"/>
                    </HorizontalStackLayout>

                    <HorizontalStackLayout Grid.Row="2" Spacing="10">
                        <Label Text="Pending Changes:" />
                        <Label Text="{Binding PendingChanges}" FontAttributes="Bold" TextColor="Orange"/>
                    </HorizontalStackLayout>

                    <HorizontalStackLayout Grid.Row="3" Spacing="10">
                        <Label Text="Conflicts:" />
                        <Label Text="{Binding Conflicts}" FontAttributes="Bold" TextColor="Red"/>
                        <Button Text="View"
                                Command="{Binding ViewConflictsCommand}"
                                IsVisible="{Binding Conflicts, Converter={StaticResource IntToBoolConverter}}"
                                Padding="5"
                                FontSize="12"/>
                    </HorizontalStackLayout>

                    <ProgressBar Grid.Row="4"
                                 Progress="{Binding SyncProgressPercentage, Converter={StaticResource PercentageToDecimalConverter}}"
                                 IsVisible="{Binding IsSyncing}"/>
                </Grid>
            </Border>

            <!-- Manual Sync Button -->
            <Button Text="Sync Now"
                    Command="{Binding ManualSyncCommand}"
                    IsEnabled="{Binding IsSyncing, Converter={StaticResource InvertedBoolConverter}}"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="White"
                    Padding="15"
                    FontSize="16"
                    FontAttributes="Bold"/>

            <!-- API Configuration -->
            <Border StrokeThickness="1"
                    Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                    Background="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray900}}"
                    Padding="15"
                    StrokeShape="RoundRectangle 10">
                <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="15">
                    <Label Text="API Configuration"
                           FontSize="18"
                           FontAttributes="Bold"
                           Grid.Row="0"/>

                    <VerticalStackLayout Grid.Row="1" Spacing="5">
                        <Label Text="Server URL" FontSize="14"/>
                        <Entry Text="{Binding ApiUrl}"
                               Placeholder="https://api.partograph.example.com"
                               Keyboard="Url"/>
                    </VerticalStackLayout>

                    <Button Text="Test Connection"
                            Command="{Binding TestConnectionCommand}"
                            Grid.Row="2"
                            BackgroundColor="{StaticResource Secondary}"
                            TextColor="White"/>
                </Grid>
            </Border>

            <!-- Background Sync Settings -->
            <Border StrokeThickness="1"
                    Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                    Background="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray900}}"
                    Padding="15"
                    StrokeShape="RoundRectangle 10">
                <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="15">
                    <Label Text="Background Sync"
                           FontSize="18"
                           FontAttributes="Bold"
                           Grid.Row="0"/>

                    <HorizontalStackLayout Grid.Row="1" Spacing="10">
                        <Label Text="Enable Background Sync" VerticalOptions="Center"/>
                        <Switch IsToggled="{Binding BackgroundSyncEnabled}"/>
                    </HorizontalStackLayout>

                    <VerticalStackLayout Grid.Row="2" Spacing="5" IsVisible="{Binding BackgroundSyncEnabled}">
                        <Label Text="Sync Interval (minutes)" FontSize="14"/>
                        <Stepper Minimum="5"
                                 Maximum="120"
                                 Increment="5"
                                 Value="{Binding SyncIntervalMinutes}"/>
                        <Label Text="{Binding SyncIntervalMinutes, StringFormat='{0} minutes'}"
                               FontSize="12"
                               HorizontalOptions="Center"/>
                    </VerticalStackLayout>
                </Grid>
            </Border>

            <!-- Save Button -->
            <Button Text="Save Settings"
                    Command="{Binding SaveSettingsCommand}"
                    BackgroundColor="Green"
                    TextColor="White"
                    Padding="15"
                    FontSize="16"
                    FontAttributes="Bold"/>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
