<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:fonts="clr-namespace:Fonts"
             xmlns:pagemodels="clr-namespace:MAAME.DROMO.PARTOGRAPH.APP.Droid.PageModels"
             xmlns:services="clr-namespace:MAAME.DROMO.PARTOGRAPH.APP.Droid.Services"
             x:Class="MAAME.DROMO.PARTOGRAPH.APP.Droid.Pages.NotificationsPage"
             x:DataType="pagemodels:NotificationsPageModel"
             Title="Notifications"
             BackgroundColor="{AppThemeBinding Light=#F5F7FA, Dark=#121212}">

    <Grid RowDefinitions="Auto,Auto,*" RowSpacing="0">

        <!-- Header Section -->
        <Border Grid.Row="0"
                BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                Padding="16"
                Margin="0,0,0,1">
            <Border.Shadow>
                <Shadow Brush="#20000000" Offset="0,2" Radius="4" />
            </Border.Shadow>

            <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="12">

                <!-- Title and Action Buttons -->
                <Grid Grid.Row="0" ColumnDefinitions="*,Auto,Auto,Auto">
                    <VerticalStackLayout Grid.Column="0">
                        <Label Text="Notifications"
                               FontSize="24"
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light=#1A1A1A, Dark=#F5F5F5}" />
                        <Label Text="{Binding SummaryText}"
                               FontSize="14"
                               TextColor="{AppThemeBinding Light=#666, Dark=#AAA}" />
                        <Label Text="{Binding CurrentShiftInfo}"
                               FontSize="12"
                               TextColor="{AppThemeBinding Light=#999, Dark=#666}" />
                    </VerticalStackLayout>

                    <!-- Shift Report Button -->
                    <Button Grid.Column="1"
                            Text="Shift Report"
                            Command="{Binding ViewShiftReportCommand}"
                            BackgroundColor="{AppThemeBinding Light=#E8F5E9, Dark=#1B3D26}"
                            TextColor="#4CAF50"
                            FontSize="11"
                            Padding="10,6"
                            CornerRadius="8"
                            Margin="0,0,6,0" />

                    <!-- Acknowledge All Button -->
                    <Button Grid.Column="2"
                            Text="Ack All"
                            Command="{Binding AcknowledgeAllCommand}"
                            BackgroundColor="{AppThemeBinding Light=#E3F2FD, Dark=#1E3A5F}"
                            TextColor="#2196F3"
                            FontSize="11"
                            Padding="10,6"
                            CornerRadius="8"
                            IsVisible="{Binding HasNotifications}"
                            Margin="0,0,6,0" />

                    <!-- Clear Button -->
                    <Button Grid.Column="3"
                            Text="Clear"
                            Command="{Binding ClearAcknowledgedCommand}"
                            BackgroundColor="{AppThemeBinding Light=#FFEBEE, Dark=#3D1F1F}"
                            TextColor="#EF5350"
                            FontSize="11"
                            Padding="10,6"
                            CornerRadius="8" />
                </Grid>

                <!-- Stats Cards -->
                <Grid Grid.Row="1" ColumnDefinitions="*,*,*,*,*" ColumnSpacing="6">

                    <!-- Total Count -->
                    <Border Grid.Column="0"
                            BackgroundColor="{AppThemeBinding Light=#F5F7FA, Dark=#2A2A2A}"
                            Padding="8,6">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="8" />
                        </Border.StrokeShape>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding FilterCommand}" CommandParameter="All" />
                        </Border.GestureRecognizers>
                        <VerticalStackLayout HorizontalOptions="Center">
                            <Label Text="{Binding TotalCount}"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light=#1A1A1A, Dark=#F5F5F5}"
                                   HorizontalOptions="Center" />
                            <Label Text="Total"
                                   FontSize="10"
                                   TextColor="{AppThemeBinding Light=#666, Dark=#AAA}"
                                   HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </Border>

                    <!-- Critical Count -->
                    <Border Grid.Column="1"
                            BackgroundColor="{AppThemeBinding Light=#FFEBEE, Dark=#3D1F1F}"
                            Padding="8,6">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="8" />
                        </Border.StrokeShape>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding FilterCommand}" CommandParameter="Critical" />
                        </Border.GestureRecognizers>
                        <VerticalStackLayout HorizontalOptions="Center">
                            <Label Text="{Binding CriticalCount}"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="#EF5350"
                                   HorizontalOptions="Center" />
                            <Label Text="Critical"
                                   FontSize="10"
                                   TextColor="#EF5350"
                                   HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </Border>

                    <!-- Warning Count -->
                    <Border Grid.Column="2"
                            BackgroundColor="{AppThemeBinding Light=#FFF3E0, Dark=#3D2E1B}"
                            Padding="8,6">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="8" />
                        </Border.StrokeShape>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding FilterCommand}" CommandParameter="Warning" />
                        </Border.GestureRecognizers>
                        <VerticalStackLayout HorizontalOptions="Center">
                            <Label Text="{Binding WarningCount}"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="#FF9800"
                                   HorizontalOptions="Center" />
                            <Label Text="Warning"
                                   FontSize="10"
                                   TextColor="#FF9800"
                                   HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </Border>

                    <!-- Escalated Count -->
                    <Border Grid.Column="3"
                            BackgroundColor="{AppThemeBinding Light=#F3E5F5, Dark=#2D1B3D}"
                            Padding="8,6">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="8" />
                        </Border.StrokeShape>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding FilterCommand}" CommandParameter="Escalated" />
                        </Border.GestureRecognizers>
                        <VerticalStackLayout HorizontalOptions="Center">
                            <Label Text="{Binding EscalatedCount}"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="#9C27B0"
                                   HorizontalOptions="Center" />
                            <Label Text="Escalated"
                                   FontSize="10"
                                   TextColor="#9C27B0"
                                   HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </Border>

                    <!-- Info/Due Count -->
                    <Border Grid.Column="4"
                            BackgroundColor="{AppThemeBinding Light=#E3F2FD, Dark=#1E3A5F}"
                            Padding="8,6">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="8" />
                        </Border.StrokeShape>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding FilterCommand}" CommandParameter="Due" />
                        </Border.GestureRecognizers>
                        <VerticalStackLayout HorizontalOptions="Center">
                            <Label Text="{Binding InfoCount}"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="#2196F3"
                                   HorizontalOptions="Center" />
                            <Label Text="Due Soon"
                                   FontSize="10"
                                   TextColor="#2196F3"
                                   HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </Border>
                </Grid>

                <!-- Filter Pills -->
                <ScrollView Grid.Row="2" Orientation="Horizontal" HorizontalScrollBarVisibility="Never">
                    <HorizontalStackLayout Spacing="8">

                        <Border BackgroundColor="{Binding FilterAllSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#2196F3|#E0E0E0'}"
                                Padding="12,6">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="16" />
                            </Border.StrokeShape>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding FilterCommand}" CommandParameter="All" />
                            </Border.GestureRecognizers>
                            <Label Text="All"
                                   FontSize="13"
                                   TextColor="{Binding FilterAllSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='White|#666'}" />
                        </Border>

                        <Border BackgroundColor="{Binding FilterCriticalSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#EF5350|#E0E0E0'}"
                                Padding="12,6">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="16" />
                            </Border.StrokeShape>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding FilterCommand}" CommandParameter="Critical" />
                            </Border.GestureRecognizers>
                            <Label Text="Critical"
                                   FontSize="13"
                                   TextColor="{Binding FilterCriticalSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='White|#666'}" />
                        </Border>

                        <Border BackgroundColor="{Binding FilterWarningSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#FF9800|#E0E0E0'}"
                                Padding="12,6">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="16" />
                            </Border.StrokeShape>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding FilterCommand}" CommandParameter="Warning" />
                            </Border.GestureRecognizers>
                            <Label Text="Warning"
                                   FontSize="13"
                                   TextColor="{Binding FilterWarningSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='White|#666'}" />
                        </Border>

                        <Border BackgroundColor="{Binding FilterEscalatedSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#9C27B0|#E0E0E0'}"
                                Padding="12,6">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="16" />
                            </Border.StrokeShape>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding FilterCommand}" CommandParameter="Escalated" />
                            </Border.GestureRecognizers>
                            <Label Text="Escalated"
                                   FontSize="13"
                                   TextColor="{Binding FilterEscalatedSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='White|#666'}" />
                        </Border>

                        <Border BackgroundColor="{Binding FilterDueSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#2196F3|#E0E0E0'}"
                                Padding="12,6">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="16" />
                            </Border.StrokeShape>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding FilterCommand}" CommandParameter="Due" />
                            </Border.GestureRecognizers>
                            <Label Text="Measurements Due"
                                   FontSize="13"
                                   TextColor="{Binding FilterDueSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='White|#666'}" />
                        </Border>
                    </HorizontalStackLayout>
                </ScrollView>
            </Grid>
        </Border>

        <!-- Empty State -->
        <Border Grid.Row="2"
                IsVisible="{Binding HasNoNotifications}"
                BackgroundColor="Transparent"
                Padding="32">
            <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="16">
                <Label Text="&#xF115;"
                       FontFamily="{x:Static fonts:FluentUI.FontFamily}"
                       FontSize="64"
                       TextColor="{AppThemeBinding Light=#BDBDBD, Dark=#424242}"
                       HorizontalOptions="Center" />
                <Label Text="No Active Notifications"
                       FontSize="18"
                       FontAttributes="Bold"
                       TextColor="{AppThemeBinding Light=#666, Dark=#AAA}"
                       HorizontalOptions="Center" />
                <Label Text="All partographs are up to date with their measurements. You'll be notified when any measurement becomes due."
                       FontSize="14"
                       TextColor="{AppThemeBinding Light=#999, Dark=#666}"
                       HorizontalOptions="Center"
                       HorizontalTextAlignment="Center"
                       MaximumWidthRequest="300" />

                <Button Text="Refresh"
                        Command="{Binding RefreshCommand}"
                        BackgroundColor="#2196F3"
                        TextColor="White"
                        Padding="24,12"
                        CornerRadius="8"
                        Margin="0,16,0,0" />
            </VerticalStackLayout>
        </Border>

        <!-- Notifications List -->
        <RefreshView Grid.Row="2"
                     IsRefreshing="{Binding IsRefreshing}"
                     Command="{Binding RefreshCommand}"
                     IsVisible="{Binding HasNotifications}">
            <CollectionView ItemsSource="{Binding Notifications}"
                            Margin="0,8,0,0">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="services:NotificationItem">
                        <Border Margin="12,4"
                                Padding="12"
                                BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                                Opacity="{Binding IsAcknowledged, Converter={StaticResource BoolToOpacityConverter}}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12" />
                            </Border.StrokeShape>
                            <Border.Shadow>
                                <Shadow Brush="#10000000" Offset="0,2" Radius="4" />
                            </Border.Shadow>

                            <Grid RowDefinitions="Auto,Auto" RowSpacing="8">

                                <!-- Main Content Row -->
                                <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="10">

                                    <!-- Severity Icon -->
                                    <Grid Grid.Column="0" WidthRequest="44" HeightRequest="44">
                                        <Border WidthRequest="44"
                                                HeightRequest="44"
                                                BackgroundColor="{Binding SeverityColor}"
                                                Opacity="0.15">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="22" />
                                            </Border.StrokeShape>
                                        </Border>
                                        <Label Text="{Binding SeverityIcon}"
                                               FontSize="22"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center" />

                                        <!-- Escalation Badge -->
                                        <Border IsVisible="{Binding IsEscalated}"
                                                WidthRequest="20"
                                                HeightRequest="16"
                                                BackgroundColor="#9C27B0"
                                                HorizontalOptions="End"
                                                VerticalOptions="Start"
                                                Margin="0,-2,-4,0">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="4" />
                                            </Border.StrokeShape>
                                            <Label Text="{Binding EscalationBadge}"
                                                   FontSize="8"
                                                   FontAttributes="Bold"
                                                   TextColor="White"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center" />
                                        </Border>
                                    </Grid>

                                    <!-- Content -->
                                    <VerticalStackLayout Grid.Column="1" Spacing="2">
                                        <!-- Title -->
                                        <Label Text="{Binding Title}"
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               TextColor="{Binding SeverityColor}"
                                               LineBreakMode="TailTruncation" />

                                        <!-- Patient Name -->
                                        <Label Text="{Binding PatientName}"
                                               FontSize="13"
                                               FontAttributes="Bold"
                                               TextColor="{AppThemeBinding Light=#333, Dark=#CCC}"
                                               IsVisible="{Binding PatientName, Converter={StaticResource StringToBoolConverter}}" />

                                        <!-- Message -->
                                        <Label Text="{Binding Message}"
                                               FontSize="12"
                                               TextColor="{AppThemeBinding Light=#666, Dark=#AAA}"
                                               LineBreakMode="WordWrap"
                                               MaxLines="2" />

                                        <!-- Time Ago -->
                                        <Label Text="{Binding TimeAgo}"
                                               FontSize="10"
                                               TextColor="{AppThemeBinding Light=#999, Dark=#666}" />
                                    </VerticalStackLayout>

                                    <!-- Actions Column -->
                                    <VerticalStackLayout Grid.Column="2" Spacing="6" VerticalOptions="Center">
                                        <!-- Acknowledge Button -->
                                        <Button WidthRequest="36"
                                                HeightRequest="36"
                                                CornerRadius="18"
                                                BackgroundColor="{AppThemeBinding Light=#E8F5E9, Dark=#1B3D26}"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type pagemodels:NotificationsPageModel}}, Path=AcknowledgeCommand}"
                                                CommandParameter="{Binding}"
                                                IsVisible="{Binding IsAcknowledged, Converter={StaticResource InverseBoolConverter}}"
                                                ToolTipProperties.Text="Acknowledge">
                                            <Button.ImageSource>
                                                <FontImageSource FontFamily="{x:Static fonts:FluentUI.FontFamily}"
                                                                 Glyph="&#xE73E;"
                                                                 Color="#4CAF50"
                                                                 Size="18" />
                                            </Button.ImageSource>
                                        </Button>

                                        <!-- Acknowledged Indicator -->
                                        <Label Text="&#xE73E;"
                                               FontFamily="{x:Static fonts:FluentUI.FontFamily}"
                                               FontSize="18"
                                               TextColor="#4CAF50"
                                               IsVisible="{Binding IsAcknowledged}"
                                               HorizontalOptions="Center" />
                                    </VerticalStackLayout>
                                </Grid>

                                <!-- Quick Action Row -->
                                <Grid Grid.Row="1"
                                      ColumnDefinitions="*,Auto"
                                      IsVisible="{Binding ShowQuickAction}">

                                    <!-- Quick Action Button -->
                                    <Button Grid.Column="0"
                                            Text="Record Now"
                                            BackgroundColor="#2196F3"
                                            TextColor="White"
                                            FontSize="13"
                                            FontAttributes="Bold"
                                            HeightRequest="36"
                                            CornerRadius="8"
                                            Margin="0,0,8,0"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type pagemodels:NotificationsPageModel}}, Path=QuickActionCommand}"
                                            CommandParameter="{Binding}"
                                            IsVisible="{Binding IsAcknowledged, Converter={StaticResource InverseBoolConverter}}">
                                        <Button.ImageSource>
                                            <FontImageSource FontFamily="{x:Static fonts:FluentUI.FontFamily}"
                                                             Glyph="&#xE710;"
                                                             Color="White"
                                                             Size="16" />
                                        </Button.ImageSource>
                                    </Button>

                                    <!-- View Partograph Button -->
                                    <Button Grid.Column="1"
                                            Text="View"
                                            BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2A2A2A}"
                                            TextColor="{AppThemeBinding Light=#666, Dark=#AAA}"
                                            FontSize="13"
                                            HeightRequest="36"
                                            WidthRequest="70"
                                            CornerRadius="8"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type pagemodels:NotificationsPageModel}}, Path=NavigateToPartographCommand}"
                                            CommandParameter="{Binding}"
                                            IsVisible="{Binding PartographId, Converter={StaticResource NullToBoolConverter}}" />
                                </Grid>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>
    </Grid>
</ContentPage>
