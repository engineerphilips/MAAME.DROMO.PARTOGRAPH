@page "/live-labor"
@attribute [Authorize]
@inject MAAME.DROMO.PARTOGRAPH.MONITORING.Services.ILiveLaborService LiveLaborService
@inject MAAME.DROMO.PARTOGRAPH.MONITORING.Services.IEnhancedAlertService AlertService
@inject NavigationManager Navigation
@implements IAsyncDisposable
@using Microsoft.AspNetCore.SignalR.Client
@using MAAME.DROMO.PARTOGRAPH.MONITORING.Services
@using MAAME.DROMO.PARTOGRAPH.MONITORING.Models

<PageTitle>Live labour Board - MAAME DROMO Monitoring</PageTitle>

<div class="dashboard-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2 class="mb-1 text-gradient-primary fw-bold">
                <i class="bi bi-activity me-2"></i>
                Live Labour Board
            </h2>
            <p class="text-secondary mb-0">
                Real-time active labour monitoring |
                <span class="@(isConnected ? "text-success" : "text-danger") fw-medium">
                    <i class="bi @(isConnected ? "bi-wifi" : "bi-wifi-off") me-1"></i>
                    @(isConnected ? "Connected" : "Disconnected")
                </span>
                | Last updated: @lastUpdated.ToString("HH:mm:ss")
            </p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-white border shadow-sm hover-lift" @onclick="RefreshData" disabled="@isLoading">
                <i class="bi bi-arrow-clockwise me-1 @(isLoading ? "spin" : "")"></i> Refresh
            </button>
            <div class="btn-group shadow-sm rounded-pill">
                <button class="btn @(autoRefresh ? "btn-success" : "btn-white border")" @onclick="ToggleAutoRefresh">
                    <i class="bi bi-play-circle me-1"></i> Auto @(autoRefresh ? "On" : "Off")
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-2">
        <div class="stat-card p-3 h-100 position-relative hover-lift text-center">
            <div class="icon-box bg-primary-subtle text-primary rounded-circle mx-auto mb-2 p-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-people-fill fs-5"></i>
            </div>
            <h3 class="mb-0 fw-bold text-dark">@summary.TotalActiveCases</h3>
            <small class="text-secondary text-uppercase fw-bold" style="font-size: 0.65rem;">Active Cases</small>
        </div>
    </div>
    <div class="col-md-2">
        <div class="stat-card p-3 h-100 position-relative hover-lift text-center border-bottom border-4 border-danger">
            <div class="icon-box bg-danger-subtle text-danger rounded-circle mx-auto mb-2 p-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-exclamation-triangle-fill fs-5"></i>
            </div>
            <h3 class="mb-0 fw-bold text-danger">@summary.CriticalCases</h3>
            <small class="text-secondary text-uppercase fw-bold" style="font-size: 0.65rem;">Critical</small>
        </div>
    </div>
    <div class="col-md-2">
        <div class="stat-card p-3 h-100 position-relative hover-lift text-center border-bottom border-4 border-warning">
            <div class="icon-box bg-warning-subtle text-warning rounded-circle mx-auto mb-2 p-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-cone-striped fs-5"></i>
            </div>
            <h3 class="mb-0 fw-bold text-dark">@summary.HighRiskCases</h3>
            <small class="text-secondary text-uppercase fw-bold" style="font-size: 0.65rem;">High Risk</small>
        </div>
    </div>
    <div class="col-md-2">
        <div class="stat-card p-3 h-100 position-relative hover-lift text-center">
            <div class="icon-box bg-info-subtle text-info rounded-circle mx-auto mb-2 p-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-info-circle-fill fs-5"></i>
            </div>
            <h3 class="mb-0 fw-bold text-dark">@summary.ModerateRiskCases</h3>
            <small class="text-secondary text-uppercase fw-bold" style="font-size: 0.65rem;">Moderate</small>
        </div>
    </div>
    <div class="col-md-2">
        <div class="stat-card p-3 h-100 position-relative hover-lift text-center">
            <div class="icon-box bg-success-subtle text-success rounded-circle mx-auto mb-2 p-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-check-circle-fill fs-5"></i>
            </div>
            <h3 class="mb-0 fw-bold text-dark">@summary.NormalCases</h3>
            <small class="text-secondary text-uppercase fw-bold" style="font-size: 0.65rem;">Normal</small>
        </div>
    </div>
    <div class="col-md-2">
        <div class="stat-card p-3 h-100 position-relative hover-lift text-center">
            <div class="icon-box bg-secondary-subtle text-secondary rounded-circle mx-auto mb-2 p-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-stopwatch-fill fs-5"></i>
            </div>
            <h3 class="mb-0 fw-bold text-dark">@summary.MeasurementsDue</h3>
            <small class="text-secondary text-uppercase fw-bold" style="font-size: 0.65rem;">Due Now</small>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="glass-panel p-4 mb-4">
    <div class="row align-items-center g-3">
        <div class="col-auto">
            <span class="text-secondary fw-bold small text-uppercase">Filter by:</span>
        </div>
        <div class="col-auto">
            <div class="btn-group shadow-sm rounded-pill overflow-hidden">
                <button class="btn btn-sm @(riskFilter == "All" ? "btn-primary" : "btn-white border")" @onclick='() => SetRiskFilter("All")'>All Active</button>
                <button class="btn btn-sm @(riskFilter == "Critical" ? "btn-danger" : "btn-white border")" @onclick='() => SetRiskFilter("Critical")'>
                    <i class="bi bi-exclamation-octagon me-1"></i>Critical
                </button>
                <button class="btn btn-sm @(riskFilter == "High" ? "btn-warning" : "btn-white border")" @onclick='() => SetRiskFilter("High")'>High Risk</button>
                <button class="btn btn-sm @(riskFilter == "MeasurementsDue" ? "btn-secondary" : "btn-white border")" @onclick='() => SetRiskFilter("MeasurementsDue")'>
                    <i class="bi bi-stopwatch me-1"></i>Actions Due
                </button>
            </div>
        </div>
        <div class="col">
            <div class="input-group shadow-sm">
                <span class="input-group-text bg-white border-end-0 text-muted">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" class="form-control border-start-0 ps-0" 
                       placeholder="Search patient name, ID, or facility..." 
                       @bind="searchTerm" @bind:event="oninput" />
            </div>
        </div>
    </div>
</div>

<!-- labour Cases Grid -->
@if (isLoading && laborCases.Count == 0)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-secondary">Loading active labour cases...</p>
    </div>
}
else if (!filteredCases.Any())
{
    <div class="glass-panel p-5 text-center">
        <div class="icon-box bg-light rounded-circle mx-auto mb-3 text-secondary" style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
            <i class="bi bi-search fs-3"></i>
        </div>
        <h5 class="fw-bold text-dark">No Active Cases Found</h5>
        <p class="text-secondary">No active labour cases match your current filter criteria.</p>
        <button class="btn btn-outline-primary rounded-pill" @onclick='() => SetRiskFilter("All")'>
            Clear Filters
        </button>
    </div>
}
else
{
    <div class="row g-4">
        @foreach (var laborCase in filteredCases)
        {
            <div class="col-md-6 col-lg-4">
                <div class="glass-panel h-100 hover-lift position-relative overflow-hidden p-0 labor-card @GetCardClass(laborCase.RiskLevel)">
                    <!-- Header with risk indicator -->
                    <div class="p-4 border-bottom border-light bg-white bg-opacity-50">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="d-flex align-items-center">
                                <div class="risk-indicator @GetRiskClass(laborCase.RiskLevel) shadow-sm"></div>
                                <div class="ms-3">
                                    <h6 class="mb-0 fw-bold text-dark">@laborCase.PatientName</h6>
                                    <small class="text-secondary font-monospace">@laborCase.HospitalNumber</small>
                                </div>
                            </div>
                            <span class="badge rounded-pill @GetRiskBadgeClass(laborCase.RiskLevel) shadow-sm">
                                @laborCase.RiskLevel
                            </span>
                        </div>
                    </div>

                    <div class="p-4">
                        <!-- Patient Info -->
                        <div class="d-flex gap-3 mb-4 small text-secondary">
                            <div class="d-flex align-items-center bg-white px-2 py-1 rounded border shadow-sm">
                                <i class="bi bi-person me-2 text-primary"></i>
                                <span class="fw-medium">@laborCase.Age yrs</span>
                            </div>
                            <div class="d-flex align-items-center bg-white px-2 py-1 rounded border shadow-sm">
                                <i class="bi bi-clipboard me-2 text-info"></i>
                                <span class="fw-medium">@laborCase.Gravida @laborCase.Parity</span>
                            </div>
                        </div>

                        <!-- Labor Progress -->
                        <div class="bg-light-subtle rounded-3 p-3 mb-4 border border-light shadow-inner">
                            <div class="d-flex justify-content-between mb-2">
                                <small class="text-secondary text-uppercase fw-bold" style="font-size: 0.7rem;">Cervical Dilatation</small>
                                <small class="fw-bold text-primary">@laborCase.CurrentDilatation cm</small>
                            </div>
                            <div class="progress shadow-sm" style="height: 8px; border-radius: 4px; background-color: #e9ecef;">
                                <div class="progress-bar @GetProgressBarClass(laborCase.RiskLevel) progress-bar-striped progress-bar-animated"
                                     style="width: @(laborCase.CurrentDilatation * 10)%"></div>
                            </div>
                            <div class="d-flex justify-content-between mt-3 small text-secondary">
                                <span class="badge bg-white text-dark border">
                                    <i class="bi bi-arrow-right-circle me-1"></i>@laborCase.LaborStage
                                </span>
                                <span class="badge bg-white text-dark border">
                                    <i class="bi bi-geo me-1"></i>Station: @laborCase.CurrentStation
                                </span>
                            </div>
                        </div>

                        <!-- Vitals Grid -->
                        <div class="row g-2 mb-4">
                            <div class="col-4">
                                <div class="p-2 rounded-3 text-center border h-100 d-flex flex-column justify-content-center @(IsVitalCritical(laborCase.LatestFHR, "FHR") ? "bg-danger-subtle border-danger text-danger" : "bg-white border-light shadow-sm")">
                                    <small class="d-block text-uppercase text-secondary mb-1" style="font-size: 0.6rem;">FHR (bpm)</small>
                                    <div class="fw-bold fs-5">@laborCase.LatestFHR</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="p-2 rounded-3 text-center border h-100 d-flex flex-column justify-content-center @(IsVitalCritical(laborCase.LatestSystolicBP, "BP") ? "bg-danger-subtle border-danger text-danger" : "bg-white border-light shadow-sm")">
                                    <small class="d-block text-uppercase text-secondary mb-1" style="font-size: 0.6rem;">BP (mmHg)</small>
                                    <div class="fw-bold fs-5">@laborCase.LatestSystolicBP/@laborCase.LatestDiastolicBP</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="p-2 rounded-3 text-center border h-100 d-flex flex-column justify-content-center bg-white border-light shadow-sm">
                                    <small class="d-block text-uppercase text-secondary mb-1" style="font-size: 0.6rem;">Contractions</small>
                                    <div class="fw-bold fs-5">@laborCase.ContractionsPerTenMinutes<span class="fs-6 text-muted fw-normal">/10'</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- Smart Clinical Alerts -->
                        @if (laborCase.ClinicalAlerts.Any())
                        {
                            <div class="mb-4">
                                @foreach (var alert in laborCase.ClinicalAlerts.Take(2))
                                {
                                    <div class="d-flex align-items-start small mb-2 p-2 rounded border @GetAlertBgClass(alert.Severity)">
                                        <i class="@GetAlertIcon(alert.Severity) me-2 mt-1"></i>
                                        <div class="overflow-hidden">
                                            <div class="fw-bold text-truncate">@alert.Title</div>
                                            <div class="text-truncate opacity-75">@alert.Message</div>
                                            @if(!string.IsNullOrEmpty(alert.Recommendation)) {
                                                <div class="mt-1 fst-italic opacity-75 border-top border-opacity-10 pt-1" style="font-size: 0.75em">
                                                    <i class="bi bi-lightbulb me-1"></i>@alert.Recommendation
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else if (laborCase.ActiveAlerts.Any())
                        {
                            <div class="mb-4">
                                @foreach (var alert in laborCase.ActiveAlerts.Take(2))
                                {
                                    <div class="d-flex align-items-center text-danger small mb-2 p-2 bg-danger-subtle rounded border border-danger-subtle">
                                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                        <span class="text-truncate fw-medium">@alert</span>
                                    </div>
                                }
                            </div>
                        }

                        <!-- Footer info -->
                        <div class="d-flex justify-content-between align-items-center mt-auto pt-3 border-top border-light">
                             <div class="d-flex align-items-center text-muted small">
                                <div class="avatar-circle-sm bg-primary-subtle text-primary fw-bold me-2 d-flex align-items-center justify-content-center rounded-circle" style="width:28px;height:28px;font-size:11px;">
                                    @laborCase.AssignedMidwife.Substring(0, 1)
                                </div>
                                <span class="text-truncate fw-medium" style="max-width: 120px;">@laborCase.AssignedMidwife</span>
                            </div>
                            <button class="btn btn-sm btn-primary px-3 rounded-pill shadow-sm hover-lift" @onclick="() => ViewDetails(laborCase.PartographId)">
                                View Details <i class="bi bi-arrow-right ms-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

<style>
    .spin { animation: spin 1s linear infinite; }
    @@keyframes spin { 100% { transform: rotate(360deg); } }

    .labor-card {
        transition: all 0.3s ease;
        border-top: 4px solid transparent;
    }
    
    .labor-card.risk-critical { border-top-color: #ef4444; background: linear-gradient(to bottom, rgba(239, 68, 68, 0.05), rgba(255,255,255,0.8)); }
    .labor-card.risk-high { border-top-color: #f59e0b; background: linear-gradient(to bottom, rgba(245, 158, 11, 0.05), rgba(255,255,255,0.8)); }
    .labor-card.risk-moderate { border-top-color: #0ea5e9; }
    .labor-card.risk-normal { border-top-color: #10b981; }

    .risk-indicator {
        width: 12px; height: 12px; border-radius: 50%;
        box-shadow: 0 0 0 2px rgba(255,255,255,1);
    }
    .risk-indicator.critical { background: #ef4444; animation: pulse-red 2s infinite; }
    .risk-indicator.high { background: #f59e0b; animation: pulse-orange 2s infinite; }
    .risk-indicator.moderate { background: #0ea5e9; }
    .risk-indicator.normal { background: #10b981; }

    @@keyframes pulse-red {
        0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
        70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
        100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
    @@keyframes pulse-orange {
        0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
        70% { box-shadow: 0 0 0 6px rgba(245, 158, 11, 0); }
        100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
    }
</style>

@code {
    private HubConnection? hubConnection;
    private bool isConnected = false;
    private bool isLoading = true;
    private bool autoRefresh = true;
    private DateTime lastUpdated = DateTime.Now;
    private string searchTerm = "";
    private string riskFilter = "All";
    private System.Timers.Timer? refreshTimer;

    private LiveLaborSummary summary = new();
    private List<LiveLaborCase> laborCases = new();

    private IEnumerable<LiveLaborCase> filteredCases => laborCases
        .Where(c => riskFilter == "All" ||
                    (riskFilter == "Critical" && c.RiskLevel == "Critical") ||
                    (riskFilter == "High" && (c.RiskLevel == "High" || c.RiskLevel == "Critical")) ||
                    (riskFilter == "MeasurementsDue" && (c.IsFHRDue || c.IsBPDue || c.IsDilatationDue)))
        .Where(c => string.IsNullOrEmpty(searchTerm) ||
                    c.PatientName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    c.FacilityName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    c.HospitalNumber.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        await SetupSignalR();
        SetupAutoRefresh();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            var summaryTask = LiveLaborService.GetLiveLaborSummaryAsync();
            var casesTask = LiveLaborService.GetActiveLaborCasesAsync();

            await Task.WhenAll(summaryTask, casesTask);

            summary = await summaryTask;
            laborCases = await casesTask;
            lastUpdated = DateTime.Now;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task SetupSignalR()
    {
        try
        {
            hubConnection = new HubConnectionBuilder()
                .WithUrl(Navigation.ToAbsoluteUri("/monitoringhub"))
                .WithAutomaticReconnect()
                .Build();

            hubConnection.On<LiveLaborCase>("LaborUpdate", async (laborCase) =>
            {
                var existingIndex = laborCases.FindIndex(c => c.PartographId == laborCase.PartographId);
                if (existingIndex >= 0)
                    laborCases[existingIndex] = laborCase;
                else
                    laborCases.Add(laborCase);

                lastUpdated = DateTime.Now;
                await InvokeAsync(StateHasChanged);
            });

            hubConnection.On<LiveLaborSummary>("SummaryUpdate", async (newSummary) =>
            {
                summary = newSummary;
                lastUpdated = DateTime.Now;
                await InvokeAsync(StateHasChanged);
            });

            hubConnection.Reconnecting += (ex) =>
            {
                isConnected = false;
                InvokeAsync(StateHasChanged);
                return Task.CompletedTask;
            };

            hubConnection.Reconnected += (connectionId) =>
            {
                isConnected = true;
                InvokeAsync(StateHasChanged);
                return Task.CompletedTask;
            };

            await hubConnection.StartAsync();
            isConnected = true;
            await hubConnection.SendAsync("JoinNationalGroup");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error setting up SignalR: {ex.Message}");
            isConnected = false;
        }
    }

    private void SetupAutoRefresh()
    {
        refreshTimer = new System.Timers.Timer(30000); // 30 seconds
        refreshTimer.Elapsed += async (sender, e) =>
        {
            if (autoRefresh)
            {
                await LoadData();
            }
        };
        refreshTimer.Start();
    }

    private async Task RefreshData()
    {
        await LoadData();
    }

    private void ToggleAutoRefresh()
    {
        autoRefresh = !autoRefresh;
    }

    private void SetRiskFilter(string filter)
    {
        riskFilter = filter;
    }

    private void ViewDetails(Guid partographId)
    {
        Navigation.NavigateTo($"/partograph/{partographId}");
    }

    private string GetCardClass(string riskLevel) => riskLevel switch
    {
        "Critical" => "risk-critical",
        "High" => "risk-high",
        "Moderate" => "risk-moderate",
        _ => ""
    };

    private string GetRiskClass(string riskLevel) => riskLevel.ToLower();

    private string GetRiskBadgeClass(string riskLevel) => riskLevel switch
    {
        "Critical" => "bg-danger",
        "High" => "bg-warning text-dark",
        "Moderate" => "bg-info",
        _ => "bg-success"
    };

    private string GetProgressBarClass(string riskLevel) => riskLevel switch
    {
        "Critical" => "bg-danger",
        "High" => "bg-warning",
        _ => "bg-primary"
    };

    private bool IsVitalCritical(int? value, string type)
    {
        if (!value.HasValue) return false;
        return type switch
        {
            "FHR" => value < 110 || value > 160,
            "BP" => value > 140,
            _ => false
        };
    }

    private string GetAlertBgClass(ClinicalAlertSeverity severity) => severity switch
    {
        ClinicalAlertSeverity.Emergency => "bg-danger text-white border-danger",
        ClinicalAlertSeverity.Critical => "bg-danger-subtle text-danger border-danger-subtle",
        ClinicalAlertSeverity.Warning => "bg-warning-subtle text-warning-emphasis border-warning-subtle",
        _ => "bg-info-subtle text-info-emphasis border-info-subtle"
    };

    private string GetAlertIcon(ClinicalAlertSeverity severity) => severity switch
    {
        ClinicalAlertSeverity.Emergency => "bi bi-exclamation-octagon-fill",
        ClinicalAlertSeverity.Critical => "bi bi-exclamation-triangle-fill",
        ClinicalAlertSeverity.Warning => "bi bi-exclamation-circle-fill",
        _ => "bi bi-info-circle-fill"
    };

    private string FormatDuration(TimeSpan duration)
    {
        if (duration.TotalHours >= 1)
            return $"{(int)duration.TotalHours}h {duration.Minutes}m";
        return $"{duration.Minutes}m";
    }

    public async ValueTask DisposeAsync()
    {
        refreshTimer?.Dispose();
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}
