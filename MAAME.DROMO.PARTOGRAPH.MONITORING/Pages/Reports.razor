@page "/reports"
@attribute [Authorize]
@inject IReportVisualizationService ReportService
@inject IDashboardService DashboardService
@inject IRegionService RegionService
@inject IDistrictService DistrictService
@inject AuthenticationStateProvider AuthStateProvider
@inject IGlobalToastService ToastService

<PageTitle>Smart Analysis - MAAME DROMO</PageTitle>

<div class="container-fluid px-0">
    <div class="dashboard-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-1 text-gradient-primary fw-bold">
                    <i class="bi bi-file-earmark-bar-graph me-2"></i>
                    Smart Report Center
                </h2>
                <p class="text-secondary mb-0">
                    AI-driven insights and automated reporting for @userAccessLevel level
                </p>
            </div>
            
            @if (showBuilder)
            {
                <button class="btn btn-outline-secondary hover-lift" @onclick="ToggleBuilder">
                    <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
                </button>
            }
        </div>
    </div>

    @if (!showBuilder)
    {
        <!-- SMART DASHBOARD VIEW -->
        <div class="row g-4 mb-5 fade-in-up">
            <div class="col-12">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h5 class="fw-bold text-dark mb-0">Recommended for You</h5>
                    <button class="btn btn-primary rounded-pill hover-lift shadow-sm px-4" @onclick="ToggleBuilder">
                        <i class="bi bi-plus-lg me-2"></i>Create Custom Report
                    </button>
                </div>
            </div>

            <!-- One-Click Generation Cards -->
            @foreach (var template in quickTemplates)
            {
                <div class="col-md-6 col-lg-4">
                    <div class="glass-panel h-100 p-4 position-relative overflow-hidden hover-lift transition-all cursor-pointer group" 
                         @onclick="() => QuickGenerate(template)">
                        <div class="d-flex justify-content-between align-items-start mb-4">
                            <div class="icon-box rounded-circle @template.ColorBg text-white d-flex align-items-center justify-content-center shadow-sm">
                                <i class="bi @template.Icon fs-4"></i>
                            </div>
                            <span class="badge bg-white text-secondary border shadow-sm">One-Click</span>
                        </div>
                        <h5 class="fw-bold text-dark mb-2">@template.Name</h5>
                        <p class="text-secondary small mb-4">@template.Description</p>
                        
                        <div class="d-flex align-items-center text-primary fw-medium small mt-auto">
                            <span>Generate Now</span>
                            <i class="bi bi-arrow-right ms-2 group-hover-translate"></i>
                        </div>
                        
                        <!-- Decorative background icon -->
                        <i class="bi @template.Icon position-absolute text-muted opacity-10" style="font-size: 8rem; bottom: -2rem; right: -2rem;"></i>
                    </div>
                </div>
            }
        </div>

        <div class="row g-4 fade-in-up" style="animation-delay: 0.1s">
            <!-- Recent Reports History -->
            <div class="col-lg-8">
                <div class="glass-panel p-4 h-100">
                    <div class="d-flex align-items-center justify-content-between mb-4">
                        <h5 class="fw-bold text-dark mb-0"><i class="bi bi-clock-history me-2 text-primary"></i>Recent History</h5>
                        <button class="btn btn-sm btn-light text-muted">View All</button>
                    </div>
                    
                    <div class="list-group list-group-flush">
                        @foreach (var history in recentHistory)
                        {
                            <div class="list-group-item bg-transparent px-0 py-3 border-bottom border-light hover-bg-light rounded-3 transition-all d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <div class="icon-box-sm bg-light text-secondary rounded-circle me-3 d-flex align-items-center justify-content-center">
                                        <i class="bi bi-file-earmark-text"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0 fw-bold text-dark">@history.Name</h6>
                                        <small class="text-muted">Generated @history.TimeAgo â€¢ @history.Format</small>
                                    </div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary" title="Download PDF"><i class="bi bi-download"></i></button>
                                    <button class="btn btn-sm btn-light" title="Share"><i class="bi bi-share"></i></button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Intelligent Insights -->
            <div class="col-lg-4">
                <div class="glass-panel p-4 h-100 bg-gradient-primary-soft text-white position-relative overflow-hidden" style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);">
                    <div class="position-relative z-1">
                        <h5 class="fw-bold mb-4 text-white"><i class="bi bi-stars me-2 text-warning"></i>AI Insight</h5>
                        <p class="mb-3 text-white-90">Based on recent trends, we recommend generating a <strong>Complications Analysis</strong> for the Northern District.</p>
                        <div class="p-3 bg-white bg-opacity-10 rounded-3 border border-white border-opacity-20 mb-4 backdrop-blur">
                            <i class="bi bi-graph-up-arrow me-2 text-success"></i>
                            <span class="small fw-medium">PPH cases have risen by 5% this month.</span>
                        </div>
                        <button class="btn btn-white text-primary fw-bold w-100 shadow-sm hover-lift">
                            Investigate Anomaly
                        </button>
                    </div>
                    <!-- Decorative circles -->
                    <div class="position-absolute top-0 end-0 bg-white opacity-10 rounded-circle" style="width: 200px; height: 200px; margin-top: -50px; margin-right: -50px;"></div>
                    <div class="position-absolute bottom-0 start-0 bg-white opacity-10 rounded-circle" style="width: 150px; height: 150px; margin-bottom: -30px; margin-left: -30px;"></div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- BUILDER / PREVIEW VIEW -->
        <div class="row g-4 fade-in-up">
            <!-- Report Configuration Panel -->
            <div class="col-lg-4">
                <div class="glass-panel sticky-top" style="top: 1rem; z-index: 10;">
                    <div class="p-3 border-bottom border-light bg-light-subtle rounded-top">
                        <h5 class="mb-0 text-primary fw-bold">
                            <i class="bi bi-sliders me-2"></i>
                            Custom Configuration
                        </h5>
                    </div>
                    <div class="p-4">
                        <!-- Report Type Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-bold text-secondary text-uppercase small ls-1">Report Type</label>
                            <div class="row g-2">
                                @foreach (var type in reportTypes)
                                {
                                    <div class="col-6">
                                        <div class="report-type-option @(selectedReportType == type.Key ? "selected" : "")"
                                             @onclick="() => SelectReportType(type.Key)">
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="icon-box me-2 @(selectedReportType == type.Key ? "bg-primary text-white" : "bg-light text-muted")">
                                                    <i class="bi @type.Value.Icon"></i>
                                                </div>
                                            </div>
                                            <span class="d-block fw-medium small">@type.Value.Name</span>
                                            <input type="radio" name="reportType" checked="@(selectedReportType == type.Key)" class="d-none" />
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Date Range -->
                        <div class="mb-4">
                             <label class="form-label fw-bold text-secondary text-uppercase small ls-1">Date Range</label>
                            <div class="d-flex flex-wrap gap-1 mb-2">
                                @foreach (var period in periods)
                                {
                                    <button class="btn btn-sm rounded-pill @(selectedPeriod == period ? "btn-primary" : "btn-light border")"
                                            @onclick="() => SelectPeriod(period)">
                                        @period
                                    </button>
                                }
                            </div>
                            @if (selectedPeriod == "Custom")
                            {
                                <div class="row g-2 mt-2">
                                    <div class="col-6">
                                        <label class="small text-muted mb-1">From</label>
                                        <input type="date" class="form-control form-control-sm" @bind="startDate" />
                                    </div>
                                    <div class="col-6">
                                        <label class="small text-muted mb-1">To</label>
                                        <input type="date" class="form-control form-control-sm" @bind="endDate" />
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Geographic Filter -->
                        <div class="mb-4">
                            <label class="form-label fw-bold text-secondary text-uppercase small ls-1">Scope</label>
                            @if (userAccessLevel == "District")
                            {
                                <div class="alert alert-light border d-flex align-items-center py-2 mb-2">
                                     <i class="bi bi-geo-alt-fill text-primary me-2"></i>
                                    <div class="small">Restricted to: <strong>@userDistrictName</strong></div>
                                </div>
                            }
                            else
                            {
                                 <select class="form-select mb-2" @bind="selectedScope">
                                    <option value="national">National (All Regions)</option>
                                    <option value="regional">Regional</option>
                                    <option value="district">District</option>
                                </select>

                                @if (selectedScope == "regional" || selectedScope == "district")
                                {
                                    <select class="form-select mb-2" @bind="selectedRegionId">
                                        <option value="">Select Region...</option>
                                        @foreach (var region in regions)
                                        {
                                            <option value="@region.ID">@region.Name</option>
                                        }
                                    </select>
                                }

                                @if (selectedScope == "district" && selectedRegionId != Guid.Empty)
                                {
                                    <select class="form-select" @bind="selectedDistrictId">
                                        <option value="">Select District...</option>
                                        @foreach (var district in filteredDistricts)
                                        {
                                            <option value="@district.ID">@district.Name</option>
                                        }
                                    </select>
                                }
                            }
                        </div>

                        <div class="d-grid">
                            <button class="btn btn-primary shadow-sm py-2" @onclick="GenerateReport" disabled="@isGenerating">
                                @if (isGenerating)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <span>Generating...</span>
                                }
                                else
                                {
                                    <span>Generate Report</span>
                                    <i class="bi bi-arrow-right ms-2"></i>
                                }
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report Preview Panel -->
            <div class="col-lg-8">
                @if (isGenerating)
                {
                    <div class="glass-panel text-center py-5 h-100 d-flex flex-column align-items-center justify-content-center">
                        <div class="spinner-border text-primary mb-4" style="width: 3rem; height: 3rem;" role="status"></div>
                        <h4>Compiling Analytics...</h4>
                        <p class="text-muted">Analyzing @reportTypes[selectedReportType].Name data for the selected period.</p>
                    </div>
                }
                else if (currentReport != null)
                {
                    <div class="glass-panel mb-4" id="reportContent">
                        <div class="d-flex justify-content-between align-items-center p-4 border-bottom border-light">
                            <div>
                                <h4 class="mb-1 fw-bold text-dark">@currentReport.Title</h4>
                                <div class="d-flex align-items-center text-muted small">
                                    <i class="bi bi-calendar-event me-2"></i>@currentReport.DateRange
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-success btn-sm shadow-sm" @onclick="ExportToPDF"><i class="bi bi-file-pdf me-1"></i> PDF</button>
                                <button class="btn btn-outline-primary btn-sm shadow-sm" @onclick="ExportToExcel"><i class="bi bi-file-excel me-1"></i> Excel</button>
                            </div>
                        </div>
                        
                        <div class="p-4">
                            <!-- Metrics -->
                            <div class="row g-3 mb-5">
                                @foreach (var metric in currentReport.KeyMetrics)
                                {
                                    <div class="col-md-3">
                                        <div class="stat-card p-3 h-100 @metric.ColorClass.Replace("metric-", "border-start border-4 border-")">
                                            <small class="text-muted text-uppercase fw-semibold" style="font-size: 0.7rem;">@metric.Label</small>
                                            <h3 class="mb-1 fw-bold text-dark">@metric.Value</h3>
                                            @if (!string.IsNullOrEmpty(metric.Change))
                                            {
                                                <small class="@(metric.Change.StartsWith("+") ? "text-success" : "text-danger") fw-medium">
                                                    <i class="bi @(metric.Change.StartsWith("+") ? "bi-arrow-up" : "bi-arrow-down")"></i> @metric.Change
                                                </small>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>

                            <!-- Charts -->
                            @if (currentReport.Charts.Any())
                            {
                                <div class="row g-4 mb-5">
                                    @foreach (var chart in currentReport.Charts)
                                    {
                                        <div class="col-md-6">
                                            <div class="card border-0 shadow-sm h-100 bg-light bg-opacity-50">
                                                <div class="card-body">
                                                    <h6 class="fw-bold mb-3">@chart.Title</h6>
                                                    @if (chart.Type == "bar")
                                                    {
                                                        @foreach (var item in chart.Data)
                                                        {
                                                            <div class="mb-2">
                                                                <div class="d-flex justify-content-between small mb-1">
                                                                    <span>@item.Label</span>
                                                                    <span class="fw-bold">@item.Value</span>
                                                                </div>
                                                                <div class="progress rounded-pill" style="height: 6px;">
                                                                    <div class="progress-bar rounded-pill @item.Color" style="width: @item.Percentage%"></div>
                                                                </div>
                                                            </div>
                                                        }
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
                else
                {
                    <div class="glass-panel text-center py-5 h-100 d-flex flex-column align-items-center justify-content-center opacity-50">
                        <i class="bi bi-sliders fs-1 text-muted mb-3"></i>
                        <p class="text-muted">Adjust configuration on the left to preview report</p>
                    </div>
                }
            </div>
        </div>
    }
</div>

<style>
    .glass-panel {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        border-radius: 1rem;
    }
    .hover-lift:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    .cursor-pointer { cursor: pointer; }
    .transition-all { transition: all 0.3s ease; }
    .group:hover .group-hover-translate { transform: translateX(4px); }
    .report-type-option {
         padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; cursor: pointer; transition: all 0.2s ease;
    }
    .report-type-option.selected { border-color: #0d6efd; background: #e7f1ff; }
    
    .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; transform: translateY(20px); }
    @@keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
</style>

@code {
    private bool showBuilder = false;
    private bool isGenerating = false;
    private ReportData? currentReport = null;
    
    // User Context
    private string userAccessLevel = "National";
    private Guid? userRegionId;
    private Guid? userDistrictId;
    private string? userRegionName;
    private string? userDistrictName;

    // Filters
    private string selectedReportType = "delivery";
    private string selectedPeriod = "Month";
    private string selectedScope = "national";
    private Guid selectedRegionId = Guid.Empty;
    private Guid selectedDistrictId = Guid.Empty;
    private DateTime startDate = DateTime.Now.AddMonths(-1);
    private DateTime endDate = DateTime.Now;

    // Data Sources
    private List<RegionSummary> regions = new();
    private List<DistrictSummary> districts = new();
    private List<RegionSummary> allRegions = new();
    private List<DistrictSummary> allDistricts = new();
    private List<DistrictSummary> filteredDistricts => selectedRegionId != Guid.Empty
        ? districts.Where(d => regions.Any(r => r.ID == selectedRegionId && r.Name == d.RegionName)).ToList()
        : districts;

    // Static Data
    private Dictionary<string, (string Name, string Icon, string Color)> reportTypes = new()
    {
        { "delivery", ("Deliveries", "bi-clipboard2-pulse", "text-primary") },
        { "complication", ("Complications", "bi-exclamation-triangle", "text-danger") },
        { "outcome", ("Outcomes", "bi-graph-up", "text-success") },
        { "alert", ("Alert Response", "bi-bell", "text-warning") },
        { "who", ("WHO Compliance", "bi-check-circle", "text-info") },
        { "staff", ("Staff Performance", "bi-people", "text-secondary") }
    };

    private string[] periods = { "Today", "Week", "Month", "Quarter", "Year", "Custom" };
    
    private List<TemplateModel> quickTemplates = new()
    {
        new TemplateModel("Monthly Delivery Summary", "bi-calendar-month", "delivery", "Month", "Comprehensive overview of all deliveries, C-sections, and outcomes for the past 30 days.", "bg-primary"),
        new TemplateModel("Weekly Alert Analysis", "bi-bell-fill", "alert", "Week", "Detailed breakdown of response times and critical alert resolutions.", "bg-warning"),
        new TemplateModel("Maternal Outcomes Audit", "bi-activity", "outcome", "Quarter", "Quality of care indicators and maternal/fetal outcome statistics.", "bg-success")
    };

    private List<HistoryModel> recentHistory = new()
    {
        new HistoryModel("Nov 2025 Delivery Report", "2 hours ago", "PDF"),
        new HistoryModel("Q3 Safety Audit", "Yesterday", "Excel"),
        new HistoryModel("Staff Performance Review", "3 days ago", "PDF")
    };

    protected override async Task OnInitializedAsync()
    {
        await DetermineUserAccessLevel();
        await LoadFilters();
    }
    
    private void ToggleBuilder()
    {
        showBuilder = !showBuilder;
        currentReport = null; // Reset report when switching views
    }

    private void QuickGenerate(TemplateModel template)
    {
        showBuilder = true;
        selectedReportType = template.ReportType;
        SelectPeriod(template.Period);
        
        ToastService.ShowInfo("Generating Report", $"Compiling {template.Name}...");
        
        // Trigger generation
        _ = GenerateReport();
    }
    
    private async Task DetermineUserAccessLevel()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        userAccessLevel = user.Claims.FirstOrDefault(c => c.Type == "AccessLevel")?.Value ?? "National";
        userRegionName = user.Claims.FirstOrDefault(c => c.Type == "RegionName")?.Value;
        userDistrictName = user.Claims.FirstOrDefault(c => c.Type == "DistrictName")?.Value;
        
        var regionIdClaim = user.Claims.FirstOrDefault(c => c.Type == "RegionID")?.Value;
        if (Guid.TryParse(regionIdClaim, out var regionId)) userRegionId = regionId;

        var districtIdClaim = user.Claims.FirstOrDefault(c => c.Type == "DistrictID")?.Value;
        if (Guid.TryParse(districtIdClaim, out var districtId)) userDistrictId = districtId;

        if (userAccessLevel == "District") selectedScope = "district";
        else if (userAccessLevel == "Regional") selectedScope = "regional";
    }

    private async Task LoadFilters()
    {
        try
        {
            allRegions = await RegionService.GetAllRegionSummariesAsync();
            allDistricts = await DistrictService.GetAllDistrictSummariesAsync();
            
            if (userAccessLevel == "District" && userDistrictId.HasValue)
            {
                regions = allRegions.Where(r => r.ID == userRegionId).ToList();
                districts = allDistricts.Where(d => d.ID == userDistrictId).ToList();
                if (userRegionId.HasValue) selectedRegionId = userRegionId.Value;
                if (userDistrictId.HasValue) selectedDistrictId = userDistrictId.Value;
            }
            else if (userAccessLevel == "Regional" && userRegionId.HasValue)
            {
                regions = allRegions.Where(r => r.ID == userRegionId).ToList();
                districts = allDistricts.Where(d => allRegions.Any(r => r.ID == userRegionId && r.Name == d.RegionName)).ToList();
                selectedRegionId = userRegionId.Value;
            }
            else
            {
                regions = allRegions;
                districts = allDistricts;
            }
        }
        catch (Exception ex)
        {
            // Error handling
            Console.WriteLine($"Error loading filters: {ex.Message}");
        }
    }

    private void SelectReportType(string type) => selectedReportType = type;

    private void SelectPeriod(string period)
    {
        selectedPeriod = period;
        if (period != "Custom")
        {
            var now = DateTime.Now;
            endDate = now;
            startDate = period switch
            {
                "Today" => now.Date,
                "Week" => now.AddDays(-7),
                "Month" => now.AddMonths(-1),
                "Quarter" => now.AddMonths(-3),
                "Year" => now.AddYears(-1),
                _ => now.AddMonths(-1)
            };
        }
    }

    private async Task GenerateReport()
    {
        isGenerating = true;
        StateHasChanged();
        await Task.Delay(1500); // Simulate
        currentReport = GenerateDemoReport();
        isGenerating = false;
        
        ToastService.ShowSuccess("Report Ready", "Your analysis has been generated successfully.");
        StateHasChanged();
    }
    
    private void ExportToPDF() => ToastService.ShowSuccess("Download Started", "Report PDF is downloading...");
    private void ExportToExcel() => ToastService.ShowSuccess("Download Started", "Report Excel is downloading...");

    private ReportData GenerateDemoReport()
    {
        var reportName = reportTypes[selectedReportType].Name;
        string scopeText;

        if (userAccessLevel == "District")
        {
            scopeText = userDistrictName ?? "District";
        }
        else if (userAccessLevel == "Regional")
        {
            if (selectedScope == "district" && selectedDistrictId != Guid.Empty)
            {
                scopeText = districts.FirstOrDefault(d => d.ID == selectedDistrictId)?.Name ?? userDistrictName ?? "District";
            }
            else
            {
                scopeText = userRegionName ?? "Regional";
            }
        }
        else
        {
            scopeText = selectedScope switch
            {
                "national" => "National",
                "regional" => regions.FirstOrDefault(r => r.ID == selectedRegionId)?.Name ?? "Regional",
                "district" => districts.FirstOrDefault(d => d.ID == selectedDistrictId)?.Name ?? "District",
                _ => "National"
            };
        }

        return new ReportData
        {
            Title = $"{reportName} Report - {scopeText}",
            DateRange = $"{startDate:MMM dd} - {endDate:MMM dd, yyyy}",
            KeyMetrics = GetMetricsForType(selectedReportType),
            Charts = GetChartsForType(selectedReportType),
        };
    }

    private List<ReportMetric> GetMetricsForType(string type)
    {
        return type switch
        {
            "delivery" => new List<ReportMetric>
            {
                new() { Label = "Total Deliveries", Value = "1,247", Icon = "bi-clipboard2-pulse", ColorClass = "metric-primary", Change = "+12%" },
                new() { Label = "Normal Vaginal", Value = "892", Icon = "bi-check-circle", ColorClass = "metric-success", Change = "+8%" },
                new() { Label = "C-Section Rate", Value = "18.5%", Icon = "bi-exclamation-triangle", ColorClass = "metric-warning", Change = "+2.3%" },
                new() { Label = "Active Labors", Value = "45", Icon = "bi-hourglass-split", ColorClass = "metric-info", Change = "-5" }
            },
            "complication" => new List<ReportMetric>
            {
                new() { Label = "Total Complications", Value = "89", Icon = "bi-exclamation-diamond", ColorClass = "metric-danger", Change = "-8%" },
                new() { Label = "PPH Cases", Value = "23", Icon = "bi-droplet", ColorClass = "metric-danger", Change = "-12%" },
                new() { Label = "Eclampsia", Value = "5", Icon = "bi-lightning", ColorClass = "metric-warning", Change = "-40%" },
                new() { Label = "Response Rate", Value = "94%", Icon = "bi-check2-all", ColorClass = "metric-success", Change = "+3%" }
            },
            "outcome" => new List<ReportMetric>
            {
                new() { Label = "Live Births", Value = "1,238", Icon = "bi-heart-pulse", ColorClass = "metric-success", Change = "+15%" },
                new() { Label = "Stillbirths", Value = "9", Icon = "bi-heart", ColorClass = "metric-warning", Change = "-25%" },
                new() { Label = "Maternal Deaths", Value = "1", Icon = "bi-exclamation-octagon", ColorClass = "metric-danger", Change = "-50%" },
                new() { Label = "APGAR >7", Value = "96.2%", Icon = "bi-award", ColorClass = "metric-success", Change = "+1.5%" }
            },
            _ => new List<ReportMetric>
            {
                new() { Label = "Total Alerts", Value = "256", Icon = "bi-bell", ColorClass = "metric-warning", Change = "+5%" },
                new() { Label = "Resolved", Value = "241", Icon = "bi-check-circle", ColorClass = "metric-success", Change = "+12%" },
                new() { Label = "Avg Response", Value = "8.5 min", Icon = "bi-clock", ColorClass = "metric-info", Change = "-2.1 min" },
                new() { Label = "Compliance", Value = "89%", Icon = "bi-award", ColorClass = "metric-primary", Change = "+4%" }
            }
        };
    }

    private List<ReportChart> GetChartsForType(string type)
    {
        return new List<ReportChart>
        {
            new ReportChart
            {
                Title = "Distribution by Category",
                Type = "bar",
                Data = new List<ChartDataItem>
                {
                    new() { Label = "Category A", Value = "450", Percentage = 36, Color = "bg-primary" },
                    new() { Label = "Category B", Value = "380", Percentage = 30, Color = "bg-success" },
                    new() { Label = "Category C", Value = "267", Percentage = 21, Color = "bg-warning" },
                    new() { Label = "Category D", Value = "150", Percentage = 12, Color = "bg-info" }
                }
            },
            new ReportChart
            {
                Title = "Breakdown by Type",
                Type = "pie",
                Data = new List<ChartDataItem>
                {
                    new() { Label = "Type 1", Value = "520", Percentage = 42, Color = "bg-success" },
                    new() { Label = "Type 2", Value = "380", Percentage = 30, Color = "bg-info" },
                    new() { Label = "Type 3", Value = "220", Percentage = 18, Color = "bg-warning" },
                    new() { Label = "Type 4", Value = "127", Percentage = 10, Color = "bg-danger" }
                }
            }
        };
    }

    private ReportDataTable GetDataTableForType(string type)
    {
        return new ReportDataTable
        {
            Headers = new[] { "Facility", "Total", "Normal", "C-Section", "Complications", "Rate" },
            Rows = new List<string[]>
            {
                new[] { "Korle-Bu Teaching Hospital", "320", "245", "75", "12", "23.4%" },
                new[] { "Ridge Hospital", "180", "142", "38", "8", "21.1%" },
                new[] { "Tema General Hospital", "140", "115", "25", "5", "17.9%" },
                new[] { "La General Hospital", "95", "78", "17", "3", "17.9%" },
                new[] { "Madina Polyclinic", "52", "45", "7", "2", "13.5%" }
            }
        };
    }

    private List<ReportInsight> GetInsightsForType(string type)
    {
        return new List<ReportInsight>
        {
            new() { Title = "Positive Trend", Description = "Overall delivery outcomes improved by 12% compared to last period.", Icon = "bi-graph-up-arrow", AlertClass = "alert-success" },
            new() { Title = "Area of Concern", Description = "C-section rate at 18.5% is slightly above WHO recommended range.", Icon = "bi-exclamation-triangle", AlertClass = "alert-warning" },
            new() { Title = "Best Performer", Description = "Tema General Hospital achieved lowest complication rate this month.", Icon = "bi-trophy", AlertClass = "alert-info" },
            new() { Title = "Action Required", Description = "3 facilities require additional training on partograph completion.", Icon = "bi-person-check", AlertClass = "alert-primary" }
        };
    }

    // Models
    public record TemplateModel(string Name, string Icon, string ReportType, string Period, string Description, string ColorBg);
    public record HistoryModel(string Name, string TimeAgo, string Format);

    public class ReportData
    {
        public string Title { get; set; } = "";
        public string DateRange { get; set; } = "";
        public string DataSource { get; set; } = "";
        public List<ReportMetric> KeyMetrics { get; set; } = new();
        public List<ReportChart> Charts { get; set; } = new();
        public ReportDataTable? DataTable { get; set; }
        public List<ReportInsight> Insights { get; set; } = new();
    }

    public class ReportMetric
    {
        public string Label { get; set; } = "";
        public string Value { get; set; } = "";
        public string Icon { get; set; } = "";
        public string ColorClass { get; set; } = "";
        public string Change { get; set; } = "";
    }

    public class ReportChart
    {
        public string Title { get; set; } = "";
        public string Type { get; set; } = "";
        public List<ChartDataItem> Data { get; set; } = new();
    }

    public class ChartDataItem
    {
        public string Label { get; set; } = "";
        public string Value { get; set; } = "";
        public double Percentage { get; set; }
        public string Color { get; set; } = "";
    }

    public class ReportDataTable
    {
        public string[] Headers { get; set; } = Array.Empty<string>();
        public List<string[]> Rows { get; set; } = new();
    }

    public class ReportInsight
    {
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
        public string Icon { get; set; } = "";
        public string AlertClass { get; set; } = "";
    }
}
