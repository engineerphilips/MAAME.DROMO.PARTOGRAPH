@page "/alert-settings"
@attribute [Authorize(Policy = "DistrictAccess")]
@inject IAlertThresholdService ThresholdService
@inject INotificationService NotificationService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Alert Settings - MAAME DROMO Monitoring</PageTitle>

<div class="dashboard-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2 class="mb-1">
                <i class="bi bi-gear me-2 text-secondary"></i>
                Alert Settings
            </h2>
            <p class="text-muted mb-0">
                Configure alert thresholds and notification preferences
            </p>
        </div>
    </div>
</div>

<ul class="nav nav-tabs mb-4">
    <li class="nav-item">
        <button class="nav-link @(activeTab == "thresholds" ? "active" : "")"
                @onclick="() => activeTab = \"thresholds\"">
            <i class="bi bi-sliders me-1"></i> Alert Thresholds
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link @(activeTab == "notifications" ? "active" : "")"
                @onclick="() => activeTab = \"notifications\"">
            <i class="bi bi-bell me-1"></i> Notification Preferences
        </button>
    </li>
</ul>

@if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    @if (activeTab == "thresholds")
    {
        <!-- Alert Thresholds Configuration -->
        <div class="row">
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-heart-pulse me-2 text-danger"></i>Fetal Heart Rate Thresholds</h5>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" @bind="thresholds.UseCustomThresholds" id="customFHR">
                            <label class="form-check-label" for="customFHR">Custom</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Critical Low (bpm)</label>
                                <input type="number" class="form-control" @bind="thresholds.FHRCriticalLow"
                                       disabled="@(!thresholds.UseCustomThresholds)" />
                                <small class="text-muted">WHO default: 100 bpm</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Warning Low (bpm)</label>
                                <input type="number" class="form-control" @bind="thresholds.FHRWarningLow"
                                       disabled="@(!thresholds.UseCustomThresholds)" />
                                <small class="text-muted">WHO default: 110 bpm</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Warning High (bpm)</label>
                                <input type="number" class="form-control" @bind="thresholds.FHRWarningHigh"
                                       disabled="@(!thresholds.UseCustomThresholds)" />
                                <small class="text-muted">WHO default: 160 bpm</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Critical High (bpm)</label>
                                <input type="number" class="form-control" @bind="thresholds.FHRCriticalHigh"
                                       disabled="@(!thresholds.UseCustomThresholds)" />
                                <small class="text-muted">WHO default: 180 bpm</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-droplet me-2 text-info"></i>Blood Pressure Thresholds</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Systolic Warning (mmHg)</label>
                                <input type="number" class="form-control" @bind="thresholds.SystolicWarning"
                                       disabled="@(!thresholds.UseCustomThresholds)" />
                                <small class="text-muted">WHO default: 140 mmHg</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Systolic Critical (mmHg)</label>
                                <input type="number" class="form-control" @bind="thresholds.SystolicCritical"
                                       disabled="@(!thresholds.UseCustomThresholds)" />
                                <small class="text-muted">WHO default: 160 mmHg</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Diastolic Warning (mmHg)</label>
                                <input type="number" class="form-control" @bind="thresholds.DiastolicWarning"
                                       disabled="@(!thresholds.UseCustomThresholds)" />
                                <small class="text-muted">WHO default: 90 mmHg</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Diastolic Critical (mmHg)</label>
                                <input type="number" class="form-control" @bind="thresholds.DiastolicCritical"
                                       disabled="@(!thresholds.UseCustomThresholds)" />
                                <small class="text-muted">WHO default: 110 mmHg</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-clock me-2 text-warning"></i>Measurement Intervals</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">FHR Interval (minutes)</label>
                                <input type="number" class="form-control" @bind="thresholds.FHRMeasurementInterval"
                                       disabled="@(!thresholds.UseCustomThresholds)" />
                                <small class="text-muted">WHO default: 30 min</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">BP Interval (minutes)</label>
                                <input type="number" class="form-control" @bind="thresholds.BPMeasurementInterval"
                                       disabled="@(!thresholds.UseCustomThresholds)" />
                                <small class="text-muted">WHO default: 60 min</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Dilatation Interval (minutes)</label>
                                <input type="number" class="form-control" @bind="thresholds.DilatationMeasurementInterval"
                                       disabled="@(!thresholds.UseCustomThresholds)" />
                                <small class="text-muted">WHO default: 240 min</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-arrow-up-circle me-2 text-danger"></i>Escalation Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Escalation Timeout (minutes)</label>
                                <input type="number" class="form-control" @bind="thresholds.EscalationTimeoutMinutes"
                                       disabled="@(!thresholds.UseCustomThresholds)" />
                                <small class="text-muted">Default: 15 minutes</small>
                            </div>
                            <div class="col-md-6 d-flex align-items-center">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" @bind="thresholds.AutoEscalateUnacknowledged"
                                           disabled="@(!thresholds.UseCustomThresholds)" id="autoEscalate">
                                    <label class="form-check-label" for="autoEscalate">
                                        Auto-escalate unacknowledged alerts
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2">
                    <button class="btn btn-primary" @onclick="SaveThresholds">
                        <i class="bi bi-save me-1"></i> Save Settings
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="ResetToDefaults">
                        <i class="bi bi-arrow-counterclockwise me-1"></i> Reset to WHO Defaults
                    </button>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card border-0 shadow-sm bg-light">
                    <div class="card-body">
                        <h6><i class="bi bi-info-circle me-2"></i>About Custom Thresholds</h6>
                        <p class="small text-muted">
                            Custom thresholds allow facilities to adjust alert triggers based on their specific
                            patient population and clinical context.
                        </p>
                        <hr />
                        <h6 class="text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Important</h6>
                        <ul class="small text-muted mb-0">
                            <li>WHO guidelines should be followed unless there is clinical justification</li>
                            <li>Changes require supervisor approval</li>
                            <li>All threshold changes are logged</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Notification Preferences -->
        <div class="row">
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-bell me-2"></i>Notification Channels</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" @bind="subscription.InAppEnabled" id="inApp">
                                <label class="form-check-label" for="inApp">
                                    <i class="bi bi-app-indicator me-2"></i>In-App Notifications
                                </label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" @bind="subscription.PushEnabled" id="push">
                                <label class="form-check-label" for="push">
                                    <i class="bi bi-phone me-2"></i>Push Notifications
                                </label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" @bind="subscription.EmailEnabled" id="email">
                                <label class="form-check-label" for="email">
                                    <i class="bi bi-envelope me-2"></i>Email Notifications
                                </label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" @bind="subscription.SmsEnabled" id="sms">
                                <label class="form-check-label" for="sms">
                                    <i class="bi bi-chat-dots me-2"></i>SMS Notifications
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Alert Types</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>By Severity</h6>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" @bind="subscription.CriticalAlerts" id="critical">
                                    <label class="form-check-label" for="critical">
                                        <span class="badge bg-danger me-1">Critical</span> Alerts
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" @bind="subscription.WarningAlerts" id="warning">
                                    <label class="form-check-label" for="warning">
                                        <span class="badge bg-warning text-dark me-1">Warning</span> Alerts
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" @bind="subscription.InfoAlerts" id="info">
                                    <label class="form-check-label" for="info">
                                        <span class="badge bg-info me-1">Info</span> Alerts
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>By Category</h6>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" @bind="subscription.FetalAlerts" id="fetal">
                                    <label class="form-check-label" for="fetal">Fetal Monitoring Alerts</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" @bind="subscription.MaternalAlerts" id="maternal">
                                    <label class="form-check-label" for="maternal">Maternal Vital Alerts</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" @bind="subscription.LaborAlerts" id="labor">
                                    <label class="form-check-label" for="labor">Labor Progress Alerts</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" @bind="subscription.SystemAlerts" id="system">
                                    <label class="form-check-label" for="system">System Alerts</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-moon me-2"></i>Quiet Hours</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" @bind="subscription.QuietHoursEnabled" id="quietHours">
                            <label class="form-check-label" for="quietHours">
                                Enable Quiet Hours (Critical alerts still come through)
                            </label>
                        </div>
                        @if (subscription.QuietHoursEnabled)
                        {
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Start Time</label>
                                    <input type="time" class="form-control" @bind="quietHoursStartString" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">End Time</label>
                                    <input type="time" class="form-control" @bind="quietHoursEndString" />
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <button class="btn btn-primary" @onclick="SaveNotificationPreferences">
                    <i class="bi bi-save me-1"></i> Save Preferences
                </button>
            </div>
        </div>
    }
}

@if (!string.IsNullOrEmpty(saveMessage))
{
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div class="toast show" role="alert">
            <div class="toast-header bg-success text-white">
                <i class="bi bi-check-circle me-2"></i>
                <strong class="me-auto">Success</strong>
                <button type="button" class="btn-close btn-close-white" @onclick="() => saveMessage = null"></button>
            </div>
            <div class="toast-body">@saveMessage</div>
        </div>
    </div>
}

@code {
    private bool isLoading = true;
    private string activeTab = "thresholds";
    private string? saveMessage;
    private string currentUserId = "";

    private AlertThresholdConfiguration thresholds = new();
    private NotificationSubscription subscription = new();

    private string quietHoursStartString
    {
        get => subscription.QuietHoursStart.ToString("HH:mm");
        set => subscription.QuietHoursStart = TimeOnly.Parse(value);
    }

    private string quietHoursEndString
    {
        get => subscription.QuietHoursEnd.ToString("HH:mm");
        set => subscription.QuietHoursEnd = TimeOnly.Parse(value);
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        currentUserId = authState.User.Identity?.Name ?? "user";
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            thresholds = await ThresholdService.GetGlobalThresholdsAsync();
            subscription = await NotificationService.GetSubscriptionAsync(currentUserId) ?? new NotificationSubscription { UserId = currentUserId };
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SaveThresholds()
    {
        thresholds.UpdatedAt = DateTime.UtcNow;
        thresholds.UpdatedBy = currentUserId;
        await ThresholdService.SaveFacilityThresholdsAsync(thresholds);
        saveMessage = "Alert thresholds saved successfully!";
        await Task.Delay(3000);
        saveMessage = null;
    }

    private async Task ResetToDefaults()
    {
        thresholds = await ThresholdService.GetGlobalThresholdsAsync();
        thresholds.UseCustomThresholds = false;
        StateHasChanged();
    }

    private async Task SaveNotificationPreferences()
    {
        subscription.UpdatedAt = DateTime.UtcNow;
        await NotificationService.SaveSubscriptionAsync(subscription);
        saveMessage = "Notification preferences saved successfully!";
        await Task.Delay(3000);
        saveMessage = null;
    }
}
