@page "/facility-onboarding"
@page "/facilities/new"
@attribute [Authorize(Roles = "Admin")]
@inject IFacilityService FacilityService
@inject IRegionService RegionService
@inject IDistrictService DistrictService
@inject NavigationManager Navigation

<PageTitle>Facility Onboarding - MAAME DROMO Monitoring</PageTitle>

<div class="dashboard-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <button class="btn btn-outline-secondary me-3" @onclick="GoBack">
                <i class="bi bi-arrow-left"></i>
            </button>
            <div>
                <h2 class="mb-1">
                    <i class="bi bi-hospital me-2 text-primary"></i>
                    Facility Onboarding
                </h2>
                <p class="text-muted mb-0">
                    Register a new health facility in the system
                </p>
            </div>
        </div>
    </div>
</div>

@if (showSuccess)
{
    <div class="alert alert-success d-flex align-items-center" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        <div>
            Facility "<strong>@model.Name</strong>" has been successfully registered!
            <a href="/facilities" class="alert-link ms-2">View all facilities</a>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger d-flex align-items-center" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <div>@errorMessage</div>
    </div>
}

<div class="row">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-building me-2"></i>Facility Information</h5>
            </div>
            <div class="card-body">
                <EditForm Model="@model" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />

                    <!-- Basic Information -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">Basic Information</h6>
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label">Facility Name <span class="text-danger">*</span></label>
                                <InputText class="form-control" @bind-Value="model.Name" placeholder="e.g., Korle Bu Teaching Hospital" />
                                <ValidationMessage For="@(() => model.Name)" class="text-danger small" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Facility Code <span class="text-danger">*</span></label>
                                <InputText class="form-control" @bind-Value="model.Code" placeholder="e.g., KBTH" style="text-transform: uppercase;" />
                                <ValidationMessage For="@(() => model.Code)" class="text-danger small" />
                                <small class="text-muted">Unique identifier for the facility</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Facility Type <span class="text-danger">*</span></label>
                                <InputSelect class="form-select" @bind-Value="model.Type">
                                    <option value="Hospital">Hospital</option>
                                    <option value="Clinic">Clinic</option>
                                    <option value="Health Center">Health Center</option>
                                    <option value="CHPS Compound">CHPS Compound</option>
                                    <option value="Maternity Home">Maternity Home</option>
                                </InputSelect>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Facility Level <span class="text-danger">*</span></label>
                                <InputSelect class="form-select" @bind-Value="model.Level">
                                    <option value="Primary">Primary</option>
                                    <option value="Secondary">Secondary</option>
                                    <option value="Tertiary">Tertiary</option>
                                </InputSelect>
                                <small class="text-muted">Level of care provided</small>
                            </div>
                        </div>
                    </div>

                    <!-- Location Hierarchy -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">Location Hierarchy</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Region <span class="text-danger">*</span></label>
                                <InputSelect class="form-select" @bind-Value="selectedRegionId" @oninput="OnRegionChanged">
                                    <option value="">-- Select Region --</option>
                                    @foreach (var region in regions)
                                    {
                                        <option value="@region.ID">@region.Name</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => model.RegionId)" class="text-danger small" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">District <span class="text-danger">*</span></label>
                                <InputSelect class="form-select" @bind-Value="selectedDistrictId" disabled="@(!selectedRegionId.HasValue)">
                                    <option value="">-- Select District --</option>
                                    @foreach (var district in filteredDistricts)
                                    {
                                        <option value="@district.ID">@district.Name (@district.Type)</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => model.DistrictId)" class="text-danger small" />
                                @if (!selectedRegionId.HasValue)
                                {
                                    <small class="text-muted">Select a region first</small>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Address Information -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">Address Information</h6>
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label">Street Address</label>
                                <InputText class="form-control" @bind-Value="model.Address" placeholder="e.g., Korle Bu Road" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">City <span class="text-danger">*</span></label>
                                <InputText class="form-control" @bind-Value="model.City" placeholder="e.g., Accra" />
                                <ValidationMessage For="@(() => model.City)" class="text-danger small" />
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">Contact Information</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Phone Number</label>
                                <InputText class="form-control" @bind-Value="model.Phone" placeholder="e.g., +233 XXX XXX XXX" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email Address</label>
                                <InputText class="form-control" type="email" @bind-Value="model.Email" placeholder="e.g., info@facility.com" />
                            </div>
                        </div>
                    </div>

                    <!-- GPS Location -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">GPS Location (Optional)</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Latitude</label>
                                <InputNumber class="form-control" @bind-Value="model.Latitude" placeholder="e.g., 5.5560" step="0.0001" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Longitude</label>
                                <InputNumber class="form-control" @bind-Value="model.Longitude" placeholder="e.g., -0.1969" step="0.0001" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Ghana Post GPS</label>
                                <InputText class="form-control" @bind-Value="model.GHPostGPS" placeholder="e.g., GA-123-4567" />
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-flex justify-content-end gap-2 pt-3 border-top">
                        <button type="button" class="btn btn-outline-secondary" @onclick="GoBack">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <span>Registering...</span>
                            }
                            else
                            {
                                <i class="bi bi-check-lg me-2"></i>
                                <span>Register Facility</span>
                            }
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>

    <!-- Help Panel -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Onboarding Guide</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6 class="fw-semibold">Required Fields</h6>
                    <p class="small text-muted">
                        Fields marked with <span class="text-danger">*</span> are required for facility registration.
                    </p>
                </div>
                <div class="mb-3">
                    <h6 class="fw-semibold">Facility Code</h6>
                    <p class="small text-muted">
                        Enter a unique code for the facility. This is used for identification across the system.
                        Examples: KBTH, RH, 37MH
                    </p>
                </div>
                <div class="mb-3">
                    <h6 class="fw-semibold">Location Hierarchy</h6>
                    <p class="small text-muted">
                        All facilities must be assigned to a district. Districts are organized under regions.
                    </p>
                </div>
                <div>
                    <h6 class="fw-semibold">GPS Coordinates</h6>
                    <p class="small text-muted mb-0">
                        GPS coordinates help in mapping and referral routing. You can use Ghana Post GPS addresses as well.
                    </p>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-building me-2"></i>Facility Types</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled small mb-0">
                    <li class="mb-2">
                        <strong>Hospital</strong>: Full-service medical facility with inpatient care
                    </li>
                    <li class="mb-2">
                        <strong>Clinic</strong>: Outpatient medical services
                    </li>
                    <li class="mb-2">
                        <strong>Health Center</strong>: Primary healthcare services
                    </li>
                    <li class="mb-2">
                        <strong>CHPS Compound</strong>: Community-based Health Planning and Services
                    </li>
                    <li>
                        <strong>Maternity Home</strong>: Specialized maternal care facility
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

@code {
    private FacilityOnboardingRequest model = new();
    private List<RegionSummary> regions = new();
    private List<DistrictSummary> allDistricts = new();
    private List<DistrictSummary> filteredDistricts = new();

    private Guid? selectedRegionId;
    private Guid? selectedDistrictId
    {
        get => model.DistrictId == Guid.Empty ? null : model.DistrictId;
        set
        {
            if (value.HasValue)
            {
                model.DistrictId = value.Value;
            }
        }
    }

    private bool isSubmitting = false;
    private bool showSuccess = false;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadReferenceData();
    }

    private async Task LoadReferenceData()
    {
        try
        {
            var regionsTask = RegionService.GetAllRegionSummariesAsync();
            var districtsTask = DistrictService.GetAllDistrictSummariesAsync();

            await Task.WhenAll(regionsTask, districtsTask);

            regions = await regionsTask;
            allDistricts = await districtsTask;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading reference data: {ex.Message}");
            errorMessage = "Failed to load regions and districts. Please refresh the page.";
        }
    }

    private async Task OnRegionChanged(ChangeEventArgs e)
    {
        if (Guid.TryParse(e.Value?.ToString(), out var regionId))
        {
            selectedRegionId = regionId;
            model.RegionId = regionId;

            // Filter districts by selected region
            filteredDistricts = allDistricts.Where(d => d.RegionName == regions.FirstOrDefault(r => r.ID == regionId)?.Name).ToList();

            // Reset district selection
            model.DistrictId = Guid.Empty;
        }
        else
        {
            selectedRegionId = null;
            filteredDistricts.Clear();
            model.DistrictId = Guid.Empty;
        }

        await Task.CompletedTask;
    }

    private async Task HandleSubmit()
    {
        errorMessage = string.Empty;
        showSuccess = false;

        // Validation
        if (string.IsNullOrWhiteSpace(model.Name))
        {
            errorMessage = "Facility name is required.";
            return;
        }

        if (string.IsNullOrWhiteSpace(model.Code))
        {
            errorMessage = "Facility code is required.";
            return;
        }

        if (model.RegionId == Guid.Empty)
        {
            errorMessage = "Please select a region.";
            return;
        }

        if (model.DistrictId == Guid.Empty)
        {
            errorMessage = "Please select a district.";
            return;
        }

        if (string.IsNullOrWhiteSpace(model.City))
        {
            errorMessage = "City is required.";
            return;
        }

        // Convert code to uppercase
        model.Code = model.Code.Trim().ToUpper();

        isSubmitting = true;

        try
        {
            var (success, message, facilityId) = await FacilityService.CreateFacilityAsync(model);

            if (success)
            {
                showSuccess = true;
                // Reset form for new entry
                var savedName = model.Name;
                model = new FacilityOnboardingRequest
                {
                    Name = string.Empty,
                    RegionId = model.RegionId,
                    DistrictId = model.DistrictId,
                    City = model.City
                };
                model.Name = savedName; // Keep name for success message
            }
            else
            {
                errorMessage = message;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/facilities");
    }
}
