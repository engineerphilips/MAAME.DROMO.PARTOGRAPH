@page "/facility-onboarding"
@page "/facilities/new"
@attribute [Authorize(Roles = "Admin")]
@inject IFacilityService FacilityService
@inject IRegionService RegionService
@inject IDistrictService DistrictService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Facility Onboarding - MAAME DROMO Monitoring</PageTitle>

<div class="dashboard-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <button class="btn btn-white border shadow-sm me-3 hover-lift rounded-circle p-2" @onclick="GoBack" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-arrow-left"></i>
            </button>
            <div>
                <h2 class="mb-1 text-gradient-primary fw-bold">
                    <i class="bi bi-building-plus me-2"></i>
                    Facility Onboarding
                </h2>
                <p class="text-secondary mb-0">
                    Register new health facilities onto the platform
                </p>
            </div>
        </div>
        <div>
            <a href="/facilities" class="btn btn-outline-primary shadow-sm rounded-pill px-4">
                <i class="bi bi-list-ul me-2"></i> Back to List
            </a>
        </div>
    </div>
</div>

@if (showSuccess)
{
    <div class="alert alert-success d-flex align-items-center" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        <div>
            Facility "<strong>@model.Name</strong>" has been successfully registered!
            <a href="/facilities" class="alert-link ms-2">View all facilities</a>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger d-flex align-items-center" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <div>@errorMessage</div>
    </div>
}

<div class="row">
    <div class="col-lg-8">
        <div class="glass-panel p-4 mb-4">
            <div class="d-flex align-items-center mb-4 border-bottom pb-3">
                <h5 class="mb-0 fw-bold text-dark">
                    <i class="bi bi-pencil-square me-2 text-primary"></i>
                    Facility Details
                </h5>
            </div>
            
            <EditForm Model="@model" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />
                
                <div class="row g-3">
                    <div class="col-md-12">
                        <label class="form-label fw-semibold">Facility Name <span class="text-danger">*</span></label>
                        <InputText class="form-control" @bind-Value="model.Name" placeholder="e.g. Korle Bu Teaching Hospital" />
                        <ValidationMessage For="@(() => model.Name)" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Facility Code <span class="text-danger">*</span></label>
                        <InputText class="form-control" @bind-Value="model.Code" placeholder="e.g. KBTH" />
                        <small class="text-muted">Unique identifier for the facility</small>
                        <ValidationMessage For="@(() => model.Code)" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Facility Type <span class="text-danger">*</span></label>
                        <InputSelect class="form-select" @bind-Value="model.Type">
                            <option value="">Select Type...</option>
                            <option value="Hospital">Hospital</option>
                            <option value="HealthCenter">Health Center</option>
                            <option value="Clinic">Clinic</option>
                            <option value="CHPS">CHPS Compound</option>
                            <option value="MaternityHome">Maternity Home</option>
                        </InputSelect>
                        <ValidationMessage For="@(() => model.Type)" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Facility Level <span class="text-danger">*</span></label>
                        <InputSelect class="form-select" @bind-Value="model.Level">
                            <option value="">Select Level...</option>
                            <option value="Tertiary">Tertiary</option>
                            <option value="Secondary">Secondary</option>
                            <option value="Primary">Primary</option>
                        </InputSelect>
                        <ValidationMessage For="@(() => model.Level)" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Ownership</label>
                        <InputSelect class="form-select" @bind-Value="model.Ownership">
                            <option value="Public">Public (Government)</option>
                            <option value="Private">Private</option>
                            <option value="CHAG">CHAG (Mission)</option>
                            @* <option value="Quasi">Quasi-Government</option> *@
                        </InputSelect>
                    </div>

                    <div class="col-12 mt-4">
                        <h6 class="fw-bold text-dark border-bottom pb-2 mb-3">
                            <i class="bi bi-geo-alt me-2 text-danger"></i>Location Information
                        </h6>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Region <span class="text-danger">*</span></label>
                        <select class="form-select" @onchange="OnRegionChanged" value="@selectedRegionId" disabled="@isRegionLocked">
                            <option value="">Select Region...</option>
                            @foreach (var region in regions)
                            {
                                <option value="@region.ID">@region.Name</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">District <span class="text-danger">*</span></label>
                        <select class="form-select" @bind="selectedDistrictId" disabled="@(isDistrictLocked || !selectedRegionId.HasValue)">
                            <option value="">Select District...</option>
                            @foreach (var district in filteredDistricts)
                            {
                                <option value="@district.ID">@district.Name</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">City/Town <span class="text-danger">*</span></label>
                        <InputText class="form-control" @bind-Value="model.City" />
                        <ValidationMessage For="@(() => model.City)" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Address / GPS Address</label>
                        <InputText class="form-control" @bind-Value="model.Address" placeholder="e.g. GA-123-4567" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">GPS Latitude</label>
                        <InputNumber class="form-control" @bind-Value="model.Latitude" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">GPS Longitude</label>
                        <InputNumber class="form-control" @bind-Value="model.Longitude" />
                    </div>
                    
                    <div class="col-12 mt-4 pt-3 border-top d-flex justify-content-end gap-2">
                         <button type="button" class="btn btn-outline-secondary" @onclick="GoBack">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary px-4" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Registering...</span>
                            }
                            else
                            {
                                <i class="bi bi-check-lg me-1"></i>
                                <span>Register Facility</span>
                            }
                        </button>
                    </div>
                </div>
            </EditForm>
        </div>
    </div>

    <!-- Help Panel -->
    <div class="col-lg-4">
        <div class="glass-panel p-4 mb-4">
            <div class="d-flex align-items-center mb-3 border-bottom pb-3">
                <h6 class="mb-0 fw-bold text-dark"><i class="bi bi-info-circle me-2 text-info"></i>Onboarding Guide</h6>
            </div>
            <div>
                <div class="mb-3">
                    <h6 class="fw-semibold text-dark">Required Fields</h6>
                    <p class="small text-secondary">
                        Fields marked with <span class="text-danger">*</span> are required for facility registration.
                    </p>
                </div>
                <div class="mb-3">
                    <h6 class="fw-semibold text-dark">Facility Code</h6>
                    <p class="small text-secondary">
                        Enter a unique code for the facility. This is used for identification across the system.
                        Examples: <span class="badge bg-light text-dark border">KBTH</span>, <span class="badge bg-light text-dark border">RH</span>
                    </p>
                </div>
                <div class="mb-3">
                    <h6 class="fw-semibold text-dark">Location Hierarchy</h6>
                    <p class="small text-secondary">
                        All facilities must be assigned to a district. Districts are organized under regions.
                    </p>
                </div>
                <div>
                    <h6 class="fw-semibold text-dark">GPS Coordinates</h6>
                    <p class="small text-secondary mb-0">
                        GPS coordinates help in mapping and referral routing. You can use Ghana Post GPS addresses as well.
                    </p>
                </div>
            </div>
        </div>

        <div class="glass-panel p-4">
            <div class="d-flex align-items-center mb-3 border-bottom pb-3">
                <h6 class="mb-0 fw-bold text-dark"><i class="bi bi-building me-2 text-secondary"></i>Facility Types</h6>
            </div>
            <div>
                <ul class="list-unstyled small mb-0">
                    <li class="mb-3 d-flex align-items-start">
                        <i class="bi bi-hospital text-primary me-2 fs-5"></i>
                        <div>
                            <strong class="d-block text-dark">Hospital</strong>
                            <span class="text-secondary">Full-service medical facility with inpatient care</span>
                        </div>
                    </li>
                    <li class="mb-3 d-flex align-items-start">
                        <i class="bi bi-hospital text-success me-2 fs-5"></i>
                        <div>
                            <strong class="d-block text-dark">Center</strong>
                            <span class="text-secondary">Primary healthcare services</span>
                        </div>
                    </li>
                    <li class="mb-3 d-flex align-items-start">
                        <i class="bi bi-shop text-warning me-2 fs-5"></i>
                        <div>
                            <strong class="d-block text-dark">Clinic</strong>
                            <span class="text-secondary">Outpatient medical services</span>
                        </div>
                    </li>
                    <li class="mb-3 d-flex align-items-start">
                        <i class="bi bi-house-heart text-danger me-2 fs-5"></i>
                        <div>
                            <strong class="d-block text-dark">Maternity Home</strong>
                            <span class="text-secondary">Specialized maternal care facility</span>
                        </div>
                    </li>
                    <li class="d-flex align-items-start">
                        <i class="bi bi-house-door text-info me-2 fs-5"></i>
                        <div>
                            <strong class="d-block text-dark">CHPS Compound</strong>
                            <span class="text-secondary">Community-based Health Planning and Services</span>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

@code {
    private FacilityOnboardingRequest model = new();
    private List<RegionSummary> regions = new();
    private List<DistrictSummary> allDistricts = new();
    private List<DistrictSummary> filteredDistricts = new();

    private Guid? selectedRegionId;
    private Guid? selectedDistrictId
    {
        get => model.DistrictId == Guid.Empty ? null : model.DistrictId;
        set
        {
            if (value.HasValue)
            {
                model.DistrictId = value.Value;
            }
        }
    }

    private bool isSubmitting = false;
    private bool showSuccess = false;
    private string errorMessage = string.Empty;

    // Admin access level filtering
    private string accessLevel = "National";
    private Guid? adminRegionId;
    private Guid? adminDistrictId;
    private bool isRegionLocked = false;
    private bool isDistrictLocked = false;

    protected override async Task OnInitializedAsync()
    {
        await DetermineAccessLevel();
        await LoadReferenceData();
    }

    private async Task DetermineAccessLevel()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        accessLevel = user.Claims.FirstOrDefault(c => c.Type == "AccessLevel")?.Value ?? "National";

        var regionIdClaim = user.Claims.FirstOrDefault(c => c.Type == "RegionID")?.Value;
        if (Guid.TryParse(regionIdClaim, out var regionId))
        {
            adminRegionId = regionId;
        }

        var districtIdClaim = user.Claims.FirstOrDefault(c => c.Type == "DistrictID")?.Value;
        if (Guid.TryParse(districtIdClaim, out var districtId))
        {
            adminDistrictId = districtId;
        }
    }

    private async Task LoadReferenceData()
    {
        try
        {
            var allRegions = await RegionService.GetAllRegionSummariesAsync();
            var districtsTask = DistrictService.GetAllDistrictSummariesAsync();
            allDistricts = await districtsTask;

            // Filter based on admin's access level
            if (accessLevel == "District" && adminRegionId.HasValue && adminDistrictId.HasValue)
            {
                // District admin: lock to their region and district
                regions = allRegions.Where(r => r.ID == adminRegionId.Value).ToList();
                selectedRegionId = adminRegionId;
                model.RegionId = adminRegionId.Value;

                filteredDistricts = allDistricts.Where(d => d.ID == adminDistrictId.Value).ToList();
                selectedDistrictId = adminDistrictId;
                model.DistrictId = adminDistrictId.Value;

                isRegionLocked = true;
                isDistrictLocked = true;
            }
            else if (accessLevel == "Regional" && adminRegionId.HasValue)
            {
                // Regional admin: lock to their region, can choose any district in region
                regions = allRegions.Where(r => r.ID == adminRegionId.Value).ToList();
                selectedRegionId = adminRegionId;
                model.RegionId = adminRegionId.Value;

                // Filter districts to only those in admin's region
                var regionName = regions.FirstOrDefault()?.Name;
                filteredDistricts = allDistricts.Where(d => d.RegionName == regionName).ToList();

                isRegionLocked = true;
                isDistrictLocked = false;
            }
            else
            {
                // National admin: can choose any region and district
                regions = allRegions;
                isRegionLocked = false;
                isDistrictLocked = false;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading reference data: {ex.Message}");
            errorMessage = "Failed to load regions and districts. Please refresh the page.";
        }
    }

    private async Task OnRegionChanged(ChangeEventArgs e)
    {
        if (Guid.TryParse(e.Value?.ToString(), out var regionId))
        {
            selectedRegionId = regionId;
            model.RegionId = regionId;

            // Filter districts by selected region
            filteredDistricts = allDistricts.Where(d => d.RegionName == regions.FirstOrDefault(r => r.ID == regionId)?.Name).ToList();

            // Reset district selection
            model.DistrictId = Guid.Empty;
        }
        else
        {
            selectedRegionId = null;
            filteredDistricts.Clear();
            model.DistrictId = Guid.Empty;
        }

        await Task.CompletedTask;
    }

    private async Task HandleSubmit()
    {
        errorMessage = string.Empty;
        showSuccess = false;

        // Validation
        if (string.IsNullOrWhiteSpace(model.Name))
        {
            errorMessage = "Facility name is required.";
            return;
        }

        if (string.IsNullOrWhiteSpace(model.Code))
        {
            errorMessage = "Facility code is required.";
            return;
        }

        if (model.RegionId == Guid.Empty)
        {
            errorMessage = "Please select a region.";
            return;
        }

        if (model.DistrictId == Guid.Empty)
        {
            errorMessage = "Please select a district.";
            return;
        }

        if (string.IsNullOrWhiteSpace(model.City))
        {
            errorMessage = "City is required.";
            return;
        }

        // Convert code to uppercase
        model.Code = model.Code.Trim().ToUpper();

        isSubmitting = true;

        try
        {
            var (success, message, facilityId) = await FacilityService.CreateFacilityAsync(model);

            if (success)
            {
                showSuccess = true;
                // Reset form for new entry
                var savedName = model.Name;
                model = new FacilityOnboardingRequest
                {
                    Name = string.Empty,
                    RegionId = model.RegionId,
                    DistrictId = model.DistrictId,
                    City = model.City
                };
                model.Name = savedName; // Keep name for success message
            }
            else
            {
                errorMessage = message;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/facilities");
    }
}
