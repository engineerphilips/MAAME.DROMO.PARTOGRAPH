@page "/predictive-analytics"
@page "/risk-prediction"
@attribute [Authorize]
@inject IPredictiveAnalyticsService PredictiveService

<PageTitle>Predictive Analytics - MAAME DROMO Monitoring</PageTitle>

<div class="dashboard-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2 class="mb-1">
                <i class="bi bi-graph-up-arrow me-2 text-info"></i>
                Predictive Analytics
            </h2>
            <p class="text-muted mb-0">
                ML-based risk prediction and complication forecasting
            </p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" @onclick="LoadData">
                <i class="bi bi-arrow-clockwise me-1"></i> Refresh
            </button>
        </div>
    </div>
</div>

@if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <!-- Risk Distribution Summary -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 border-start border-danger border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1">Critical Risk</p>
                            <h3 class="text-danger mb-0">@highRiskPatients.Count(p => p.RiskCategory == "Critical")</h3>
                        </div>
                        <div class="bg-danger bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-exclamation-triangle text-danger fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 border-start border-warning border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1">High Risk</p>
                            <h3 class="text-warning mb-0">@highRiskPatients.Count(p => p.RiskCategory == "High")</h3>
                        </div>
                        <div class="bg-warning bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-exclamation-circle text-warning fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 border-start border-info border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1">Moderate Risk</p>
                            <h3 class="text-info mb-0">@highRiskPatients.Count(p => p.RiskCategory == "Moderate")</h3>
                        </div>
                        <div class="bg-info bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-info-circle text-info fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 border-start border-success border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1">Model Accuracy</p>
                            <h3 class="text-success mb-0">87%</h3>
                        </div>
                        <div class="bg-success bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-check-circle text-success fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- High Risk Patients List -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-people me-2 text-danger"></i>
                        High Risk Patients
                    </h5>
                    <span class="badge bg-danger">@highRiskPatients.Count patients</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Patient</th>
                                    <th>Facility</th>
                                    <th>Risk Score</th>
                                    <th>Top Risk Factors</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var patient in highRiskPatients.OrderByDescending(p => p.OverallRiskScore).Take(10))
                                {
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="risk-score-circle @GetRiskCircleClass(patient.RiskCategory)">
                                                    @((int)patient.OverallRiskScore)
                                                </div>
                                                <div class="ms-2">
                                                    <div class="fw-semibold">@patient.PatientName</div>
                                                    <small class="text-muted">@patient.RiskCategory Risk</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <small>@patient.FacilityName</small>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column gap-1">
                                                <div class="d-flex align-items-center">
                                                    <small class="text-muted me-2" style="width: 60px;">C-Section:</small>
                                                    <div class="progress flex-grow-1" style="height: 6px;">
                                                        <div class="progress-bar @GetRiskBarClass(patient.CaesareanRisk)" style="width: @patient.CaesareanRisk%"></div>
                                                    </div>
                                                    <small class="ms-1">@patient.CaesareanRisk.ToString("F0")%</small>
                                                </div>
                                                <div class="d-flex align-items-center">
                                                    <small class="text-muted me-2" style="width: 60px;">PPH:</small>
                                                    <div class="progress flex-grow-1" style="height: 6px;">
                                                        <div class="progress-bar @GetRiskBarClass(patient.HemorrhageRisk)" style="width: @patient.HemorrhageRisk%"></div>
                                                    </div>
                                                    <small class="ms-1">@patient.HemorrhageRisk.ToString("F0")%</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            @foreach (var factor in patient.RiskFactors.OrderByDescending(f => f.Contribution).Take(2))
                                            {
                                                <span class="badge @GetFactorBadgeClass(factor.Severity) me-1">@factor.Name</span>
                                            }
                                        </td>
                                        <td class="text-end">
                                            <button class="btn btn-sm btn-outline-primary" @onclick="() => ShowPredictionDetails(patient)">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Type Distribution -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h6 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Risk Type Distribution</h6>
                </div>
                <div class="card-body">
                    @{
                        var riskTypes = new (string Name, double Value, string Color)[]
                        {
                            ("C-Section Risk", 35, "danger"),
                            ("Hemorrhage Risk", 25, "warning"),
                            ("Fetal Distress", 20, "info"),
                            ("Prolonged Labor", 15, "secondary"),
                            ("Other", 5, "dark")
                        };
                    }
                    @foreach (var (name, value, color) in riskTypes)
                    {
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="small">@name</span>
                                <span class="small fw-bold">@value%</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-@color" style="width: @value%"></div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Recommendations -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h6 class="mb-0"><i class="bi bi-lightbulb me-2"></i>AI Recommendations</h6>
                </div>
                <div class="card-body">
                    <div class="recommendation-item mb-3">
                        <div class="d-flex">
                            <i class="bi bi-shield-check text-success me-2 mt-1"></i>
                            <div>
                                <div class="fw-semibold small">Increase Monitoring</div>
                                <small class="text-muted">3 patients require increased FHR monitoring frequency</small>
                            </div>
                        </div>
                    </div>
                    <div class="recommendation-item mb-3">
                        <div class="d-flex">
                            <i class="bi bi-person-check text-info me-2 mt-1"></i>
                            <div>
                                <div class="fw-semibold small">Specialist Review</div>
                                <small class="text-muted">2 cases flagged for obstetrician review</small>
                            </div>
                        </div>
                    </div>
                    <div class="recommendation-item">
                        <div class="d-flex">
                            <i class="bi bi-hospital text-warning me-2 mt-1"></i>
                            <div>
                                <div class="fw-semibold small">Resource Allocation</div>
                                <small class="text-muted">Prepare OR for potential emergency deliveries</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Facility Risk Summary -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-building me-2"></i>Facility Risk Overview</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        @foreach (var facility in facilityRiskSummaries.Take(6))
                        {
                            <div class="col-md-4">
                                <div class="border rounded p-3">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <h6 class="mb-0">@facility.FacilityName</h6>
                                            <small class="text-muted">@facility.TotalActiveCases active cases</small>
                                        </div>
                                        <span class="badge @(facility.HighRiskCases > 3 ? "bg-danger" : "bg-warning")">
                                            @facility.HighRiskCases high risk
                                        </span>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <div class="flex-fill text-center py-2 bg-danger bg-opacity-10 rounded">
                                            <div class="fw-bold text-danger">@facility.HighRiskCases</div>
                                            <small class="text-muted">High</small>
                                        </div>
                                        <div class="flex-fill text-center py-2 bg-warning bg-opacity-10 rounded">
                                            <div class="fw-bold text-warning">@facility.ModerateRiskCases</div>
                                            <small class="text-muted">Moderate</small>
                                        </div>
                                        <div class="flex-fill text-center py-2 bg-success bg-opacity-10 rounded">
                                            <div class="fw-bold text-success">@facility.LowRiskCases</div>
                                            <small class="text-muted">Low</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Prediction Details Modal -->
@if (showDetailsModal && selectedPrediction != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-graph-up me-2"></i>
                        Risk Prediction Details
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseDetailsModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 text-center border-end">
                            <div class="risk-score-large @GetRiskCircleClass(selectedPrediction.RiskCategory)">
                                @((int)selectedPrediction.OverallRiskScore)
                            </div>
                            <h5 class="mt-2">@selectedPrediction.PatientName</h5>
                            <span class="badge @GetRiskBadgeClass(selectedPrediction.RiskCategory) fs-6">
                                @selectedPrediction.RiskCategory Risk
                            </span>
                            <div class="mt-3 small text-muted">
                                <div>Confidence: @((selectedPrediction.ConfidenceScore * 100).ToString("F0"))%</div>
                                <div>Model v@selectedPrediction.ModelVersion</div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h6>Individual Risk Scores</h6>
                            <div class="risk-scores mb-4">
                                @{
                                    var risks = new (string Name, double Value)[]
                                    {
                                        ("C-Section", selectedPrediction.CaesareanRisk),
                                        ("Hemorrhage", selectedPrediction.HemorrhageRisk),
                                        ("Prolonged Labor", selectedPrediction.ProlongedLaborRisk),
                                        ("Fetal Distress", selectedPrediction.FetalDistressRisk),
                                        ("Preeclampsia", selectedPrediction.PreeclampsiaRisk),
                                        ("Infection", selectedPrediction.InfectionRisk)
                                    };
                                }
                                @foreach (var (name, value) in risks)
                                {
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between">
                                            <span>@name</span>
                                            <span class="fw-bold @(value > 50 ? "text-danger" : value > 30 ? "text-warning" : "text-success")">
                                                @value.ToString("F0")%
                                            </span>
                                        </div>
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar @GetRiskBarClass(value)" style="width: @value%"></div>
                                        </div>
                                    </div>
                                }
                            </div>

                            <h6>Contributing Factors</h6>
                            <ul class="list-unstyled">
                                @foreach (var factor in selectedPrediction.RiskFactors)
                                {
                                    <li class="mb-2">
                                        <span class="badge @GetFactorBadgeClass(factor.Severity) me-2">@factor.Severity</span>
                                        <strong>@factor.Name:</strong> @factor.Value
                                        <small class="text-muted">(threshold: @factor.Threshold)</small>
                                    </li>
                                }
                            </ul>

                            <h6>Recommendations</h6>
                            <ul>
                                @foreach (var rec in selectedPrediction.Recommendations)
                                {
                                    <li>@rec</li>
                                }
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDetailsModal">Close</button>
                    <button type="button" class="btn btn-primary">
                        <i class="bi bi-eye me-1"></i>View Partograph
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .risk-score-circle {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
    }
    .risk-score-circle.critical { background: #dc3545; }
    .risk-score-circle.high { background: #fd7e14; }
    .risk-score-circle.moderate { background: #ffc107; color: #333; }
    .risk-score-circle.low { background: #28a745; }

    .risk-score-large {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: bold;
        color: white;
        margin: 0 auto;
    }
    .risk-score-large.critical { background: #dc3545; }
    .risk-score-large.high { background: #fd7e14; }
    .risk-score-large.moderate { background: #ffc107; color: #333; }
    .risk-score-large.low { background: #28a745; }
</style>

@code {
    private bool isLoading = true;
    private bool showDetailsModal = false;
    private RiskPrediction? selectedPrediction;

    private List<RiskPrediction> highRiskPatients = new();
    private List<FacilityRiskSummary> facilityRiskSummaries = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            var patientsTask = PredictiveService.GetHighRiskPatientsAsync();
            var facilitiesTask = PredictiveService.GetAllFacilityRiskSummariesAsync();

            await Task.WhenAll(patientsTask, facilitiesTask);

            highRiskPatients = await patientsTask;
            facilityRiskSummaries = await facilitiesTask;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowPredictionDetails(RiskPrediction prediction)
    {
        selectedPrediction = prediction;
        showDetailsModal = true;
    }

    private void CloseDetailsModal()
    {
        showDetailsModal = false;
        selectedPrediction = null;
    }

    private string GetRiskCircleClass(string category) => category.ToLower();

    private string GetRiskBadgeClass(string category) => category switch
    {
        "Critical" => "bg-danger",
        "High" => "bg-warning text-dark",
        "Moderate" => "bg-info",
        _ => "bg-success"
    };

    private string GetRiskBarClass(double value) => value switch
    {
        > 60 => "bg-danger",
        > 40 => "bg-warning",
        > 20 => "bg-info",
        _ => "bg-success"
    };

    private string GetFactorBadgeClass(string severity) => severity switch
    {
        "High" => "bg-danger",
        "Medium" => "bg-warning text-dark",
        _ => "bg-secondary"
    };
}
