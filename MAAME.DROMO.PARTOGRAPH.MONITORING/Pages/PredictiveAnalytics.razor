@page "/predictive-analytics"
@page "/risk-prediction"
@attribute [Authorize]
@inject IPredictiveAnalyticsService PredictiveService

<PageTitle>Predictive Analytics - MAAME DROMO Monitoring</PageTitle>

<div class="dashboard-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2 class="mb-1">
                <i class="bi bi-graph-up-arrow me-2 text-info"></i>
                Predictive Analytics
            </h2>
            <p class="text-muted mb-0">
                ML-based risk prediction and complication forecasting
            </p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" @onclick="LoadData">
                <i class="bi bi-arrow-clockwise me-1"></i> Refresh
            </button>
        </div>
    </div>
</div>

@if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
        <!-- Risk Distribution Summary -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="stat-card p-4 h-100 position-relative hover-lift border-start border-danger border-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-secondary text-uppercase fw-semibold mb-1" style="font-size: 0.75rem;">Critical Risk</p>
                        <h3 class="display-6 fw-bold text-dark mb-0">@highRiskPatients.Count(p => p.RiskCategory == "Critical")</h3>
                    </div>
                    <div class="bg-danger bg-opacity-10 p-3 rounded-circle">
                        <i class="bi bi-exclamation-triangle text-danger fs-3"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card p-4 h-100 position-relative hover-lift border-start border-warning border-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-secondary text-uppercase fw-semibold mb-1" style="font-size: 0.75rem;">High Risk</p>
                        <h3 class="display-6 fw-bold text-dark mb-0">@highRiskPatients.Count(p => p.RiskCategory == "High")</h3>
                    </div>
                    <div class="bg-warning bg-opacity-10 p-3 rounded-circle">
                        <i class="bi bi-exclamation-circle text-warning fs-3"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card p-4 h-100 position-relative hover-lift border-start border-info border-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-secondary text-uppercase fw-semibold mb-1" style="font-size: 0.75rem;">Moderate Risk</p>
                        <h3 class="display-6 fw-bold text-dark mb-0">@highRiskPatients.Count(p => p.RiskCategory == "Moderate")</h3>
                    </div>
                    <div class="bg-info bg-opacity-10 p-3 rounded-circle">
                        <i class="bi bi-info-circle text-info fs-3"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card p-4 h-100 position-relative hover-lift border-start border-success border-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-secondary text-uppercase fw-semibold mb-1" style="font-size: 0.75rem;">Model Accuracy</p>
                        <h3 class="display-6 fw-bold text-dark mb-0">87%</h3>
                    </div>
                    <div class="bg-success bg-opacity-10 p-3 rounded-circle">
                        <i class="bi bi-check-circle text-success fs-3"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- High Risk Patients List -->
        <div class="col-lg-8">
            <div class="glass-panel h-100 p-0 overflow-hidden">
                <div class="p-4 border-bottom border-light d-flex justify-content-between align-items-center bg-white bg-opacity-50">
                    <h5 class="mb-0 fw-bold text-dark">
                        <i class="bi bi-people-fill me-2 text-danger"></i>
                        High Risk Patients
                    </h5>
                    <span class="badge bg-danger rounded-pill shadow-sm">@highRiskPatients.Count patients</span>
                </div>
                <div class="p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="bg-light bg-opacity-50">
                                <tr>
                                    <th class="ps-4 py-3 fw-semibold text-secondary text-uppercase small tracking-wide border-bottom-0">Patient</th>
                                    <th class="py-3 fw-semibold text-secondary text-uppercase small tracking-wide border-bottom-0">Facility</th>
                                    <th class="py-3 fw-semibold text-secondary text-uppercase small tracking-wide border-bottom-0">Risk Score</th>
                                    <th class="py-3 fw-semibold text-secondary text-uppercase small tracking-wide border-bottom-0">Top Risk Factors</th>
                                    <th class="text-end pe-4 py-3 fw-semibold text-secondary text-uppercase small tracking-wide border-bottom-0">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var patient in highRiskPatients.OrderByDescending(p => p.OverallRiskScore).Take(10))
                                {
                                    <tr class="transition-all hover-bg-light">
                                        <td class="ps-4">
                                            <div class="d-flex align-items-center">
                                                <div class="risk-score-circle @GetRiskCircleClass(patient.RiskCategory) shadow-sm">
                                                    @((int)patient.OverallRiskScore)
                                                </div>
                                                <div class="ms-3">
                                                    <div class="fw-bold text-dark">@patient.PatientName</div>
                                                    <small class="text-muted"><span class="badge @GetRiskBadgeClass(patient.RiskCategory) rounded-pill" style="font-size: 0.65rem;">@patient.RiskCategory Risk</span></small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="text-dark fw-medium">@patient.FacilityName</div>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column gap-2" style="max-width: 140px;">
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <small class="text-muted" style="font-size: 0.7rem;">C-Section</small>
                                                    <small class="fw-bold text-dark">@patient.CaesareanRisk.ToString("F0")%</small>
                                                </div>
                                                <div class="progress rounded-pill bg-secondary-subtle" style="height: 4px;">
                                                    <div class="progress-bar @GetRiskBarClass(patient.CaesareanRisk) rounded-pill" style="width: @patient.CaesareanRisk%"></div>
                                                </div>
                                                <div class="d-flex align-items-center justify-content-between mt-1">
                                                    <small class="text-muted" style="font-size: 0.7rem;">PPH</small>
                                                    <small class="fw-bold text-dark">@patient.HemorrhageRisk.ToString("F0")%</small>
                                                </div>
                                                <div class="progress rounded-pill bg-secondary-subtle" style="height: 4px;">
                                                    <div class="progress-bar @GetRiskBarClass(patient.HemorrhageRisk) rounded-pill" style="width: @patient.HemorrhageRisk%"></div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            @foreach (var factor in patient.RiskFactors.OrderByDescending(f => f.Contribution).Take(2))
                                            {
                                                <span class="badge @GetFactorBadgeClass(factor.Severity) me-1 rounded-pill border border-light shadow-sm mb-1">@factor.Name</span>
                                            }
                                        </td>
                                        <td class="text-end pe-4">
                                            <button class="btn btn-sm btn-outline-primary rounded-pill px-3 shadow-sm hover-lift" @onclick="() => ShowPredictionDetails(patient)">
                                                <i class="bi bi-eye me-1"></i> Details
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Type Distribution -->
        <div class="col-lg-4">
            <div class="glass-panel p-4 mb-4">
                <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                    <h5 class="mb-0 fw-bold text-dark"><i class="bi bi-pie-chart-fill me-2 text-info"></i>Risk Distribution</h5>
                </div>
                <div class="card-body p-0">
                    @{
                        var riskTypes = new (string Name, double Value, string Color)[]
                        {
                            ("C-Section Risk", 35, "danger"),
                            ("Hemorrhage Risk", 25, "warning"),
                            ("Fetal Distress", 20, "info"),
                            ("Prolonged Labor", 15, "secondary"),
                            ("Other", 5, "dark")
                        };
                    }
                    @foreach (var (name, value, color) in riskTypes)
                    {
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="small fw-semibold text-secondary">@name</span>
                                <span class="small fw-bold text-dark">@value%</span>
                            </div>
                            <div class="progress rounded-pill bg-light" style="height: 8px;">
                                <div class="progress-bar bg-@color rounded-pill" style="width: @value%"></div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Recommendations -->
            <div class="glass-panel p-4">
                <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                    <h5 class="mb-0 fw-bold text-dark"><i class="bi bi-lightbulb-fill me-2 text-warning"></i>AI Recommendations</h5>
                </div>
                <div class="card-body p-0">
                    <div class="recommendation-item mb-3 bg-success-subtle p-3 rounded-3 border border-success-subtle">
                        <div class="d-flex">
                            <i class="bi bi-shield-check-fill text-success me-3 fs-5"></i>
                            <div>
                                <div class="fw-bold text-dark mb-1">Increase Monitoring</div>
                                <small class="text-secondary">3 patients require increased FHR monitoring frequency</small>
                            </div>
                        </div>
                    </div>
                    <div class="recommendation-item mb-3 bg-info-subtle p-3 rounded-3 border border-info-subtle">
                        <div class="d-flex">
                            <i class="bi bi-person-check-fill text-info me-3 fs-5"></i>
                            <div>
                                <div class="fw-bold text-dark mb-1">Specialist Review</div>
                                <small class="text-secondary">2 cases flagged for obstetrician review</small>
                            </div>
                        </div>
                    </div>
                    <div class="recommendation-item bg-warning-subtle p-3 rounded-3 border border-warning-subtle">
                        <div class="d-flex">
                            <i class="bi bi-hospital-fill text-warning me-3 fs-5"></i>
                            <div>
                                <div class="fw-bold text-dark mb-1">Resource Allocation</div>
                                <small class="text-secondary">Prepare OR for potential emergency deliveries</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Facility Risk Summary -->
    <div class="row mt-4 mb-4">
        <div class="col-12">
            <div class="glass-panel text-dark p-4">
                <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-building-fill me-2 text-primary"></i>Facility Risk Overview</h5>
                </div>
                <div class="card-body p-0">
                    <div class="row g-3">
                        @foreach (var facility in facilityRiskSummaries.Take(6))
                        {
                            <div class="col-md-4">
                                <div class="p-3 border border-light rounded-3 bg-light bg-opacity-25 hover-lift transition-all">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="text-truncate pe-2">
                                            <h6 class="mb-1 fw-bold text-dark text-truncate">@facility.FacilityName</h6>
                                            <small class="text-muted">@facility.TotalActiveCases active cases</small>
                                        </div>
                                        <span class="badge @(facility.HighRiskCases > 3 ? "bg-danger" : "bg-warning") rounded-pill shadow-sm">
                                            @facility.HighRiskCases high risk
                                        </span>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <div class="flex-fill text-center py-2 bg-danger bg-opacity-10 rounded-2 border border-danger-subtle">
                                            <div class="fw-bold text-danger">@facility.HighRiskCases</div>
                                            <small class="text-muted" style="font-size: 0.7rem;">High</small>
                                        </div>
                                        <div class="flex-fill text-center py-2 bg-warning bg-opacity-10 rounded-2 border border-warning-subtle">
                                            <div class="fw-bold text-warning">@facility.ModerateRiskCases</div>
                                            <small class="text-muted" style="font-size: 0.7rem;">Moderate</small>
                                        </div>
                                        <div class="flex-fill text-center py-2 bg-success bg-opacity-10 rounded-2 border border-success-subtle">
                                            <div class="fw-bold text-success">@facility.LowRiskCases</div>
                                            <small class="text-muted" style="font-size: 0.7rem;">Low</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Prediction Details Modal -->
@if (showDetailsModal && selectedPrediction != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-graph-up me-2"></i>
                        Risk Prediction Details
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseDetailsModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 text-center border-end">
                            <div class="risk-score-large @GetRiskCircleClass(selectedPrediction.RiskCategory)">
                                @((int)selectedPrediction.OverallRiskScore)
                            </div>
                            <h5 class="mt-2">@selectedPrediction.PatientName</h5>
                            <span class="badge @GetRiskBadgeClass(selectedPrediction.RiskCategory) fs-6">
                                @selectedPrediction.RiskCategory Risk
                            </span>
                            <div class="mt-3 small text-muted">
                                <div>Confidence: @((selectedPrediction.ConfidenceScore * 100).ToString("F0"))%</div>
                                <div>Model v@selectedPrediction.ModelVersion</div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h6>Individual Risk Scores</h6>
                            <div class="risk-scores mb-4">
                                @{
                                    var risks = new (string Name, double Value)[]
                                    {
                                        ("C-Section", selectedPrediction.CaesareanRisk),
                                        ("Hemorrhage", selectedPrediction.HemorrhageRisk),
                                        ("Prolonged Labor", selectedPrediction.ProlongedLaborRisk),
                                        ("Fetal Distress", selectedPrediction.FetalDistressRisk),
                                        ("Preeclampsia", selectedPrediction.PreeclampsiaRisk),
                                        ("Infection", selectedPrediction.InfectionRisk)
                                    };
                                }
                                @foreach (var (name, value) in risks)
                                {
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between">
                                            <span>@name</span>
                                            <span class="fw-bold @(value > 50 ? "text-danger" : value > 30 ? "text-warning" : "text-success")">
                                                @value.ToString("F0")%
                                            </span>
                                        </div>
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar @GetRiskBarClass(value)" style="width: @value%"></div>
                                        </div>
                                    </div>
                                }
                            </div>

                            <h6>Contributing Factors</h6>
                            <ul class="list-unstyled">
                                @foreach (var factor in selectedPrediction.RiskFactors)
                                {
                                    <li class="mb-2">
                                        <span class="badge @GetFactorBadgeClass(factor.Severity) me-2">@factor.Severity</span>
                                        <strong>@factor.Name:</strong> @factor.Value
                                        <small class="text-muted">(threshold: @factor.Threshold)</small>
                                    </li>
                                }
                            </ul>

                            <h6>Recommendations</h6>
                            <ul>
                                @foreach (var rec in selectedPrediction.Recommendations)
                                {
                                    <li>@rec</li>
                                }
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDetailsModal">Close</button>
                    <button type="button" class="btn btn-primary">
                        <i class="bi bi-eye me-1"></i>View Partograph
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .risk-score-circle {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
    }
    .risk-score-circle.critical { background: #dc3545; }
    .risk-score-circle.high { background: #fd7e14; }
    .risk-score-circle.moderate { background: #ffc107; color: #333; }
    .risk-score-circle.low { background: #28a745; }

    .risk-score-large {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: bold;
        color: white;
        margin: 0 auto;
    }
    .risk-score-large.critical { background: #dc3545; }
    .risk-score-large.high { background: #fd7e14; }
    .risk-score-large.moderate { background: #ffc107; color: #333; }
    .risk-score-large.low { background: #28a745; }
</style>

@code {
    private bool isLoading = true;
    private bool showDetailsModal = false;
    private RiskPrediction? selectedPrediction;

    private List<RiskPrediction> highRiskPatients = new();
    private List<FacilityRiskSummary> facilityRiskSummaries = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            var patientsTask = PredictiveService.GetHighRiskPatientsAsync();
            var facilitiesTask = PredictiveService.GetAllFacilityRiskSummariesAsync();

            await Task.WhenAll(patientsTask, facilitiesTask);

            highRiskPatients = await patientsTask;
            facilityRiskSummaries = await facilitiesTask;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowPredictionDetails(RiskPrediction prediction)
    {
        selectedPrediction = prediction;
        showDetailsModal = true;
    }

    private void CloseDetailsModal()
    {
        showDetailsModal = false;
        selectedPrediction = null;
    }

    private string GetRiskCircleClass(string category) => category.ToLower();

    private string GetRiskBadgeClass(string category) => category switch
    {
        "Critical" => "bg-danger",
        "High" => "bg-warning text-dark",
        "Moderate" => "bg-info",
        _ => "bg-success"
    };

    private string GetRiskBarClass(double value) => value switch
    {
        > 60 => "bg-danger",
        > 40 => "bg-warning",
        > 20 => "bg-info",
        _ => "bg-success"
    };

    private string GetFactorBadgeClass(string severity) => severity switch
    {
        "High" => "bg-danger",
        "Medium" => "bg-warning text-dark",
        _ => "bg-secondary"
    };
}
