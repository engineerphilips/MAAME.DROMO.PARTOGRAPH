@page "/facilities"
@attribute [Authorize(Roles = "Admin")]
@inject IFacilityService FacilityService
@inject IDistrictService DistrictService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Facilities - MAAME.DROMO Insight</PageTitle>

<div class="dashboard-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2 class="mb-1 text-gradient-primary fw-bold">
                <i class="bi bi-hospital me-2"></i>
                Health Facilities
            </h2>
            <p class="text-secondary mb-0">
                @accessLevelText | @filteredFacilities.Count facilities
            </p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-white border shadow-sm hover-lift" @onclick="LoadData">
                <i class="bi bi-arrow-clockwise me-1"></i> Refresh
            </button>
            <button class="btn btn-white border shadow-sm hover-lift" @onclick="ExportData">
                <i class="bi bi-download me-1"></i> Export
            </button>
            <AuthorizeView Roles="Admin">
                <Authorized>
                    <a href="/facility-onboarding" class="btn btn-primary shadow-sm hover-lift">
                        <i class="bi bi-plus-lg me-1"></i> Add Facility
                    </a>
                </Authorized>
            </AuthorizeView>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="stat-card p-4 h-100 position-relative hover-lift">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h5 class="text-secondary text-uppercase fw-bold small mb-2">Total Facilities</h5>
                    <h2 class="mb-0 fw-bold text-dark display-6">@facilities.Count</h2>
                </div>
                <div class="icon-box bg-primary-subtle text-primary rounded-circle p-3 shadow-sm d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                    <i class="bi bi-hospital fs-4"></i>
                </div>
            </div>
            <div class="mt-3 text-success small">
                <i class="bi bi-graph-up me-1"></i>
                <span>Registered across districts</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card p-4 h-100 position-relative hover-lift">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h5 class="text-secondary text-uppercase fw-bold small mb-2">Active Facilities</h5>
                    <h2 class="mb-0 fw-bold text-success display-6">@facilities.Count(f => f.IsActive)</h2>
                </div>
                <div class="icon-box bg-success-subtle text-success rounded-circle p-3 shadow-sm d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                    <i class="bi bi-check-circle fs-4"></i>
                </div>
            </div>
            <div class="mt-3 text-secondary small">
                <span>Operational status</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card p-4 h-100 position-relative hover-lift">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h5 class="text-secondary text-uppercase fw-bold small mb-2">Active Labours</h5>
                    <h2 class="mb-0 fw-bold text-warning display-6">@facilities.Sum(f => f.ActiveLabors)</h2>
                </div>
                <div class="icon-box bg-warning-subtle text-warning rounded-circle p-3 shadow-sm d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                    <i class="bi bi-hourglass-split fs-4"></i>
                </div>
            </div>
            <div class="mt-3 text-secondary small">
                <span>Ongoing cases</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card p-4 h-100 position-relative hover-lift">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h5 class="text-secondary text-uppercase fw-bold small mb-2">Today's Deliveries</h5>
                    <h2 class="mb-0 fw-bold text-info display-6">@facilities.Sum(f => f.DeliveriesToday)</h2>
                </div>
                <div class="icon-box bg-info-subtle text-info rounded-circle p-3 shadow-sm d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                    <i class="bi bi-clipboard2-pulse fs-4"></i>
                </div>
            </div>
            <div class="mt-3 text-secondary small">
                <span>Total for today</span>
            </div>
        </div>
    </div>
</div>

<!-- Filter Section -->
<div class="glass-panel mb-4 p-4">
    <div class="row g-3 align-items-center">
        <div class="col-md-4">
            <div class="input-group shadow-sm">
                <span class="input-group-text bg-white border-end-0 text-muted">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" class="form-control border-start-0 ps-0"
                       placeholder="Search facilities..."
                       @bind="searchTerm" @bind:event="oninput" />
            </div>
        </div>
        <div class="col-md-2">
            <select class="form-select shadow-sm text-secondary" @bind="typeFilter">
                <option value="">All Types</option>
                <option value="Hospital">Hospital</option>
                <option value="Health Center">Health Center</option>
                <option value="Clinic">Clinic</option>
                <option value="CHPS">CHPS Compound</option>
                <option value="Maternity Home">Maternity Home</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select shadow-sm text-secondary" @bind="levelFilter">
                <option value="">All Levels</option>
                <option value="Primary">Primary</option>
                <option value="Secondary">Secondary</option>
                <option value="Tertiary">Tertiary</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select shadow-sm text-secondary" @bind="statusFilter">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="withLabors">With Active Labours</option>
            </select>
        </div>
        <div class="col-md-2">
            <div class="btn-group w-100 shadow-sm rounded-pill" role="group">
                <button class="btn @(viewMode == "grid" ? "btn-primary" : "btn-white border")" @onclick="() => SetTab(TabState.Grid.ToString().ToLower())">
                    <i class="bi bi-grid"></i>
                </button>
                <button class="btn @(viewMode == "table" ? "btn-primary" : "btn-white border")" @onclick="() => SetTab(TabState.Table.ToString().ToLower())">
                    <i class="bi bi-list"></i>
                </button>
            </div>
        </div>
    </div>
</div>

@if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-secondary">Loading facilities...</p>
    </div>
}
else if (viewMode == "grid")
{
    <!-- Grid View -->
    <div class="row g-4 mb-4">
        @foreach (var facility in filteredFacilities)
        {
            <div class="col-md-6 col-lg-4">
                <div class="glass-panel facility-card h-100 @(!facility.IsActive ? "opacity-75" : "") p-4 hover-lift">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="facility-icon @GetFacilityIconClass(facility.Type) shadow-sm">
                            <i class="bi @GetFacilityIcon(facility.Type)"></i>
                        </div>
                        <div class="d-flex gap-2">
                            @if (facility.ActiveLabors > 0)
                            {
                                <span class="badge bg-warning text-dark rounded-pill shadow-sm">
                                    <i class="bi bi-hourglass-split me-1"></i>@facility.ActiveLabors active
                                </span>
                            }
                            <span class="badge @(facility.IsActive ? "bg-success" : "bg-secondary") rounded-pill shadow-sm">
                                @(facility.IsActive ? "Active" : "Inactive")
                            </span>
                        </div>
                    </div>

                    <h5 class="card-title mb-1 fw-bold text-dark">@facility.Name</h5>
                    <p class="text-secondary small mb-3">
                        <i class="bi bi-geo-alt me-1"></i>@facility.DistrictName
                        <span class="mx-2">|</span>
                        <span class="badge bg-light text-dark border">@facility.Type</span>
                        <span class="badge bg-light text-dark border">@facility.Level</span>
                    </p>

                    <div class="facility-stats p-2 rounded bg-light-subtle mb-3">
                        <div class="row text-center g-2">
                            <div class="col-4 border-end">
                                <div class="stat-mini">
                                    <span class="stat-value text-primary fw-bold">@facility.DeliveriesToday</span>
                                    <span class="stat-label text-secondary" style="font-size: 0.7rem;">Today</span>
                                </div>
                            </div>
                            <div class="col-4 border-end">
                                <div class="stat-mini">
                                    <span class="stat-value text-success fw-bold">@facility.DeliveriesThisMonth</span>
                                    <span class="stat-label text-secondary" style="font-size: 0.7rem;">Month</span>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-mini">
                                    <span class="stat-value text-info fw-bold">@facility.StaffCount</span>
                                    <span class="stat-label text-secondary" style="font-size: 0.7rem;">Staff</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-auto pt-3 border-top">
                        <small class="text-muted">
                            <i class="bi bi-clock me-1"></i>
                            @if (facility.LastActivityTime.HasValue)
                            {
                                @GetTimeAgo(facility.LastActivityTime.Value)
                            }
                            else
                            {
                                <span>No recent activity</span>
                            }
                        </small>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-white border shadow-sm rounded-pill px-3 hover-lift" @onclick="() => ViewFacilityDetails(facility)" title="View Details">
                                <i class="bi bi-eye"></i> Details
                            </button>
                            <a href="live-labor?facility=@facility.ID" class="btn btn-sm btn-outline-warning rounded-pill px-3 shadow-sm hover-lift" title="View Active Labours">
                                <i class="bi bi-activity"></i> Monitor
                            </a>
                        </div>
                    </div>

                    <!-- Performance Indicator -->
                    <div class="mt-3 pt-2">
                        <div class="d-flex align-items-center">
                            <span class="me-2 small text-secondary">Performance:</span>
                            <div class="progress flex-grow-1 shadow-sm" style="height: 8px; border-radius: 4px;">
                                <div class="progress-bar @GetPerformanceBarClass(facility.PerformanceStatus) rounded-pill"
                                     style="width: @GetPerformanceWidth(facility.PerformanceStatus)%"></div>
                            </div>
                            <span class="ms-2 small fw-semibold @GetPerformanceTextClass(facility.PerformanceStatus)">
                                @facility.PerformanceStatus
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}
else
{
    <!-- Table View -->
    <div class="glass-panel p-0 mb-4 overflow-hidden">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4 py-3 text-secondary small text-uppercase">Facility</th>
                        <th class="py-3 text-secondary small text-uppercase">Type</th>
                        <th class="py-3 text-secondary small text-uppercase">Level</th>
                        <th class="py-3 text-secondary small text-uppercase">District</th>
                        <th class="text-center py-3 text-secondary small text-uppercase">Active Labours</th>
                        <th class="text-center py-3 text-secondary small text-uppercase">Today</th>
                        <th class="text-center py-3 text-secondary small text-uppercase">Month</th>
                        <th class="text-center py-3 text-secondary small text-uppercase">Staff</th>
                        <th class="py-3 text-secondary small text-uppercase">Last Activity</th>
                        <th class="py-3 text-secondary small text-uppercase">Status</th>
                        <th class="text-end pe-4 py-3 text-secondary small text-uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var facility in filteredFacilities)
                    {
                        <tr class="@(!facility.IsActive ? "bg-light text-muted" : "") transition-all">
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    <div class="facility-icon-small @GetFacilityIconClass(facility.Type) me-3 shadow-sm text-white">
                                        <i class="bi @GetFacilityIcon(facility.Type)"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold text-dark">@facility.Name</div>
                                        <small class="text-secondary">@facility.Code</small>
                                    </div>
                                </div>
                            </td>
                            <td><span class="badge bg-white text-dark border shadow-sm">@facility.Type</span></td>
                            <td><span class="badge bg-white text-dark border shadow-sm">@facility.Level</span></td>
                            <td>@facility.DistrictName</td>
                            <td class="text-center">
                                @if (facility.ActiveLabors > 0)
                                {
                                    <span class="badge bg-warning text-dark rounded-pill shadow-sm">@facility.ActiveLabors</span>
                                }
                                else
                                {
                                    <span class="text-secondary">-</span>
                                }
                            </td>
                            <td class="text-center fw-bold text-primary">@facility.DeliveriesToday</td>
                            <td class="text-center">@facility.DeliveriesThisMonth</td>
                            <td class="text-center">@facility.StaffCount</td>
                            <td>
                                @if (facility.LastActivityTime.HasValue)
                                {
                                    <small class="text-secondary">@GetTimeAgo(facility.LastActivityTime.Value)</small>
                                }
                                else
                                {
                                    <small class="text-muted">-</small>
                                }
                            </td>
                            <td>
                                <span class="badge @(facility.IsActive ? "bg-success" : "bg-secondary") rounded-pill shadow-sm">
                                    @(facility.IsActive ? "Active" : "Inactive")
                                </span>
                            </td>
                            <td class="text-end pe-4">
                                <div class="btn-group btn-group-sm shadow-sm rounded-pill overflow-hidden">
                                    <button class="btn btn-outline-primary" @onclick="() => ViewFacilityDetails(facility)" title="Details">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <a href="live-labor?facility=@facility.ID" class="btn btn-outline-warning" title="Labors">
                                        <i class="bi bi-activity"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (!filteredFacilities.Any())
        {
            <div class="text-center py-5">
                <i class="bi bi-hospital text-muted opacity-25" style="font-size: 3rem;"></i>
                <p class="mt-3 text-secondary">No facilities found matching your criteria</p>
            </div>
        }
    </div>
}

<!-- Facility Details Modal -->
@if (showDetailsModal && selectedFacility != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content glass-panel border-0 shadow-lg" style="background: #fff;">
                <div class="modal-header border-bottom">
                    <h5 class="modal-title fw-bold text-gradient-primary">
                        <i class="bi bi-hospital me-2 text-primary"></i>
                        @selectedFacility.Name
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseDetailsModal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <h6 class="text-secondary text-uppercase small fw-bold mb-3">Facility Information</h6>
                            <table class="table table-borderless table-sm">
                                <tr>
                                    <td class="text-secondary">Code</td>
                                    <td class="fw-semibold">@selectedFacility.Code</td>
                                </tr>
                                <tr>
                                    <td class="text-secondary">Type</td>
                                    <td><span class="badge bg-primary-subtle text-primary rounded-pill">@selectedFacility.Type</span></td>
                                </tr>
                                <tr>
                                    <td class="text-secondary">Level</td>
                                    <td><span class="badge bg-info-subtle text-info rounded-pill">@selectedFacility.Level</span></td>
                                </tr>
                                <tr>
                                    <td class="text-secondary">District</td>
                                    <td class="fw-medium">@selectedFacility.DistrictName</td>
                                </tr>
                                <tr>
                                    <td class="text-secondary">Status</td>
                                    <td>
                                        <span class="badge @(selectedFacility.IsActive ? "bg-success" : "bg-secondary") rounded-pill">
                                            @(selectedFacility.IsActive ? "Active" : "Inactive")
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-secondary text-uppercase small fw-bold mb-3">Statistics</h6>
                            <div class="row g-3">
                                <div class="col-6">
                                    <div class="p-3 bg-primary-subtle rounded-3 text-center h-100">
                                        <h3 class="mb-0 text-primary fw-bold">@selectedFacility.DeliveriesToday</h3>
                                        <small class="text-muted small text-uppercase">Today's Deliveries</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-3 bg-success-subtle rounded-3 text-center h-100">
                                        <h3 class="mb-0 text-success fw-bold">@selectedFacility.DeliveriesThisMonth</h3>
                                        <small class="text-muted small text-uppercase">This Month</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-3 bg-warning-subtle rounded-3 text-center h-100">
                                        <h3 class="mb-0 text-warning fw-bold">@selectedFacility.ActiveLabors</h3>
                                        <small class="text-muted small text-uppercase">Active Labours</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-3 bg-info-subtle rounded-3 text-center h-100">
                                        <h3 class="mb-0 text-info fw-bold">@selectedFacility.StaffCount</h3>
                                        <small class="text-muted small text-uppercase">Staff Members</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    @if (selectedFacility.LastActivityTime.HasValue)
                    {
                        <div class="alert alert-light border shadow-sm mt-4 mb-0 d-flex align-items-center">
                            <i class="bi bi-clock me-2 text-primary"></i>
                            <div>
                                <span class="fw-medium">Last activity:</span> 
                                <span class="text-secondary">@selectedFacility.LastActivityTime.Value.ToString("MMMM dd, yyyy HH:mm")</span>
                                <small class="text-muted ms-1">(@GetTimeAgo(selectedFacility.LastActivityTime.Value))</small>
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer border-top bg-light">
                    <a href="live-labor?facility=@selectedFacility.ID" class="btn btn-warning shadow-sm hover-lift">
                        <i class="bi bi-activity me-1"></i> View Active Labours
                    </a>
                    <a href="deliveries?facility=@selectedFacility.ID" class="btn btn-primary shadow-sm hover-lift">
                        <i class="bi bi-clipboard2-pulse me-1"></i> View Deliveries
                    </a>
                    <button type="button" class="btn btn-outline-secondary" @onclick="CloseDetailsModal">Close</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .facility-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }

    .facility-icon-small {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
    }

    .facility-hospital { background: linear-gradient(135deg, #e8f4fd, #cce5ff); color: #0d6efd; }
    .facility-center { background: linear-gradient(135deg, #e8f8f0, #d1e7dd); color: #198754; }
    .facility-clinic { background: linear-gradient(135deg, #fef3e2, #fff3cd); color: #fd7e14; }
    .facility-chps { background: linear-gradient(135deg, #f0e8fd, #e2d9f3); color: #6f42c1; }
    .facility-maternity { background: linear-gradient(135deg, #fde8ee, #f8d7da); color: #dc3545; }

    .facility-card {
        transition: all 0.2s ease;
    }

    .facility-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12) !important;
    }

    .stat-mini {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .stat-mini .stat-value {
        font-size: 1.25rem;
        font-weight: 700;
    }

    .stat-mini .stat-label {
        font-size: 0.7rem;
        color: #6c757d;
        text-transform: uppercase;
    }
</style>

@code {
    private List<FacilitySummary> facilities = new();
    private bool isLoading = true;
    private string accessLevel = "District";
    private string accessLevelText = "District View";
    private string viewMode = "grid";
    
    enum TabState { Grid, Table}
    private void SetTab(string tab) => viewMode = tab;
    // Filters
    private string searchTerm = "";
    private string typeFilter = "";
    private string levelFilter = "";
    private string statusFilter = "";

    // Modal
    private bool showDetailsModal = false;
    private FacilitySummary? selectedFacility;

    private List<FacilitySummary> filteredFacilities => facilities
        .Where(f => string.IsNullOrEmpty(searchTerm) ||
                   f.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                   f.Code.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                   f.DistrictName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
        .Where(f => string.IsNullOrEmpty(typeFilter) || f.Type == typeFilter)
        .Where(f => string.IsNullOrEmpty(levelFilter) || f.Level == levelFilter)
        .Where(f => string.IsNullOrEmpty(statusFilter) ||
                   (statusFilter == "active" && f.IsActive) ||
                   (statusFilter == "inactive" && !f.IsActive) ||
                   (statusFilter == "withLabors" && f.ActiveLabors > 0))
        .OrderBy(f => f.Name)
        .ToList();

    protected override async Task OnInitializedAsync()
    {
        await DetermineAccessLevel();
        await LoadData();
    }

    private async Task DetermineAccessLevel()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        accessLevel = user.Claims.FirstOrDefault(c => c.Type == "AccessLevel")?.Value ?? "District";
        var regionName = user.Claims.FirstOrDefault(c => c.Type == "RegionName")?.Value;
        var districtName = user.Claims.FirstOrDefault(c => c.Type == "DistrictName")?.Value;

        accessLevelText = accessLevel switch
        {
            "National" => "All Facilities",
            "Regional" => $"Regional View - {regionName ?? "All Regions"}",
            "District" => $"District View - {districtName ?? "All Districts"}",
            _ => "Facilities"
        };
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            // Filter facilities based on admin's access level
            if (accessLevel == "District")
            {
                // District admin can only see facilities in their district
                var districtIdClaim = user.Claims.FirstOrDefault(c => c.Type == "DistrictID")?.Value;
                if (Guid.TryParse(districtIdClaim, out var districtId))
                {
                    facilities = await FacilityService.GetFacilitiesByDistrictAsync(districtId);
                    return;
                }
            }
            else if (accessLevel == "Regional")
            {
                // Regional admin can only see facilities in their region
                var regionIdClaim = user.Claims.FirstOrDefault(c => c.Type == "RegionID")?.Value;
                if (Guid.TryParse(regionIdClaim, out var regionId))
                {
                    facilities = await FacilityService.GetFacilitiesByRegionAsync(regionId);
                    return;
                }
            }

            // National admin can see all facilities
            facilities = await FacilityService.GetAllFacilitySummariesAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading facilities: {ex.Message}");
            // Generate demo data
            facilities = GetDemoFacilities();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ViewFacilityDetails(FacilitySummary facility)
    {
        selectedFacility = facility;
        showDetailsModal = true;
    }

    private void CloseDetailsModal()
    {
        showDetailsModal = false;
        selectedFacility = null;
    }

    private void ExportData()
    {
        // Export functionality placeholder
    }

    private string GetFacilityIcon(string type) => type switch
    {
        "Hospital" => "bi-hospital",
        "Health Center" => "bi-plus-circle",
        "Clinic" => "bi-bandaid",
        "CHPS" => "bi-house-heart",
        "Maternity Home" => "bi-heart-pulse",
        _ => "bi-hospital"
    };

    private string GetFacilityIconClass(string type) => type switch
    {
        "Hospital" => "facility-hospital",
        "Health Center" => "facility-center",
        "Clinic" => "facility-clinic",
        "CHPS" => "facility-chps",
        "Maternity Home" => "facility-maternity",
        _ => "facility-hospital"
    };

    private string GetPerformanceBarClass(string status) => status switch
    {
        "Normal" => "bg-success",
        "Warning" => "bg-warning",
        "Critical" => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetPerformanceTextClass(string status) => status switch
    {
        "Normal" => "text-success",
        "Warning" => "text-warning",
        "Critical" => "text-danger",
        _ => "text-secondary"
    };

    private int GetPerformanceWidth(string status) => status switch
    {
        "Normal" => 90,
        "Warning" => 60,
        "Critical" => 30,
        _ => 50
    };

    private string GetTimeAgo(DateTime time)
    {
        var diff = DateTime.UtcNow - time;
        if (diff.TotalMinutes < 1) return "just now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}h ago";
        if (diff.TotalDays < 30) return $"{(int)diff.TotalDays}d ago";
        return time.ToString("MMM dd");
    }

    private List<FacilitySummary> GetDemoFacilities()
    {
        return new List<FacilitySummary>
        {
            new() { ID = Guid.NewGuid(), Name = "Korle-Bu Teaching Hospital", Code = "KBTH", Type = "Hospital", Level = "Tertiary", DistrictName = "Accra Metropolitan", IsActive = true, DeliveriesToday = 15, DeliveriesThisMonth = 320, ActiveLabors = 8, StaffCount = 45, LastActivityTime = DateTime.UtcNow.AddMinutes(-15), PerformanceStatus = "Normal" },
            new() { ID = Guid.NewGuid(), Name = "Ridge Hospital", Code = "RH001", Type = "Hospital", Level = "Secondary", DistrictName = "Accra Metropolitan", IsActive = true, DeliveriesToday = 8, DeliveriesThisMonth = 180, ActiveLabors = 4, StaffCount = 28, LastActivityTime = DateTime.UtcNow.AddMinutes(-30), PerformanceStatus = "Normal" },
            new() { ID = Guid.NewGuid(), Name = "La General Hospital", Code = "LGH01", Type = "Hospital", Level = "Secondary", DistrictName = "La Dade Kotopon", IsActive = true, DeliveriesToday = 5, DeliveriesThisMonth = 95, ActiveLabors = 2, StaffCount = 18, LastActivityTime = DateTime.UtcNow.AddHours(-1), PerformanceStatus = "Normal" },
            new() { ID = Guid.NewGuid(), Name = "Achimota Health Centre", Code = "AHC01", Type = "Health Center", Level = "Primary", DistrictName = "Okaikoi North", IsActive = true, DeliveriesToday = 2, DeliveriesThisMonth = 45, ActiveLabors = 1, StaffCount = 8, LastActivityTime = DateTime.UtcNow.AddHours(-2), PerformanceStatus = "Normal" },
            new() { ID = Guid.NewGuid(), Name = "Madina Polyclinic", Code = "MPC01", Type = "Clinic", Level = "Primary", DistrictName = "La Nkwantanang Madina", IsActive = true, DeliveriesToday = 3, DeliveriesThisMonth = 52, ActiveLabors = 1, StaffCount = 12, LastActivityTime = DateTime.UtcNow.AddMinutes(-45), PerformanceStatus = "Warning" },
            new() { ID = Guid.NewGuid(), Name = "Tema General Hospital", Code = "TGH01", Type = "Hospital", Level = "Secondary", DistrictName = "Tema Metropolitan", IsActive = true, DeliveriesToday = 6, DeliveriesThisMonth = 140, ActiveLabors = 3, StaffCount = 22, LastActivityTime = DateTime.UtcNow.AddMinutes(-10), PerformanceStatus = "Normal" },
            new() { ID = Guid.NewGuid(), Name = "Ashaiman Health Centre", Code = "AHC02", Type = "Health Center", Level = "Primary", DistrictName = "Ashaiman", IsActive = true, DeliveriesToday = 1, DeliveriesThisMonth = 28, ActiveLabors = 0, StaffCount = 6, LastActivityTime = DateTime.UtcNow.AddHours(-4), PerformanceStatus = "Normal" },
            new() { ID = Guid.NewGuid(), Name = "Kasoa CHPS Compound", Code = "KCC01", Type = "CHPS", Level = "Primary", DistrictName = "Awutu Senya East", IsActive = false, DeliveriesToday = 0, DeliveriesThisMonth = 12, ActiveLabors = 0, StaffCount = 3, LastActivityTime = DateTime.UtcNow.AddDays(-5), PerformanceStatus = "Critical" },
            new() { ID = Guid.NewGuid(), Name = "Blessed Maternity Home", Code = "BMH01", Type = "Maternity Home", Level = "Primary", DistrictName = "Ga West", IsActive = true, DeliveriesToday = 2, DeliveriesThisMonth = 35, ActiveLabors = 1, StaffCount = 5, LastActivityTime = DateTime.UtcNow.AddHours(-1), PerformanceStatus = "Normal" }
        };
    }
}
