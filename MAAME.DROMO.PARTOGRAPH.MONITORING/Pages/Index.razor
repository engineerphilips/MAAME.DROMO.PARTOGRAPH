@page "/"
@attribute [Authorize]
@inject IDashboardService DashboardService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Dashboard - MAAME DROMO Insight</PageTitle>

<div class="dashboard-header mb-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
            <h2 class="mb-1">
                <i class="bi bi-speedometer2 me-2 text-primary"></i>
                Dashboard Overview
            </h2>
            <p class="text-muted mb-0">
                @accessLevelText | @locationText | @DateTime.Now.ToString("dddd, MMMM dd, yyyy")
            </p>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            <!-- Time Period Selector -->
            <div class="btn-group" role="group">
                <button class="btn @(selectedPeriod == "Today" ? "btn-primary" : "btn-outline-primary") btn-sm" @onclick='() => ChangePeriod("Today")'>Today</button>
                <button class="btn @(selectedPeriod == "Week" ? "btn-primary" : "btn-outline-primary") btn-sm" @onclick='() => ChangePeriod("Week")'>Week</button>
                <button class="btn @(selectedPeriod == "Month" ? "btn-primary" : "btn-outline-primary") btn-sm" @onclick='() => ChangePeriod("Month")'>Month</button>
                <button class="btn @(selectedPeriod == "Year" ? "btn-primary" : "btn-outline-primary") btn-sm" @onclick='() => ChangePeriod("Year")'>Year</button>
            </div>
            <button class="btn btn-outline-secondary btn-sm" @onclick="RefreshData" disabled="@isLoading">
                <i class="bi bi-arrow-clockwise me-1 @(isLoading ? "spin" : "")"></i> Refresh
            </button>
            <a href="reports" class="btn btn-primary btn-sm">
                <i class="bi bi-file-earmark-bar-graph me-1"></i> Generate Report
            </a>
        </div>
    </div>
</div>

@if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading dashboard data...</p>
    </div>
}
else if (summary != null)
{
    <!-- Enhanced KPI Cards with Sparklines -->
    <div class="row g-3 mb-4">
        <div class="col-md-6 col-lg-3">
            <div class="card stat-card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted mb-1 small">Today's Deliveries</p>
                            <h3 class="mb-0">@summary.TotalDeliveriesToday</h3>
                        </div>
                        <div class="stat-icon bg-primary-subtle text-primary">
                            <i class="bi bi-clipboard2-pulse"></i>
                        </div>
                    </div>
                    <div class="sparkline-container mt-2">
                        <canvas id="deliverySparkline" height="30"></canvas>
                    </div>
                    <div class="mt-2 d-flex justify-content-between align-items-center">
                        <small class="@(summary.DeliveryChangePercent >= 0 ? "text-success" : "text-danger")">
                            <i class="bi @(summary.DeliveryChangePercent >= 0 ? "bi-arrow-up" : "bi-arrow-down")"></i>
                            @Math.Abs(summary.DeliveryChangePercent).ToString("F1")% vs last period
                        </small>
                        <small class="text-muted">Month: @summary.TotalDeliveriesThisMonth</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card stat-card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted mb-1 small">Active Labors</p>
                            <h3 class="mb-0">@summary.ActiveLabors</h3>
                        </div>
                        <div class="stat-icon bg-warning-subtle text-warning">
                            <i class="bi bi-hourglass-split"></i>
                        </div>
                    </div>
                    <div class="sparkline-container mt-2">
                        <canvas id="laborSparkline" height="30"></canvas>
                    </div>
                    <div class="mt-2 d-flex justify-content-between align-items-center">
                        <small class="text-danger">
                            <i class="bi bi-exclamation-triangle"></i> High Risk: @summary.HighRiskLabors
                        </small>
                        @if (liveLaborSummary != null)
                        {
                            <small class="text-warning">Critical: @liveLaborSummary.CriticalCases</small>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card stat-card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted mb-1 small">Complications Today</p>
                            <h3 class="mb-0">@summary.ComplicationsToday</h3>
                        </div>
                        <div class="stat-icon bg-danger-subtle text-danger">
                            <i class="bi bi-exclamation-diamond"></i>
                        </div>
                    </div>
                    <div class="sparkline-container mt-2">
                        <canvas id="complicationSparkline" height="30"></canvas>
                    </div>
                    <div class="mt-2 d-flex justify-content-between align-items-center">
                        <small class="@(summary.ComplicationChangePercent <= 0 ? "text-success" : "text-danger")">
                            <i class="bi @(summary.ComplicationChangePercent <= 0 ? "bi-arrow-down" : "bi-arrow-up")"></i>
                            @Math.Abs(summary.ComplicationChangePercent).ToString("F1")% vs last period
                        </small>
                        <small class="text-muted">Referrals: @summary.ReferralsToday</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="card stat-card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted mb-1 small">Active Facilities</p>
                            <h3 class="mb-0">@summary.ActiveFacilities</h3>
                        </div>
                        <div class="stat-icon bg-success-subtle text-success">
                            <i class="bi bi-hospital"></i>
                        </div>
                    </div>
                    <div class="sparkline-container mt-2">
                        <canvas id="facilitySparkline" height="30"></canvas>
                    </div>
                    <div class="mt-2 d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="bi bi-building"></i> Total: @summary.TotalFacilities
                        </small>
                        <small class="text-success">@((summary.ActiveFacilities * 100.0 / Math.Max(1, summary.TotalFacilities)).ToString("F0"))% active</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Labor Monitoring Widget & Enhanced Alerts -->
    <div class="row g-4 mb-4">
        <!-- Live Labor Monitoring -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-activity me-2 text-danger"></i>
                        Live Labor Monitoring
                        <span class="badge bg-danger ms-2 pulse-badge">LIVE</span>
                    </h5>
                    <a href="live-labor" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-arrows-fullscreen me-1"></i> Full View
                    </a>
                </div>
                <div class="card-body">
                    @if (liveLaborSummary != null)
                    {
                        <!-- Summary Stats -->
                        <div class="row g-2 mb-3">
                            <div class="col">
                                <div class="live-stat-card bg-primary text-white">
                                    <div class="live-stat-value">@liveLaborSummary.TotalActiveCases</div>
                                    <div class="live-stat-label">Total Active</div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="live-stat-card bg-danger text-white">
                                    <div class="live-stat-value">@liveLaborSummary.CriticalCases</div>
                                    <div class="live-stat-label">Critical</div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="live-stat-card bg-warning text-dark">
                                    <div class="live-stat-value">@liveLaborSummary.HighRiskCases</div>
                                    <div class="live-stat-label">High Risk</div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="live-stat-card bg-info text-white">
                                    <div class="live-stat-value">@liveLaborSummary.ModerateRiskCases</div>
                                    <div class="live-stat-label">Moderate</div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="live-stat-card bg-success text-white">
                                    <div class="live-stat-value">@liveLaborSummary.NormalCases</div>
                                    <div class="live-stat-label">Normal</div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="live-stat-card bg-secondary text-white">
                                    <div class="live-stat-value">@liveLaborSummary.MeasurementsDue</div>
                                    <div class="live-stat-label">Due</div>
                                </div>
                            </div>
                        </div>

                        <!-- Critical Cases List -->
                        @if (liveLaborSummary.TopCriticalCases.Any())
                        {
                            <h6 class="text-danger mb-2"><i class="bi bi-exclamation-triangle me-1"></i> Attention Required</h6>
                            <div class="critical-cases-list">
                                @foreach (var laborCase in liveLaborSummary.TopCriticalCases.Take(4))
                                {
                                    <div class="critical-case-item @(laborCase.RiskLevel == "Critical" ? "case-critical" : "case-high")">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <div class="risk-dot @(laborCase.RiskLevel == "Critical" ? "bg-danger" : "bg-warning")"></div>
                                                <div class="ms-2">
                                                    <span class="fw-semibold">@laborCase.PatientName</span>
                                                    <small class="text-muted d-block">@laborCase.FacilityName</small>
                                                </div>
                                            </div>
                                            <div class="text-end">
                                                <div class="vital-badges">
                                                    <span class="badge @(IsVitalCritical(laborCase.LatestFHR, "FHR") ? "bg-danger" : "bg-secondary")">
                                                        FHR: @(laborCase.LatestFHR?.ToString() ?? "--")
                                                    </span>
                                                    <span class="badge bg-info">@laborCase.CurrentDilatation cm</span>
                                                    <span class="badge bg-secondary">@FormatDuration(laborCase.LaborDuration)</span>
                                                </div>
                                                @if (laborCase.AlertCount > 0)
                                                {
                                                    <small class="text-danger">@laborCase.AlertCount alerts</small>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center text-success py-3">
                                <i class="bi bi-check-circle fs-3"></i>
                                <p class="mb-0 mt-2">No critical cases at this time</p>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <!-- Enhanced Alerts Panel -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-bell me-2 text-warning"></i>
                        Alert Summary
                    </h5>
                    <a href="alerts" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                <div class="card-body p-0">
                    @if (alertSummary != null)
                    {
                        <!-- Alert Stats -->
                        <div class="p-3 border-bottom">
                            <div class="row g-2 text-center">
                                <div class="col-4">
                                    <div class="alert-stat">
                                        <span class="alert-stat-value text-danger">@alertSummary.CriticalAlerts</span>
                                        <span class="alert-stat-label">Critical</span>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="alert-stat">
                                        <span class="alert-stat-value text-warning">@alertSummary.WarningAlerts</span>
                                        <span class="alert-stat-label">Warning</span>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="alert-stat">
                                        <span class="alert-stat-value text-info">@alertSummary.InfoAlerts</span>
                                        <span class="alert-stat-label">Info</span>
                                    </div>
                                </div>
                            </div>
                            @if (alertSummary.UnacknowledgedAlerts > 0)
                            {
                                <div class="alert alert-warning py-2 px-3 mb-0 mt-2 d-flex justify-content-between align-items-center">
                                    <small><i class="bi bi-exclamation-circle me-1"></i> @alertSummary.UnacknowledgedAlerts unacknowledged</small>
                                    <a href="alerts?filter=unacknowledged" class="btn btn-warning btn-sm py-0">Review</a>
                                </div>
                            }
                        </div>

                        <!-- Alert Categories -->
                        <div class="p-3 border-bottom">
                            <small class="text-muted d-block mb-2">By Category</small>
                            <div class="d-flex gap-2 flex-wrap">
                                <span class="badge bg-danger-subtle text-danger">
                                    <i class="bi bi-heart-pulse me-1"></i>Fetal: @alertSummary.FetalAlerts
                                </span>
                                <span class="badge bg-warning-subtle text-warning">
                                    <i class="bi bi-person me-1"></i>Maternal: @alertSummary.MaternalAlerts
                                </span>
                                <span class="badge bg-info-subtle text-info">
                                    <i class="bi bi-clock me-1"></i>Labor: @alertSummary.LaborAlerts
                                </span>
                            </div>
                        </div>

                        <!-- Response Metrics -->
                        <div class="p-3">
                            <small class="text-muted d-block mb-2">Response Performance</small>
                            <div class="d-flex justify-content-between mb-1">
                                <small>Response Compliance</small>
                                <small class="fw-bold @(alertSummary.ResponseCompliancePercent >= 80 ? "text-success" : "text-warning")">
                                    @alertSummary.ResponseCompliancePercent.ToString("F0")%
                                </small>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar @(alertSummary.ResponseCompliancePercent >= 80 ? "bg-success" : "bg-warning")"
                                     style="width: @alertSummary.ResponseCompliancePercent%"></div>
                            </div>
                            <small class="text-muted mt-1 d-block">
                                Avg response: @alertSummary.AverageResponseTimeMinutes.ToString("F0") min
                            </small>
                        </div>
                    }

                    <!-- Recent Alerts -->
                    <div class="alerts-list">
                        @if (alerts?.Any() == true)
                        {
                            @foreach (var alert in alerts.Take(4))
                            {
                                <div class="alert-item p-3 border-bottom @GetAlertClass(alert.Severity)">
                                    <div class="d-flex align-items-start">
                                        <div class="alert-icon me-2">
                                            <i class="bi @GetAlertIcon(alert.Severity)"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <p class="mb-1 fw-semibold small">@alert.Title</p>
                                            <small class="text-muted">@alert.FacilityName</small>
                                            <small class="d-block text-muted">@alert.CreatedAt.ToString("MMM dd, HH:mm")</small>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="p-4 text-center text-muted">
                                <i class="bi bi-check-circle fs-1 text-success"></i>
                                <p class="mb-0 mt-2">No active alerts</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delivery Mode Chart & Facility Performance -->
    <div class="row g-4 mb-4">
        <div class="col-lg-5">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-pie-chart me-2 text-primary"></i>
                        Delivery Modes (@selectedPeriod)
                    </h5>
                </div>
                <div class="card-body">
                    @if (deliveryModes != null)
                    {
                        <div class="row">
                            <div class="col-6">
                                <canvas id="deliveryModeChart" width="200" height="200"></canvas>
                            </div>
                            <div class="col-6">
                                <div class="delivery-mode-legend">
                                    <div class="legend-item mb-2">
                                        <span class="legend-color bg-success"></span>
                                        <span class="legend-label">Normal Vaginal</span>
                                        <span class="legend-value">@deliveryModes.NormalVaginal</span>
                                    </div>
                                    <div class="legend-item mb-2">
                                        <span class="legend-color bg-info"></span>
                                        <span class="legend-label">Assisted Vaginal</span>
                                        <span class="legend-value">@deliveryModes.AssistedVaginal</span>
                                    </div>
                                    <div class="legend-item mb-2">
                                        <span class="legend-color bg-warning"></span>
                                        <span class="legend-label">Elective C-Section</span>
                                        <span class="legend-value">@deliveryModes.ElectiveCaesarean</span>
                                    </div>
                                    <div class="legend-item mb-2">
                                        <span class="legend-color bg-danger"></span>
                                        <span class="legend-label">Emergency C-Section</span>
                                        <span class="legend-value">@deliveryModes.EmergencyCaesarean</span>
                                    </div>
                                    <hr class="my-2" />
                                    <div class="legend-item">
                                        <span class="legend-label fw-bold">C-Section Rate</span>
                                        <span class="legend-value fw-bold @(deliveryModes.CaesareanPercent > 15 ? "text-warning" : "text-success")">
                                            @deliveryModes.CaesareanPercent.ToString("F1")%
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Facility Performance Scorecard -->
        <div class="col-lg-7">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-trophy me-2 text-warning"></i>
                        Facility Performance
                    </h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn @(facilityView == "top" ? "btn-success" : "btn-outline-success")" @onclick='() => SetFacilityView("top")'>
                            <i class="bi bi-arrow-up-circle me-1"></i>Top
                        </button>
                        <button class="btn @(facilityView == "bottom" ? "btn-danger" : "btn-outline-danger")" @onclick='() => SetFacilityView("bottom")'>
                            <i class="bi bi-arrow-down-circle me-1"></i>Needs Support
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3">Rank</th>
                                    <th>Facility</th>
                                    <th class="text-center">Deliveries</th>
                                    <th class="text-center">C-Section</th>
                                    <th class="text-center">Score</th>
                                    <th class="text-center">Grade</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (currentFacilities?.Any() == true)
                                {
                                    @foreach (var facility in currentFacilities.Take(5))
                                    {
                                        <tr>
                                            <td class="ps-3">
                                                <span class="rank-badge @(facilityView == "top" ? "rank-top" : "rank-bottom")">
                                                    @facility.Rank
                                                    @if (facility.RankChange != 0)
                                                    {
                                                        <i class="bi @(facility.RankChange > 0 ? "bi-arrow-up text-success" : "bi-arrow-down text-danger") ms-1 small"></i>
                                                    }
                                                </span>
                                            </td>
                                            <td>
                                                <div class="fw-semibold">@facility.FacilityName</div>
                                                <small class="text-muted">@facility.DistrictName</small>
                                            </td>
                                            <td class="text-center">@facility.TotalDeliveries</td>
                                            <td class="text-center">
                                                <span class="@(facility.CaesareanRate <= 15 ? "text-success" : "text-warning")">
                                                    @facility.CaesareanRate.ToString("F1")%
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                <div class="progress" style="height: 6px; width: 60px; margin: 0 auto;">
                                                    <div class="progress-bar @GetScoreColor(facility.OverallScore)" style="width: @facility.OverallScore%"></div>
                                                </div>
                                                <small>@facility.OverallScore.ToString("F0")</small>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge @GetGradeClass(facility.PerformanceGrade)">@facility.PerformanceGrade</span>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-4">
                                            No facility data available
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Maternal Health Indicators -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-heart-pulse me-2 text-danger"></i>
                        Maternal Health Indicators (@selectedPeriod)
                    </h5>
                </div>
                <div class="card-body">
                    @if (maternalHealth != null)
                    {
                        <div class="row g-3">
                            <!-- MMR -->
                            <div class="col-md-6 col-lg-3">
                                <div class="health-indicator-card @(maternalHealth.MMRStatus == "OnTarget" ? "indicator-success" : "indicator-warning")">
                                    <div class="indicator-header">
                                        <span class="indicator-title">Maternal Mortality Ratio</span>
                                        <span class="indicator-target">Target: &lt;@maternalHealth.WHOTargetMMR</span>
                                    </div>
                                    <div class="indicator-value">
                                        @maternalHealth.MaternalMortalityRatio.ToString("F1")
                                        <small class="indicator-unit">per 100,000</small>
                                    </div>
                                    <div class="indicator-detail">
                                        <span>@maternalHealth.MaternalDeaths deaths / @maternalHealth.TotalLiveBirths live births</span>
                                        <span class="@(maternalHealth.MMRChangePercent <= 0 ? "text-success" : "text-danger")">
                                            <i class="bi @(maternalHealth.MMRChangePercent <= 0 ? "bi-arrow-down" : "bi-arrow-up")"></i>
                                            @Math.Abs(maternalHealth.MMRChangePercent).ToString("F1")%
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- NMR -->
                            <div class="col-md-6 col-lg-3">
                                <div class="health-indicator-card @(maternalHealth.NMRStatus == "OnTarget" ? "indicator-success" : "indicator-warning")">
                                    <div class="indicator-header">
                                        <span class="indicator-title">Neonatal Mortality Rate</span>
                                        <span class="indicator-target">Target: &lt;@maternalHealth.WHOTargetNMR</span>
                                    </div>
                                    <div class="indicator-value">
                                        @maternalHealth.NeonatalMortalityRate.ToString("F1")
                                        <small class="indicator-unit">per 1,000</small>
                                    </div>
                                    <div class="indicator-detail">
                                        <span>@maternalHealth.NeonatalDeaths deaths / @maternalHealth.TotalLiveBirths live births</span>
                                        <span class="@(maternalHealth.NMRChangePercent <= 0 ? "text-success" : "text-danger")">
                                            <i class="bi @(maternalHealth.NMRChangePercent <= 0 ? "bi-arrow-down" : "bi-arrow-up")"></i>
                                            @Math.Abs(maternalHealth.NMRChangePercent).ToString("F1")%
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Stillbirth Rate -->
                            <div class="col-md-6 col-lg-3">
                                <div class="health-indicator-card @(maternalHealth.StillbirthRate <= maternalHealth.WHOTargetStillbirthRate ? "indicator-success" : "indicator-warning")">
                                    <div class="indicator-header">
                                        <span class="indicator-title">Stillbirth Rate</span>
                                        <span class="indicator-target">Target: &lt;@maternalHealth.WHOTargetStillbirthRate</span>
                                    </div>
                                    <div class="indicator-value">
                                        @maternalHealth.StillbirthRate.ToString("F1")
                                        <small class="indicator-unit">per 1,000</small>
                                    </div>
                                    <div class="indicator-detail">
                                        <span>@maternalHealth.Stillbirths stillbirths / @maternalHealth.TotalDeliveries deliveries</span>
                                        <span class="@(maternalHealth.StillbirthRateChangePercent <= 0 ? "text-success" : "text-danger")">
                                            <i class="bi @(maternalHealth.StillbirthRateChangePercent <= 0 ? "bi-arrow-down" : "bi-arrow-up")"></i>
                                            @Math.Abs(maternalHealth.StillbirthRateChangePercent).ToString("F1")%
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- C-Section Rate -->
                            <div class="col-md-6 col-lg-3">
                                <div class="health-indicator-card @(maternalHealth.CaesareanStatus == "OnTarget" ? "indicator-success" : "indicator-warning")">
                                    <div class="indicator-header">
                                        <span class="indicator-title">Caesarean Section Rate</span>
                                        <span class="indicator-target">Target: @maternalHealth.WHOTargetCaesareanRateLow-@maternalHealth.WHOTargetCaesareanRateHigh%</span>
                                    </div>
                                    <div class="indicator-value">
                                        @maternalHealth.CaesareanRate.ToString("F1")%
                                    </div>
                                    <div class="indicator-detail">
                                        <span>Complication Rate: @maternalHealth.ComplicationRate.ToString("F1")%</span>
                                        <span class="@(maternalHealth.CaesareanRateChangePercent <= 0 ? "text-success" : "text-muted")">
                                            <i class="bi @(maternalHealth.CaesareanRateChangePercent <= 0 ? "bi-arrow-down" : "bi-arrow-up")"></i>
                                            @Math.Abs(maternalHealth.CaesareanRateChangePercent).ToString("F1")%
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Geographic Performance (Regions/Districts based on access level) -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-geo-alt me-2 text-primary"></i>
                        @(accessLevel == "National" ? "Regional" : accessLevel == "Regional" ? "District" : "Facility") Performance
                    </h5>
                    @if (accessLevel == "National")
                    {
                        <a href="regions" class="btn btn-sm btn-outline-primary">View All Regions</a>
                    }
                    else if (accessLevel == "Regional")
                    {
                        <a href="districts" class="btn btn-sm btn-outline-primary">View All Districts</a>
                    }
                </div>
                <div class="card-body">
                    @if (geographicPerformance?.Any() == true)
                    {
                        <div class="row g-3">
                            @foreach (var area in geographicPerformance.Take(accessLevel == "District" ? 6 : 8))
                            {
                                <div class="col-md-6 col-lg-3">
                                    <div class="geo-performance-card @GetPerformanceClass(area.PerformanceStatus)">
                                        <div class="geo-header">
                                            <span class="geo-name">@area.Name</span>
                                            <span class="performance-badge @GetPerformanceBadgeClass(area.PerformanceStatus)">
                                                @area.PerformanceScore.ToString("F0")
                                            </span>
                                        </div>
                                        <div class="geo-stats">
                                            <div class="geo-stat">
                                                <span class="geo-stat-value">@area.TotalDeliveries</span>
                                                <span class="geo-stat-label">Deliveries</span>
                                            </div>
                                            <div class="geo-stat">
                                                <span class="geo-stat-value">@area.ActiveLabors</span>
                                                <span class="geo-stat-label">Active</span>
                                            </div>
                                            <div class="geo-stat">
                                                <span class="geo-stat-value text-@(area.HighRiskCases > 3 ? "danger" : "warning")">@area.HighRiskCases</span>
                                                <span class="geo-stat-label">High Risk</span>
                                            </div>
                                            <div class="geo-stat">
                                                <span class="geo-stat-value">@area.CaesareanRate.ToString("F0")%</span>
                                                <span class="geo-stat-label">C-Section</span>
                                            </div>
                                        </div>
                                        <div class="geo-footer">
                                            <small class="text-muted">@area.ActiveFacilities/@area.TotalFacilities facilities active</small>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-geo-alt fs-1"></i>
                            <p class="mb-0 mt-2">No geographic data available</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Links Based on Access Level -->
    <div class="row g-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-grid me-2 text-primary"></i>
                        Quick Access
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        @if (accessLevel == "National")
                        {
                            <div class="col-md-3">
                                <a href="regions" class="quick-link-card">
                                    <i class="bi bi-map text-primary"></i>
                                    <span>View All Regions</span>
                                    <small>@summary.TotalRegions regions</small>
                                </a>
                            </div>
                        }
                        @if (accessLevel == "National" || accessLevel == "Regional")
                        {
                            <div class="col-md-3">
                                <a href="districts" class="quick-link-card">
                                    <i class="bi bi-building text-info"></i>
                                    <span>View Districts</span>
                                    <small>@summary.TotalDistricts districts</small>
                                </a>
                            </div>
                        }
                        <div class="col-md-3">
                            <a href="facilities" class="quick-link-card">
                                <i class="bi bi-hospital text-success"></i>
                                <span>View Facilities</span>
                                <small>@summary.TotalFacilities facilities</small>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="live-labor" class="quick-link-card">
                                <i class="bi bi-activity text-danger"></i>
                                <span>Live Labor Board</span>
                                <small>@summary.ActiveLabors active cases</small>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="deliveries" class="quick-link-card">
                                <i class="bi bi-clipboard2-pulse text-warning"></i>
                                <span>Delivery Analytics</span>
                                <small>@summary.TotalDeliveriesThisYear this year</small>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="alerts" class="quick-link-card">
                                <i class="bi bi-bell text-danger"></i>
                                <span>Alert Management</span>
                                <small>@(alertSummary?.TotalActiveAlerts ?? 0) active alerts</small>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // Data models
    private DashboardSummary? summary;
    private DeliveryModeDistribution? deliveryModes;
    private List<DashboardAlert>? alerts;
    private MaternalHealthIndicators? maternalHealth;
    private AlertSummary? alertSummary;
    private List<FacilityPerformanceSummary>? topFacilities;
    private List<FacilityPerformanceSummary>? bottomFacilities;
    private List<GeographicPerformance>? geographicPerformance;
    private DashboardLiveLaborSummary? liveLaborSummary;

    // UI state
    private bool isLoading = true;
    private string accessLevel = "District";
    private string accessLevelText = "District View";
    private string locationText = "";
    private string selectedPeriod = "Month";
    private string facilityView = "top";

    // User context
    private Guid? userRegionId;
    private Guid? userDistrictId;

    private List<FacilityPerformanceSummary>? currentFacilities => facilityView == "top" ? topFacilities : bottomFacilities;

    protected override async Task OnInitializedAsync()
    {
        await DetermineAccessLevel();
        await LoadDashboardData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender && !isLoading && summary != null)
        {
            await InitializeCharts();
        }
    }

    private async Task DetermineAccessLevel()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        accessLevel = user.Claims.FirstOrDefault(c => c.Type == "AccessLevel")?.Value ?? "District";

        // Get user's region and district IDs
        var regionIdClaim = user.Claims.FirstOrDefault(c => c.Type == "RegionID")?.Value;
        var districtIdClaim = user.Claims.FirstOrDefault(c => c.Type == "DistrictID")?.Value;
        var regionNameClaim = user.Claims.FirstOrDefault(c => c.Type == "RegionName")?.Value;
        var districtNameClaim = user.Claims.FirstOrDefault(c => c.Type == "DistrictName")?.Value;

        if (Guid.TryParse(regionIdClaim, out var regionId))
            userRegionId = regionId;

        if (Guid.TryParse(districtIdClaim, out var districtId))
            userDistrictId = districtId;

        accessLevelText = accessLevel switch
        {
            "National" => "National Overview",
            "Regional" => "Regional View",
            "District" => "District View",
            _ => "Dashboard"
        };

        locationText = accessLevel switch
        {
            "National" => "All Regions",
            "Regional" => regionNameClaim ?? "Region",
            "District" => districtNameClaim ?? "District",
            _ => ""
        };
    }

    private DashboardFilter BuildFilter()
    {
        var filter = new DashboardFilter
        {
            Period = selectedPeriod
        };

        // Apply access level restrictions
        if (accessLevel == "Regional" && userRegionId.HasValue)
        {
            filter.RegionID = userRegionId;
        }
        else if (accessLevel == "District" && userDistrictId.HasValue)
        {
            filter.DistrictID = userDistrictId;
        }

        return filter;
    }

    private async Task LoadDashboardData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var filter = BuildFilter();

            // Load all data in parallel
            var summaryTask = DashboardService.GetDashboardSummaryAsync(filter);
            var deliveryModesTask = DashboardService.GetDeliveryModeDistributionAsync(filter);
            var alertsTask = DashboardService.GetActiveAlertsAsync(filter);
            var maternalHealthTask = DashboardService.GetMaternalHealthIndicatorsAsync(filter);
            var alertSummaryTask = DashboardService.GetAlertSummaryAsync(filter);
            var topFacilitiesTask = DashboardService.GetTopFacilitiesAsync(filter, 5);
            var bottomFacilitiesTask = DashboardService.GetBottomFacilitiesAsync(filter, 5);
            var geoPerformanceTask = DashboardService.GetGeographicPerformanceAsync(filter);
            var liveLaborTask = DashboardService.GetLiveLaborSummaryAsync(filter);

            await Task.WhenAll(
                summaryTask, deliveryModesTask, alertsTask,
                maternalHealthTask, alertSummaryTask,
                topFacilitiesTask, bottomFacilitiesTask,
                geoPerformanceTask, liveLaborTask
            );

            summary = await summaryTask;
            deliveryModes = await deliveryModesTask;
            alerts = await alertsTask;
            maternalHealth = await maternalHealthTask;
            alertSummary = await alertSummaryTask;
            topFacilities = await topFacilitiesTask;
            bottomFacilities = await bottomFacilitiesTask;
            geographicPerformance = await geoPerformanceTask;
            liveLaborSummary = await liveLaborTask;

            // Generate mock trend data if not available
            if (summary != null && !summary.DeliveryTrend.Any())
            {
                var random = new Random();
                summary.DeliveryTrend = Enumerable.Range(0, 7).Select(_ => random.Next(20, 60)).ToList();
                summary.LaborTrend = Enumerable.Range(0, 7).Select(_ => random.Next(10, 40)).ToList();
                summary.ComplicationTrend = Enumerable.Range(0, 7).Select(_ => random.Next(2, 15)).ToList();
                summary.FacilityActivityTrend = Enumerable.Range(0, 7).Select(_ => random.Next(30, 80)).ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task InitializeCharts()
    {
        try
        {
            // Initialize delivery mode chart
            if (deliveryModes != null)
            {
                await JSRuntime.InvokeVoidAsync("initializeDeliveryModeChart", new
                {
                    normalVaginal = deliveryModes.NormalVaginal,
                    assistedVaginal = deliveryModes.AssistedVaginal,
                    electiveCaesarean = deliveryModes.ElectiveCaesarean,
                    emergencyCaesarean = deliveryModes.EmergencyCaesarean
                });
            }

            // Initialize sparklines
            if (summary != null)
            {
                await JSRuntime.InvokeVoidAsync("initializeSparkline", "deliverySparkline", summary.DeliveryTrend, "#0d6efd");
                await JSRuntime.InvokeVoidAsync("initializeSparkline", "laborSparkline", summary.LaborTrend, "#ffc107");
                await JSRuntime.InvokeVoidAsync("initializeSparkline", "complicationSparkline", summary.ComplicationTrend, "#dc3545");
                await JSRuntime.InvokeVoidAsync("initializeSparkline", "facilitySparkline", summary.FacilityActivityTrend, "#198754");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing charts: {ex.Message}");
        }
    }

    private async Task RefreshData()
    {
        await LoadDashboardData();
        await InitializeCharts();
    }

    private async Task ChangePeriod(string period)
    {
        selectedPeriod = period;
        await LoadDashboardData();
        await InitializeCharts();
    }

    private void SetFacilityView(string view)
    {
        facilityView = view;
    }

    private string GetAlertClass(string severity)
    {
        return severity switch
        {
            "Critical" => "alert-critical",
            "Warning" => "alert-warning-custom",
            _ => "alert-info-custom"
        };
    }

    private string GetAlertIcon(string severity)
    {
        return severity switch
        {
            "Critical" => "bi-exclamation-octagon text-danger",
            "Warning" => "bi-exclamation-triangle text-warning",
            _ => "bi-info-circle text-info"
        };
    }

    private string GetScoreColor(double score)
    {
        return score switch
        {
            >= 80 => "bg-success",
            >= 60 => "bg-warning",
            _ => "bg-danger"
        };
    }

    private string GetGradeClass(string grade)
    {
        return grade switch
        {
            "A" => "bg-success",
            "B" => "bg-info",
            "C" => "bg-warning",
            "D" => "bg-orange text-dark",
            _ => "bg-danger"
        };
    }

    private string GetPerformanceClass(string status)
    {
        return status switch
        {
            "Good" or "Excellent" => "geo-good",
            "Warning" => "geo-warning",
            "Critical" => "geo-critical",
            _ => "geo-normal"
        };
    }

    private string GetPerformanceBadgeClass(string status)
    {
        return status switch
        {
            "Good" or "Excellent" => "badge-success",
            "Warning" => "badge-warning",
            "Critical" => "badge-danger",
            _ => "badge-secondary"
        };
    }

    private bool IsVitalCritical(int? value, string type)
    {
        if (!value.HasValue) return false;
        return type switch
        {
            "FHR" => value < 110 || value > 160,
            "BP" => value > 140,
            _ => false
        };
    }

    private string FormatDuration(TimeSpan duration)
    {
        if (duration.TotalHours >= 1)
            return $"{(int)duration.TotalHours}h {duration.Minutes}m";
        return $"{duration.Minutes}m";
    }
}
