@page "/"
@attribute [Authorize]
@inject IDashboardService DashboardService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Dashboard - MAAME DROMO Insight</PageTitle>

<div class="dashboard-header mb-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
            <h2 class="mb-1 text-gradient-primary">
                <i class="bi bi-speedometer2 me-2 text-primary"></i>
                Dashboard Overview
            </h2>
            <p class="text-secondary mb-0">
                @accessLevelText <span class="mx-2">•</span> @locationText <span class="mx-2">•</span> @DateTime.Now.ToString("dddd, MMMM dd, yyyy")
            </p>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            <!-- Time Period Selector -->
            <div class="glass-panel p-1 rounded-pill d-inline-flex shadow-sm">
                <button class="btn btn-sm px-3 rounded-pill @(selectedPeriod == "Today" ? "btn-primary shadow-sm" : "btn-transparent text-secondary hover-bg-light")" @onclick='() => ChangePeriod("Today")'>Today</button>
                <button class="btn btn-sm px-3 rounded-pill @(selectedPeriod == "Week" ? "btn-primary shadow-sm" : "btn-transparent text-secondary hover-bg-light")" @onclick='() => ChangePeriod("Week")'>Week</button>
                <button class="btn btn-sm px-3 rounded-pill @(selectedPeriod == "Month" ? "btn-primary shadow-sm" : "btn-transparent text-secondary hover-bg-light")" @onclick='() => ChangePeriod("Month")'>Month</button>
                <button class="btn btn-sm px-3 rounded-pill @(selectedPeriod == "Year" ? "btn-primary shadow-sm" : "btn-transparent text-secondary hover-bg-light")" @onclick='() => ChangePeriod("Year")'>Year</button>
            </div>
            <button class="btn btn-outline-secondary shadow-sm btn-sm px-3 rounded-pill" @onclick="RefreshData" disabled="@isLoading">
                <i class="bi bi-arrow-clockwise me-1 @(isLoading ? "spin" : "")"></i> Refresh
            </button>
            <a href="reports" class="btn btn-primary shadow-sm btn-sm px-3 rounded-pill hover-lift">
                <i class="bi bi-file-earmark-bar-graph me-1"></i> Generate Report
            </a>
        </div>
    </div>
</div>

@if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading dashboard data...</p>
    </div>
}
else if (summary != null)
{
    <!-- Enhanced KPI Cards with Sparklines -->
    <div class="row g-4 mb-4">
        <div class="col-md-6 col-lg-3">
            <div class="stat-card p-4 h-100 glass-panel hover-lift">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <p class="text-secondary text-uppercase fw-semibold small mb-1 tracking-wide">Today's Deliveries</p>
                        <h3 class="mb-0 fw-bold display-6 text-dark">@summary.TotalDeliveriesToday</h3>
                    </div>
                    <div class="stat-icon bg-primary-subtle text-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                        <i class="bi bi-clipboard2-pulse fs-3"></i>
                    </div>
                </div>
                <!-- Sparkline placeholder - in real app would interact with JS -->
                <div class="sparkline-container position-relative mb-3">
                    <canvas id="deliverySparkline" height="40" style="width: 100%;"></canvas>
                </div>
                <div class="d-flex justify-content-between align-items-center border-top border-light pt-3">
                    <div class="badge @(summary.DeliveryChangePercent >= 0 ? "bg-success-subtle text-success" : "bg-danger-subtle text-danger") rounded-pill px-3">
                        <i class="bi @(summary.DeliveryChangePercent >= 0 ? "bi-arrow-up" : "bi-arrow-down") me-1"></i>
                        @Math.Abs(summary.DeliveryChangePercent).ToString("F1")%
                    </div>
                    <small class="text-muted fw-medium">Month: @summary.TotalDeliveriesThisMonth</small>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="stat-card p-4 h-100 glass-panel hover-lift">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <p class="text-secondary text-uppercase fw-semibold small mb-1 tracking-wide">Active Labours</p>
                        <h3 class="mb-0 fw-bold display-6 text-dark">@summary.ActiveLabors</h3>
                    </div>
                    <div class="stat-icon bg-warning-subtle text-warning rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                        <i class="bi bi-hourglass-split fs-3"></i>
                    </div>
                </div>
                <div class="sparkline-container position-relative mb-3">
                    <canvas id="laborSparkline" height="40" style="width: 100%;"></canvas>
                </div>
                <div class="d-flex justify-content-between align-items-center border-top border-light pt-3">
                    <div class="d-flex gap-2">
                        <span class="badge bg-danger-subtle text-danger rounded-pill" title="High Risk">
                            <i class="bi bi-exclamation-triangle me-1"></i>@summary.HighRiskLabors
                        </span>
                        @if (liveLaborSummary != null)
                        {
                            <span class="badge bg-warning-subtle text-warning rounded-pill" title="Critical">
                                <i class="bi bi-lightning-fill me-1"></i>@liveLaborSummary.CriticalCases
                            </span>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="stat-card p-4 h-100 glass-panel hover-lift">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <p class="text-secondary text-uppercase fw-semibold small mb-1 tracking-wide">Complications</p>
                        <h3 class="mb-0 fw-bold display-6 text-dark">@summary.ComplicationsToday</h3>
                    </div>
                    <div class="stat-icon bg-danger-subtle text-danger rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                        <i class="bi bi-exclamation-diamond fs-3"></i>
                    </div>
                </div>
                <div class="sparkline-container position-relative mb-3">
                    <canvas id="complicationSparkline" height="40" style="width: 100%;"></canvas>
                </div>
                <div class="d-flex justify-content-between align-items-center border-top border-light pt-3">
                    <div class="badge @(summary.ComplicationChangePercent <= 0 ? "bg-success-subtle text-success" : "bg-danger-subtle text-danger") rounded-pill px-3">
                        <i class="bi @(summary.ComplicationChangePercent <= 0 ? "bi-arrow-down" : "bi-arrow-up") me-1"></i>
                        @Math.Abs(summary.ComplicationChangePercent).ToString("F1")%
                    </div>
                    <small class="text-muted fw-medium">Refs: @summary.ReferralsToday</small>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="stat-card p-4 h-100 glass-panel hover-lift">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <p class="text-secondary text-uppercase fw-semibold small mb-1 tracking-wide">Active Facilities</p>
                        <h3 class="mb-0 fw-bold display-6 text-dark">@summary.ActiveFacilities</h3>
                    </div>
                    <div class="stat-icon bg-success-subtle text-success rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                        <i class="bi bi-hospital fs-3"></i>
                    </div>
                </div>
                <div class="sparkline-container position-relative mb-3">
                    <canvas id="facilitySparkline" height="40" style="width: 100%;"></canvas>
                </div>
                <div class="d-flex justify-content-between align-items-center border-top border-light pt-3">
                    <small class="text-muted fw-medium">
                        <i class="bi bi-building me-1"></i>Total: @summary.TotalFacilities
                    </small>
                    <span class="text-success fw-bold small">
                        @((summary.ActiveFacilities * 100.0 / Math.Max(1, summary.TotalFacilities)).ToString("F0"))% active
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Labor Monitoring Widget & Enhanced Alerts -->
    <div class="row g-4 mb-4">
        <!-- Live Labor Monitoring -->
        <div class="col-lg-8">
            <div class="glass-panel h-100 p-0 overflow-hidden">
                <div class="p-3 border-bottom border-light d-flex justify-content-between align-items-center bg-white bg-opacity-50">
                    <h5 class="mb-0 fw-bold text-dark">
                        <i class="bi bi-activity me-2 text-danger"></i>
                        Live Labour Monitoring
                        <span class="badge bg-danger ms-2 pulse-badge fw-medium rounded-pill" style="font-size: 0.7em;">LIVE</span>
                    </h5>
                    <a href="live-labor" class="btn btn-sm btn-outline-primary rounded-pill px-3 shadow-sm hover-lift">
                        <i class="bi bi-arrows-fullscreen me-1"></i> Full View
                    </a>
                </div>
                <div class="p-4">
                    @if (liveLaborSummary != null)
                    {
                        <!-- Summary Stats -->
                        <div class="row g-3 mb-4">
                            <div class="col-6 col-md-2">
                                <div class="p-2 rounded-3 text-center bg-primary text-white shadow-sm h-100 d-flex flex-column justify-content-center hover-lift transition-all">
                                    <div class="fw-bold fs-4">@liveLaborSummary.TotalActiveCases</div>
                                    <div class="small opacity-75 text-uppercase" style="font-size: 0.65rem;">Total Active</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-2">
                                <div class="p-2 rounded-3 text-center bg-danger text-white shadow-sm h-100 d-flex flex-column justify-content-center hover-lift transition-all">
                                    <div class="fw-bold fs-4">@liveLaborSummary.CriticalCases</div>
                                    <div class="small opacity-75 text-uppercase" style="font-size: 0.65rem;">Critical</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-2">
                                <div class="p-2 rounded-3 text-center bg-warning text-dark shadow-sm h-100 d-flex flex-column justify-content-center hover-lift transition-all">
                                    <div class="fw-bold fs-4">@liveLaborSummary.HighRiskCases</div>
                                    <div class="small opacity-75 text-uppercase" style="font-size: 0.65rem;">High Risk</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-2">
                                <div class="p-2 rounded-3 text-center bg-info text-white shadow-sm h-100 d-flex flex-column justify-content-center hover-lift transition-all">
                                    <div class="fw-bold fs-4">@liveLaborSummary.ModerateRiskCases</div>
                                    <div class="small opacity-75 text-uppercase" style="font-size: 0.65rem;">Moderate</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-2">
                                <div class="p-2 rounded-3 text-center bg-success text-white shadow-sm h-100 d-flex flex-column justify-content-center hover-lift transition-all">
                                    <div class="fw-bold fs-4">@liveLaborSummary.NormalCases</div>
                                    <div class="small opacity-75 text-uppercase" style="font-size: 0.65rem;">Normal</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-2">
                                <div class="p-2 rounded-3 text-center bg-secondary text-white shadow-sm h-100 d-flex flex-column justify-content-center hover-lift transition-all">
                                    <div class="fw-bold fs-4">@liveLaborSummary.MeasurementsDue</div>
                                    <div class="small opacity-75 text-uppercase" style="font-size: 0.65rem;">Due</div>
                                </div>
                            </div>
                        </div>

                        <!-- Critical Cases List -->
                        @if (liveLaborSummary.TopCriticalCases.Any())
                        {
                            <h6 class="text-danger mb-3 fw-bold small text-uppercase tracking-wide"><i class="bi bi-exclamation-triangle-fill me-1"></i> Attention Required</h6>
                            <div class="critical-cases-list">
                                @foreach (var laborCase in liveLaborSummary.TopCriticalCases.Take(4))
                                {
                                    <div class="critical-case-item @(laborCase.RiskLevel == "Critical" ? "border-danger bg-danger bg-opacity-10" : "border-warning bg-warning bg-opacity-10") p-3 mb-3 rounded-3 shadow-sm border border-start-4 transition-all hover-lift">
                                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-shrink-0">
                                                    <span class="spinner-grow spinner-grow-sm @(laborCase.RiskLevel == "Critical" ? "text-danger" : "text-warning")" role="status" aria-hidden="true"></span>
                                                </div>
                                                <div class="ms-3">
                                                    <span class="fw-bold d-block text-dark">@laborCase.PatientName</span>
                                                    <small class="text-secondary d-flex align-items-center">
                                                        <i class="bi bi-hospital me-1"></i> @laborCase.FacilityName
                                                    </small>
                                                </div>
                                            </div>
                                            <div class="text-end ms-auto">
                                                <div class="vital-badges mb-1 d-flex gap-1 justify-content-end flex-wrap">
                                                    <span class="badge @(IsVitalCritical(laborCase.LatestFHR, "FHR") ? "bg-danger" : "bg-secondary-subtle text-secondary") rounded-pill">
                                                        FHR: @(laborCase.LatestFHR?.ToString() ?? "--")
                                                    </span>
                                                    <span class="badge bg-info-subtle text-info rounded-pill">@laborCase.CurrentDilatation cm</span>
                                                    <span class="badge bg-light text-muted border rounded-pill">@FormatDuration(laborCase.LaborDuration)</span>
                                                </div>
                                                @if (laborCase.AlertCount > 0)
                                                {
                                                    <small class="text-danger fw-bold d-block">
                                                        <i class="bi bi-bell-fill me-1"></i>@laborCase.AlertCount alerts
                                                    </small>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center text-success py-5">
                                <div class="mb-3">
                                    <i class="bi bi-check-circle-fill fs-1 text-success bg-success-subtle p-3 rounded-circle"></i>
                                </div>
                                <h5 class="fw-bold">All Clear</h5>
                                <p class="text-muted mb-0">No critical cases requiring immediate attention reported.</p>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <!-- Enhanced Alerts Panel -->
        <div class="col-lg-4">
            <div class="glass-panel h-100 p-0 overflow-hidden">
                <div class="p-3 border-bottom border-light d-flex justify-content-between align-items-center bg-white bg-opacity-50">
                    <h5 class="mb-0 fw-bold text-dark">
                        <i class="bi bi-bell-fill me-2 text-warning"></i>
                        Alert Summary
                    </h5>
                    <a href="alerts" class="btn btn-sm btn-light text-primary fw-medium rounded-pill shadow-sm">View All</a>
                </div>
                <div class="p-0">
                    @if (alertSummary != null)
                    {
                        <!-- Alert Stats -->
                        <div class="p-4 border-bottom border-light bg-light bg-opacity-25">
                            <div class="row g-2 text-center">
                                <div class="col-4">
                                    <div class="p-2 bg-white rounded-3 shadow-sm border border-danger-subtle h-100">
                                        <div class="fw-bold text-danger fs-4">@alertSummary.CriticalAlerts</div>
                                        <div class="small text-secondary fw-medium text-uppercase" style="font-size: 0.65rem;">Critical</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="p-2 bg-white rounded-3 shadow-sm border border-warning-subtle h-100">
                                        <div class="fw-bold text-warning fs-4">@alertSummary.WarningAlerts</div>
                                        <div class="small text-secondary fw-medium text-uppercase" style="font-size: 0.65rem;">Warning</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="p-2 bg-white rounded-3 shadow-sm border border-info-subtle h-100">
                                        <div class="fw-bold text-info fs-4">@alertSummary.InfoAlerts</div>
                                        <div class="small text-secondary fw-medium text-uppercase" style="font-size: 0.65rem;">Info</div>
                                    </div>
                                </div>
                            </div>
                            @if (alertSummary.UnacknowledgedAlerts > 0)
                            {
                                <div class="alert alert-warning py-2 px-3 mb-0 mt-3 d-flex justify-content-between align-items-center rounded-3 shadow-sm border-warning border-opacity-25 bg-warning-subtle text-warning-emphasis">
                                    <small class="fw-bold"><i class="bi bi-exclamation-circle-fill me-1"></i> @alertSummary.UnacknowledgedAlerts unacknowledged</small>
                                    <a href="alerts?filter=unacknowledged" class="btn btn-warning btn-sm py-0 px-2 rounded-pill fw-bold shadow-sm text-dark" style="font-size: 0.7rem;">Review</a>
                                </div>
                            }
                        </div>

                        <!-- Alert Categories -->
                        <div class="px-4 py-3 border-bottom border-light">
                            <small class="text-uppercase text-secondary fw-bold small mb-2 d-block tracking-wide">By Category</small>
                            <div class="d-flex gap-2 flex-wrap">
                                <span class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill">
                                    <i class="bi bi-heart-pulse-fill me-1"></i>Fetal: @alertSummary.FetalAlerts
                                </span>
                                <span class="badge bg-warning-subtle text-warning border border-warning-subtle rounded-pill">
                                    <i class="bi bi-person-fill me-1"></i>Maternal: @alertSummary.MaternalAlerts
                                </span>
                                <span class="badge bg-info-subtle text-info border border-info-subtle rounded-pill">
                                    <i class="bi bi-clock-fill me-1"></i>Labour: @alertSummary.LaborAlerts
                                </span>
                            </div>
                        </div>

                        <!-- Response Metrics -->
                        <div class="px-4 py-3 bg-light bg-opacity-25 border-bottom border-light">
                            <div class="d-flex justify-content-between mb-1">
                                <small class="fw-semibold text-secondary">Response Compliance</small>
                                <small class="fw-bold @(alertSummary.ResponseCompliancePercent >= 80 ? "text-success" : "text-warning")">
                                    @alertSummary.ResponseCompliancePercent.ToString("F0")%
                                </small>
                            </div>
                            <div class="progress rounded-pill bg-white border border-light shadow-sm" style="height: 8px;">
                                <div class="progress-bar rounded-pill @(alertSummary.ResponseCompliancePercent >= 80 ? "bg-success" : "bg-warning")"
                                     style="width: @alertSummary.ResponseCompliancePercent%"></div>
                            </div>
                            <small class="text-muted mt-2 d-block small">
                                <i class="bi bi-clock-history me-1"></i> Avg response time: <span class="fw-semibold text-dark">@alertSummary.AverageResponseTimeMinutes.ToString("F0") min</span>
                            </small>
                        </div>
                    }

                    <!-- Recent Alerts -->
                    <div class="d-flex justify-content-between align-items-center px-4 pt-3 pb-2">
                         <span class="text-uppercase text-secondary fw-bold small tracking-wide">Recent Alerts</span>
                    </div>
                    <div class="alerts-list">
                        @if (alerts?.Any() == true)
                        {
                            @foreach (var alert in alerts.Take(4))
                            {
                                <div class="alert-item px-4 py-3 border-bottom border-light hover-bg-light transition-all">
                                    <div class="d-flex align-items-start position-relative">
                                        <div class="alert-icon me-3 flex-shrink-0 @(alert.Severity == "Critical" ? "bg-danger-subtle text-danger" : alert.Severity == "Warning" ? "bg-warning-subtle text-warning" : "bg-info-subtle text-info") rounded-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                            <i class="bi @GetAlertIcon(alert.Severity) fs-5"></i>
                                        </div>
                                        <div class="flex-grow-1 min-w-0">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <p class="mb-1 fw-bold text-dark small text-truncate pe-2">@alert.Title</p>
                                                <small class="text-muted whitespace-nowrap" style="font-size: 0.7rem;">@alert.CreatedAt.ToString("HH:mm")</small>
                                            </div>
                                            <small class="text-secondary d-block text-truncate">@alert.FacilityName</small>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="p-5 text-center text-muted">
                                <i class="bi bi-bell-slash fs-1 text-secondary opacity-50"></i>
                                <p class="mb-0 mt-3 small">No active alerts</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delivery Mode Chart & Facility Performance -->
    <div class="row g-4 mb-4">
        <div class="col-lg-5">
            <div class="glass-panel h-100 p-0 overflow-hidden">
                <div class="p-3 border-bottom border-light d-flex justify-content-between align-items-center bg-white bg-opacity-50">
                    <h5 class="mb-0 fw-bold text-dark">
                        <i class="bi bi-pie-chart-fill me-2 text-primary"></i>
                        Delivery Modes
                        <small class="text-muted fw-normal ms-2 ps-2 border-start">@selectedPeriod</small>
                    </h5>
                </div>
                <div class="p-4">
                    @if (deliveryModes != null)
                    {
                        <div class="row align-items-center h-100">
                            <div class="col-6">
                                <div class="position-relative">
                                    <canvas id="deliveryModeChart" width="200" height="200"></canvas>
                                    @* <div class="position-absolute top-50 start-50 translate-middle text-center">
                                        <span class="d-block fw-bold small text-muted">Total</span>
                                        <span class="d-block fw-bold fs-5">@deliveryModes.Total</span>
                                    </div> *@
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="delivery-mode-legend p-3 bg-light bg-opacity-50 rounded-3 border border-light">
                                    <div class="legend-item mb-2 d-flex align-items-center">
                                        <span class="legend-color bg-success shadow-sm rounded-circle me-2" style="width: 10px; height: 10px;"></span>
                                        <span class="legend-label small fw-medium flex-grow-1">Normal</span>
                                        <span class="legend-value small fw-bold">@deliveryModes.NormalVaginal</span>
                                    </div>
                                    <div class="legend-item mb-2 d-flex align-items-center">
                                        <span class="legend-color bg-info shadow-sm rounded-circle me-2" style="width: 10px; height: 10px;"></span>
                                        <span class="legend-label small fw-medium flex-grow-1">Assisted</span>
                                        <span class="legend-value small fw-bold">@deliveryModes.AssistedVaginal</span>
                                    </div>
                                    <div class="legend-item mb-2 d-flex align-items-center">
                                        <span class="legend-color bg-warning shadow-sm rounded-circle me-2" style="width: 10px; height: 10px;"></span>
                                        <span class="legend-label small fw-medium flex-grow-1">Elective C-Sec</span>
                                        <span class="legend-value small fw-bold">@deliveryModes.ElectiveCaesarean</span>
                                    </div>
                                    <div class="legend-item mb-2 d-flex align-items-center">
                                        <span class="legend-color bg-danger shadow-sm rounded-circle me-2" style="width: 10px; height: 10px;"></span>
                                        <span class="legend-label small fw-medium flex-grow-1">Emergency C-Sec</span>
                                        <span class="legend-value small fw-bold">@deliveryModes.EmergencyCaesarean</span>
                                    </div>
                                    <hr class="my-2 border-secondary opacity-10" />
                                    <div class="legend-item d-flex align-items-center justify-content-between">
                                        <span class="legend-label fw-bold small text-dark">C-Section Rate</span>
                                        <span class="legend-value fw-bold @(deliveryModes.CaesareanPercent > 15 ? "text-danger" : "text-success")">
                                            @deliveryModes.CaesareanPercent.ToString("F1")%
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Facility Performance Scorecard -->
        <div class="col-lg-7">
            <div class="glass-panel h-100 p-0 overflow-hidden">
                <div class="p-3 border-bottom border-light d-flex justify-content-between align-items-center bg-white bg-opacity-50">
                    <h5 class="mb-0 fw-bold text-dark">
                        <i class="bi bi-trophy-fill me-2 text-warning"></i>
                        Facility Performance
                    </h5>
                    <div class="btn-group btn-group-sm rounded-pill shadow-sm bg-light p-1">
                        <button class="btn btn-sm rounded-pill px-3 @(facilityView == "top" ? "btn-white shadow-sm fw-bold text-success" : "btn-light text-muted border-0")" @onclick='() => SetFacilityView("top")'>
                            Top Performing
                        </button>
                        <button class="btn btn-sm rounded-pill px-3 @(facilityView == "bottom" ? "btn-white shadow-sm fw-bold text-danger" : "btn-light text-muted border-0")" @onclick='() => SetFacilityView("bottom")'>
                            Needs Support
                        </button>
                    </div>
                </div>
                <div class="p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="bg-light bg-opacity-50">
                                <tr>
                                    <th class="ps-4 py-3 fw-semibold text-secondary text-uppercase small tracking-wide border-bottom-0">Rank</th>
                                    <th class="py-3 fw-semibold text-secondary text-uppercase small tracking-wide border-bottom-0">Facility</th>
                                    <th class="text-center py-3 fw-semibold text-secondary text-uppercase small tracking-wide border-bottom-0">Deliveries</th>
                                    <th class="text-center py-3 fw-semibold text-secondary text-uppercase small tracking-wide border-bottom-0">C-Section</th>
                                    <th class="text-center py-3 fw-semibold text-secondary text-uppercase small tracking-wide border-bottom-0">Score</th>
                                    <th class="text-center py-3 fw-semibold text-secondary text-uppercase small tracking-wide pe-4 border-bottom-0">Grade</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (currentFacilities?.Any() == true)
                                {
                                    @foreach (var facility in currentFacilities.Take(5))
                                    {
                                        <tr class="transition-all hover-bg-light">
                                            <td class="ps-4">
                                                <span class="rank-badge @(facilityView == "top" ? "rank-top text-success bg-success-subtle border-success-subtle" : "rank-bottom text-danger bg-danger-subtle border-danger-subtle") fw-bold rounded-circle border d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                    @facility.Rank
                                                </span>
                                            </td>
                                            <td>
                                                <div class="fw-bold text-dark">@facility.FacilityName</div>
                                                <small class="text-muted d-block">@facility.DistrictName</small>
                                            </td>
                                            <td class="text-center text-secondary fw-medium">@facility.TotalDeliveries</td>
                                            <td class="text-center">
                                                <span class="badge @(facility.CaesareanRate <= 15 ? "bg-success-subtle text-success border border-success-subtle" : "bg-warning-subtle text-warning border border-warning-subtle") rounded-pill">
                                                    @facility.CaesareanRate.ToString("F1")%
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                <div class="progress rounded-pill bg-light border border-light" style="height: 6px; width: 60px; margin: 0 auto; margin-bottom: 4px;">
                                                    <div class="progress-bar rounded-pill @GetScoreColor(facility.OverallScore)" style="width: @facility.OverallScore%"></div>
                                                </div>
                                                <small class="fw-bold text-dark">@facility.OverallScore.ToString("F0")</small>
                                            </td>
                                            <td class="text-center pe-4">
                                                <span class="badge @GetGradeClass(facility.PerformanceGrade) rounded-circle shadow-sm border border-light d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">@facility.PerformanceGrade</span>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-5">
                                            <i class="bi bi-inbox fs-1 d-block mb-3 opacity-25"></i>
                                            No facility data available
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Maternal Health Indicators -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="glass-panel p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0 fw-bold text-dark">
                        <i class="bi bi-heart-pulse-fill me-2 text-danger"></i>
                        Maternal Health Indicators
                        <small class="text-muted fw-normal ms-2 ps-2 border-start">@selectedPeriod</small>
                    </h5>
                </div>
                @if (maternalHealth != null)
                {
                    <div class="row g-4">
                        <!-- MMR -->
                        <div class="col-md-6 col-lg-3">
                            <div class="stat-card h-100 p-4 position-relative overflow-hidden @(maternalHealth.MMRStatus == "OnTarget" ? "border-success-subtle bg-success-subtle bg-opacity-10" : "border-warning-subtle bg-warning-subtle bg-opacity-10") hover-lift transition-all">
                                    <div class="position-absolute top-0 end-0 p-3 opacity-10">
                                    <i class="bi bi-person-heart fs-1"></i>
                                </div>
                                <div class="position-relative z-1">
                                    <div class="text-secondary text-uppercase fw-bold small mb-2 tracking-wide">Maternal Mortality</div>
                                    <div class="mb-1">
                                        <span class="display-6 fw-bold text-dark">@maternalHealth.MaternalMortalityRatio.ToString("F1")</span>
                                        <span class="fs-6 text-muted">/ 100k</span>
                                    </div>
                                    <div class="mb-3 text-secondary small">Target: &lt;@maternalHealth.WHOTargetMMR</div>
                                    
                                    <div class="d-flex justify-content-between align-items-center pt-3 border-top border-light">
                                        <span class="small fw-medium text-muted">@maternalHealth.MaternalDeaths deaths</span>
                                        <span class="badge @(maternalHealth.MMRChangePercent <= 0 ? "bg-success-subtle text-success" : "bg-danger-subtle text-danger") rounded-pill">
                                            <i class="bi @(maternalHealth.MMRChangePercent <= 0 ? "bi-arrow-down" : "bi-arrow-up") me-1"></i>
                                            @Math.Abs(maternalHealth.MMRChangePercent).ToString("F1")%
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- NMR -->
                        <div class="col-md-6 col-lg-3">
                            <div class="stat-card h-100 p-4 position-relative overflow-hidden @(maternalHealth.NMRStatus == "OnTarget" ? "border-success-subtle bg-success-subtle bg-opacity-10" : "border-warning-subtle bg-warning-subtle bg-opacity-10") hover-lift transition-all">
                                <div class="position-absolute top-0 end-0 p-3 opacity-10">
                                    <i class="bi bi-emoji-smile fs-1"></i>
                                </div>
                                <div class="position-relative z-1">
                                    <div class="text-secondary text-uppercase fw-bold small mb-2 tracking-wide">Neonatal Mortality</div>
                                    <div class="mb-1">
                                        <span class="display-6 fw-bold text-dark">@maternalHealth.NeonatalMortalityRate.ToString("F1")</span>
                                        <span class="fs-6 text-muted">/ 1k</span>
                                    </div>
                                    <div class="mb-3 text-secondary small">Target: &lt;@maternalHealth.WHOTargetNMR</div>

                                    <div class="d-flex justify-content-between align-items-center pt-3 border-top border-light">
                                        <span class="small fw-medium text-muted">@maternalHealth.NeonatalDeaths deaths</span>
                                        <span class="badge @(maternalHealth.NMRChangePercent <= 0 ? "bg-success-subtle text-success" : "bg-danger-subtle text-danger") rounded-pill">
                                            <i class="bi @(maternalHealth.NMRChangePercent <= 0 ? "bi-arrow-down" : "bi-arrow-up") me-1"></i>
                                            @Math.Abs(maternalHealth.NMRChangePercent).ToString("F1")%
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stillbirth Rate -->
                        <div class="col-md-6 col-lg-3">
                            <div class="stat-card h-100 p-4 position-relative overflow-hidden @(maternalHealth.StillbirthRate <= maternalHealth.WHOTargetStillbirthRate ? "border-success-subtle bg-success-subtle bg-opacity-10" : "border-warning-subtle bg-warning-subtle bg-opacity-10") hover-lift transition-all">
                                <div class="position-absolute top-0 end-0 p-3 opacity-10">
                                    <i class="bi bi-bandaid fs-1"></i>
                                </div>
                                <div class="position-relative z-1">
                                    <div class="text-secondary text-uppercase fw-bold small mb-2 tracking-wide">Stillbirth Rate</div>
                                    <div class="mb-1">
                                        <span class="display-6 fw-bold text-dark">@maternalHealth.StillbirthRate.ToString("F1")</span>
                                        <span class="fs-6 text-muted">/ 1k</span>
                                    </div>
                                    <div class="mb-3 text-secondary small">Target: &lt;@maternalHealth.WHOTargetStillbirthRate</div>

                                    <div class="d-flex justify-content-between align-items-center pt-3 border-top border-light">
                                        <span class="small fw-medium text-muted">@maternalHealth.Stillbirths stillbirths</span>
                                        <span class="badge @(maternalHealth.StillbirthRateChangePercent <= 0 ? "bg-success-subtle text-success" : "bg-danger-subtle text-danger") rounded-pill">
                                            <i class="bi @(maternalHealth.StillbirthRateChangePercent <= 0 ? "bi-arrow-down" : "bi-arrow-up") me-1"></i>
                                            @Math.Abs(maternalHealth.StillbirthRateChangePercent).ToString("F1")%
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- C-Section Rate -->
                        <div class="col-md-6 col-lg-3">
                            <div class="stat-card h-100 p-4 position-relative overflow-hidden @(maternalHealth.CaesareanStatus == "OnTarget" ? "border-success-subtle bg-success-subtle bg-opacity-10" : "border-warning-subtle bg-warning-subtle bg-opacity-10") hover-lift transition-all">
                                <div class="position-absolute top-0 end-0 p-3 opacity-10">
                                    <i class="bi bi-clipboard-pulse fs-1"></i>
                                </div>
                                <div class="position-relative z-1">
                                    <div class="text-secondary text-uppercase fw-bold small mb-2 tracking-wide">C-Section Rate</div>
                                    <div class="mb-1">
                                        <span class="display-6 fw-bold text-dark">@maternalHealth.CaesareanRate.ToString("F1")%</span>
                                    </div>
                                    <div class="mb-3 text-secondary small">Target: @maternalHealth.WHOTargetCaesareanRateLow-@maternalHealth.WHOTargetCaesareanRateHigh%</div>

                                    <div class="d-flex justify-content-between align-items-center pt-3 border-top border-light">
                                        <span class="small fw-medium text-muted">Comp. Rate: @maternalHealth.ComplicationRate.ToString("F1")%</span>
                                        <span class="badge @(maternalHealth.CaesareanRateChangePercent <= 0 ? "bg-success-subtle text-success" : "bg-secondary-subtle text-dark") rounded-pill">
                                            <i class="bi @(maternalHealth.CaesareanRateChangePercent <= 0 ? "bi-arrow-down" : "bi-arrow-up") me-1"></i>
                                            @Math.Abs(maternalHealth.CaesareanRateChangePercent).ToString("F1")%
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Geographic Performance (Regions/Districts based on access level) -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="glass-panel p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0 fw-bold text-dark">
                        <i class="bi bi-geo-alt-fill me-2 text-primary"></i>
                        @(accessLevel == "National" ? "Regional" : accessLevel == "Regional" ? "District" : "Facility") Performance
                    </h5>
                    @if (accessLevel == "National")
                    {
                        <a href="regions" class="btn btn-sm btn-outline-primary rounded-pill px-3 shadow-sm hover-lift">View All Regions</a>
                    }
                    else if (accessLevel == "Regional")
                    {
                        <a href="districts" class="btn btn-sm btn-outline-primary rounded-pill px-3 shadow-sm hover-lift">View All Districts</a>
                    }
                </div>
                <div>
                    @if (geographicPerformance?.Any() == true)
                    {
                        <div class="row g-4">
                            @foreach (var area in geographicPerformance.Take(accessLevel == "District" ? 6 : 8))
                            {
                                <div class="col-md-6 col-lg-3">
                                    <div class="stat-card h-100 p-4 @GetPerformanceClass(area.PerformanceStatus) hover-lift transition-all border border-light">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div class="text-truncate pe-2">
                                                <h6 class="mb-1 fw-bold text-dark text-truncate">@area.Name</h6>
                                                <small class="text-muted">@area.ActiveFacilities active</small>
                                            </div>
                                            <span class="badge rounded-pill @GetPerformanceBadgeClass(area.PerformanceStatus)">
                                                Score: @area.PerformanceScore.ToString("F0")
                                            </span>
                                        </div>
                                        <div class="bg-light bg-opacity-50 rounded-3 p-2 border border-light">
                                            <div class="row g-0 text-center">
                                                <div class="col-3 border-end border-light">
                                                    <span class="fw-bold text-dark d-block">@area.TotalDeliveries</span>
                                                    <span class="small text-secondary" style="font-size: 0.65rem;">Deliv.</span>
                                                </div>
                                                <div class="col-3 border-end border-light">
                                                    <span class="fw-bold text-dark d-block">@area.ActiveLabors</span>
                                                    <span class="small text-secondary" style="font-size: 0.65rem;">Active</span>
                                                </div>
                                                <div class="col-3 border-end border-light">
                                                    <span class="fw-bold text-@(area.HighRiskCases > 3 ? "danger" : "warning") d-block">@area.HighRiskCases</span>
                                                    <span class="small text-secondary" style="font-size: 0.65rem;">Risks</span>
                                                </div>
                                                <div class="col-3">
                                                    <span class="fw-bold text-dark d-block">@area.CaesareanRate.ToString("F0")%</span>
                                                    <span class="small text-secondary" style="font-size: 0.65rem;">C-Sec</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-geo-alt fs-1 opacity-25"></i>
                            <p class="mb-0 mt-3">No geographic data available</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Links Based on Access Level -->
    <div class="row g-4">
        <div class="col-12">
            <div class="glass-panel p-4 bg-light bg-opacity-10">
                <h5 class="fw-bold mb-4 text-center text-secondary text-uppercase tracking-wide small">Quick Access</h5>
                <div class="row g-3 justify-content-center">
                    @if (accessLevel == "National")
                    {
                        <div class="col-md-3">
                            <a href="regions" class="stat-card h-100 text-center text-decoration-none p-4 d-block hover-lift transition-all border border-light">
                                <div class="p-3 bg-primary-subtle text-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                    <i class="bi bi-map-fill fs-3"></i>
                                </div>
                                <span class="d-block fw-bold text-dark mb-1">View All Regions</span>
                                <small class="text-muted">@summary.TotalRegions regions</small>
                            </a>
                        </div>
                    }
                    @if (accessLevel == "National" || accessLevel == "Regional")
                    {
                        <div class="col-md-3">
                            <a href="districts" class="stat-card h-100 text-center text-decoration-none p-4 d-block hover-lift transition-all border border-light">
                                <div class="p-3 bg-info-subtle text-info rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                    <i class="bi bi-building-fill fs-3"></i>
                                </div>
                                <span class="d-block fw-bold text-dark mb-1">View Districts</span>
                                <small class="text-muted">@summary.TotalDistricts districts</small>
                            </a>
                        </div>
                    }
                    <div class="col-md-3">
                        <a href="facilities" class="stat-card h-100 text-center text-decoration-none p-4 d-block hover-lift transition-all border border-light">
                            <div class="p-3 bg-success-subtle text-success rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                <i class="bi bi-hospital-fill fs-3"></i>
                            </div>
                            <span class="d-block fw-bold text-dark mb-1">View Facilities</span>
                            <small class="text-muted">@summary.TotalFacilities facilities</small>
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="live-labor" class="stat-card h-100 text-center text-decoration-none p-4 d-block hover-lift transition-all border border-light">
                            <div class="p-3 bg-danger-subtle text-danger rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                <i class="bi bi-activity fs-3"></i>
                            </div>
                            <span class="d-block fw-bold text-dark mb-1">Live Labour Board</span>
                            <small class="text-muted">@summary.ActiveLabors active cases</small>
                        </a>
                    </div>
                    <div class="col-md-3">
                            <a href="reports" class="stat-card h-100 text-center text-decoration-none p-4 d-block hover-lift transition-all border border-light">
                            <div class="p-3 bg-warning-subtle text-warning rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                <i class="bi bi-file-earmark-bar-graph-fill fs-3"></i>
                            </div>
                            <span class="d-block fw-bold text-dark mb-1">Generate Report</span>
                            <small class="text-muted">Export data</small>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // Data models
    private DashboardSummary? summary;
    private DeliveryModeDistribution? deliveryModes;
    private List<DashboardAlert>? alerts;
    private MaternalHealthIndicators? maternalHealth;
    private AlertSummary? alertSummary;
    private List<FacilityPerformanceSummary>? topFacilities;
    private List<FacilityPerformanceSummary>? bottomFacilities;
    private List<GeographicPerformance>? geographicPerformance;
    private DashboardLiveLaborSummary? liveLaborSummary;

    // UI state
    private bool isLoading = true;
    private string accessLevel = "District";
    private string accessLevelText = "District View";
    private string locationText = "";
    private string selectedPeriod = "Month";
    private string facilityView = "top";

    // User context
    private Guid? userRegionId;
    private Guid? userDistrictId;
    private Guid? userFacilityId;

    private List<FacilityPerformanceSummary>? currentFacilities => facilityView == "top" ? topFacilities : bottomFacilities;

    protected override async Task OnInitializedAsync()
    {
        await DetermineAccessLevel();
        await LoadDashboardData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender && !isLoading && summary != null)
        {
            await InitializeCharts();
        }
    }

    private async Task DetermineAccessLevel()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        accessLevel = user.Claims.FirstOrDefault(c => c.Type == "AccessLevel")?.Value ?? "District";

        // Get user's region, district, and facility IDs
        var regionIdClaim = user.Claims.FirstOrDefault(c => c.Type == "RegionID")?.Value;
        var districtIdClaim = user.Claims.FirstOrDefault(c => c.Type == "DistrictID")?.Value;
        var facilityIdClaim = user.Claims.FirstOrDefault(c => c.Type == "FacilityID")?.Value;
        var regionNameClaim = user.Claims.FirstOrDefault(c => c.Type == "RegionName")?.Value;
        var districtNameClaim = user.Claims.FirstOrDefault(c => c.Type == "DistrictName")?.Value;
        var facilityNameClaim = user.Claims.FirstOrDefault(c => c.Type == "FacilityName")?.Value;

        if (Guid.TryParse(regionIdClaim, out var regionId))
            userRegionId = regionId;

        if (Guid.TryParse(districtIdClaim, out var districtId))
            userDistrictId = districtId;

        if (Guid.TryParse(facilityIdClaim, out var facilityId))
            userFacilityId = facilityId;

        accessLevelText = accessLevel switch
        {
            "National" => "National Overview",
            "Regional" => "Regional View",
            "District" => "District View",
            "Facility" => "Facility View",
            _ => "Dashboard"
        };

        locationText = accessLevel switch
        {
            "National" => "All Regions",
            "Regional" => regionNameClaim ?? "Region",
            "District" => districtNameClaim ?? "District",
            "Facility" => facilityNameClaim ?? "Facility",
            _ => ""
        };
    }

    private DashboardFilter BuildFilter()
    {
        var filter = new DashboardFilter
        {
            Period = selectedPeriod
        };

        // Apply access level restrictions
        if (accessLevel == "Regional" && userRegionId.HasValue)
        {
            filter.RegionID = userRegionId;
        }
        else if (accessLevel == "District" && userDistrictId.HasValue)
        {
            filter.DistrictID = userDistrictId;
        }
        else if (accessLevel == "Facility" && userFacilityId.HasValue)
        {
            filter.FacilityID = userFacilityId;
        }

        return filter;
    }

    private async Task LoadDashboardData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var filter = BuildFilter();

            // Load all data in parallel
            var summaryTask = DashboardService.GetDashboardSummaryAsync(filter);
            var deliveryModesTask = DashboardService.GetDeliveryModeDistributionAsync(filter);
            var alertsTask = DashboardService.GetActiveAlertsAsync(filter);
            var maternalHealthTask = DashboardService.GetMaternalHealthIndicatorsAsync(filter);
            var alertSummaryTask = DashboardService.GetAlertSummaryAsync(filter);
            var topFacilitiesTask = DashboardService.GetTopFacilitiesAsync(filter, 5);
            var bottomFacilitiesTask = DashboardService.GetBottomFacilitiesAsync(filter, 5);
            var geoPerformanceTask = DashboardService.GetGeographicPerformanceAsync(filter);
            var liveLaborTask = DashboardService.GetLiveLaborSummaryAsync(filter);

            await Task.WhenAll(
                summaryTask, deliveryModesTask, alertsTask,
                maternalHealthTask, alertSummaryTask,
                topFacilitiesTask, bottomFacilitiesTask,
                geoPerformanceTask, liveLaborTask
            );

            summary = await summaryTask;
            deliveryModes = await deliveryModesTask;
            alerts = await alertsTask;
            maternalHealth = await maternalHealthTask;
            alertSummary = await alertSummaryTask;
            topFacilities = await topFacilitiesTask;
            bottomFacilities = await bottomFacilitiesTask;
            geographicPerformance = await geoPerformanceTask;
            liveLaborSummary = await liveLaborTask;

            // Generate mock trend data if not available
            if (summary != null && !summary.DeliveryTrend.Any())
            {
                var random = new Random();
                summary.DeliveryTrend = Enumerable.Range(0, 7).Select(_ => random.Next(20, 60)).ToList();
                summary.LaborTrend = Enumerable.Range(0, 7).Select(_ => random.Next(10, 40)).ToList();
                summary.ComplicationTrend = Enumerable.Range(0, 7).Select(_ => random.Next(2, 15)).ToList();
                summary.FacilityActivityTrend = Enumerable.Range(0, 7).Select(_ => random.Next(30, 80)).ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task InitializeCharts()
    {
        try
        {
            // Initialize delivery mode chart
            if (deliveryModes != null)
            {
                await JSRuntime.InvokeVoidAsync("initializeDeliveryModeChart", new
                {
                    normalVaginal = deliveryModes.NormalVaginal,
                    assistedVaginal = deliveryModes.AssistedVaginal,
                    electiveCaesarean = deliveryModes.ElectiveCaesarean,
                    emergencyCaesarean = deliveryModes.EmergencyCaesarean
                });
            }

            // Initialize sparklines
            if (summary != null)
            {
                await JSRuntime.InvokeVoidAsync("initializeSparkline", "deliverySparkline", summary.DeliveryTrend, "#0d6efd");
                await JSRuntime.InvokeVoidAsync("initializeSparkline", "laborSparkline", summary.LaborTrend, "#ffc107");
                await JSRuntime.InvokeVoidAsync("initializeSparkline", "complicationSparkline", summary.ComplicationTrend, "#dc3545");
                await JSRuntime.InvokeVoidAsync("initializeSparkline", "facilitySparkline", summary.FacilityActivityTrend, "#198754");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing charts: {ex.Message}");
        }
    }

    private async Task RefreshData()
    {
        await LoadDashboardData();
        await InitializeCharts();
    }

    private async Task ChangePeriod(string period)
    {
        selectedPeriod = period;
        await LoadDashboardData();
        await InitializeCharts();
    }

    private void SetFacilityView(string view)
    {
        facilityView = view;
    }

    private string GetAlertClass(string severity)
    {
        return severity switch
        {
            "Critical" => "alert-critical",
            "Warning" => "alert-warning-custom",
            _ => "alert-info-custom"
        };
    }

    private string GetAlertIcon(string severity)
    {
        return severity switch
        {
            "Critical" => "bi-exclamation-octagon text-danger",
            "Warning" => "bi-exclamation-triangle text-warning",
            _ => "bi-info-circle text-info"
        };
    }

    private string GetScoreColor(double score)
    {
        return score switch
        {
            >= 80 => "bg-success",
            >= 60 => "bg-warning",
            _ => "bg-danger"
        };
    }

    private string GetGradeClass(string grade)
    {
        return grade switch
        {
            "A" => "bg-success",
            "B" => "bg-info",
            "C" => "bg-warning",
            "D" => "bg-orange text-dark",
            _ => "bg-danger"
        };
    }

    private string GetPerformanceClass(string status)
    {
        return status switch
        {
            "Good" or "Excellent" => "geo-good",
            "Warning" => "geo-warning",
            "Critical" => "geo-critical",
            _ => "geo-normal"
        };
    }

    private string GetPerformanceBadgeClass(string status)
    {
        return status switch
        {
            "Good" or "Excellent" => "badge-success",
            "Warning" => "badge-warning",
            "Critical" => "badge-danger",
            _ => "badge-secondary"
        };
    }

    private bool IsVitalCritical(int? value, string type)
    {
        if (!value.HasValue) return false;
        return type switch
        {
            "FHR" => value < 110 || value > 160,
            "BP" => value > 140,
            _ => false
        };
    }

    private string FormatDuration(TimeSpan duration)
    {
        if (duration.TotalHours >= 1)
            return $"{(int)duration.TotalHours}h {duration.Minutes}m";
        return $"{duration.Minutes}m";
    }
}
